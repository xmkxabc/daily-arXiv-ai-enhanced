<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIè®ºæ–‡æ¯æ—¥é€Ÿè§ˆ | Daily Arxiv AI Enhancer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* CSS å˜é‡ç³»ç»Ÿ - æ”¯æŒæ·±è‰²æ¨¡å¼ */
        :root {
            --bg-primary: #f8f9fa;
            --bg-secondary: #ffffff;
            --bg-tertiary: #f3f4f6;
            --text-primary: #1f2937;
            --text-secondary: #4b5563;
            --text-tertiary: #6b7280;
            --border-primary: #e5e7eb;
            --border-secondary: #d1d5db;
            --accent-primary: #3b82f6;
            --accent-secondary: #60a5fa;
            --shadow-light: rgba(0, 0, 0, 0.1);
            --shadow-dark: rgba(0, 0, 0, 0.2);
            --highlight-bg: #fef9c3;
            --highlight-text: #713f12;
        }
        
        [data-theme="dark"] {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #334155;
            --text-primary: #f1f5f9;
            --text-secondary: #cbd5e1;
            --text-tertiary: #94a3b8;
            --border-primary: #334155;
            --border-secondary: #475569;
            --accent-primary: #60a5fa;
            --accent-secondary: #3b82f6;
            --shadow-light: rgba(0, 0, 0, 0.3);
            --shadow-dark: rgba(0, 0, 0, 0.5);
            --highlight-bg: #422006;
            --highlight-text: #fbbf24;
        }
        
        /* æ–°å¢ï¼šä¸ºå¹³æ»‘æ»šåŠ¨æä¾›åŸºç¡€ */
        html { scroll-behavior: smooth; }
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: var(--bg-primary); 
            color: var(--text-primary);
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .paper-card { 
            background-color: var(--bg-secondary) !important;
            border-color: var(--border-primary) !important;
            color: var(--text-primary) !important;
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out, background-color 0.3s ease; 
        }
        .paper-card:hover { 
            transform: translateY(-5px); 
            box-shadow: 0 10px 15px -3px var(--shadow-light), 0 4px 6px -2px var(--shadow-dark); 
        }
        .loader { border-top-color: var(--accent-primary); animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .keyword-tag { 
            background-color: var(--bg-tertiary);
            color: var(--text-secondary);
            transition: background-color 0.2s ease, color 0.2s ease; 
            cursor: pointer; 
        }
        .keyword-tag:hover { background-color: var(--accent-primary); color: white; }
        .details-section h3 { font-size: 1.125rem; font-weight: 600; margin-bottom: 0.5rem; color: var(--accent-primary); }
        .details-section p { color: var(--text-secondary); line-height: 1.6; }
        .info-box { 
            border-left-width: 4px; 
            padding: 1rem; 
            margin-top: 1rem; 
            margin-bottom: 1rem; 
            border-radius: 0 0.5rem 0.5rem 0;
            background-color: var(--bg-tertiary);
            border-color: var(--border-secondary);
        }
        .info-box-title { font-weight: 600; color: var(--text-primary); }
        .ai-details-section { 
            max-height: 0; 
            opacity: 0; 
            overflow: hidden; 
            transition: max-height 0.5s ease-in-out, opacity 0.3s ease-in-out, margin-top 0.5s ease-in-out, padding-top 0.5s ease-in-out, border-top-width 0.5s ease-in-out; 
            border-top-width: 0; 
            border-top-style: solid; 
            border-color: var(--border-primary); 
        }
        .ai-details-section.expanded { 
            max-height: 2000px; 
            opacity: 1; 
            margin-top: 1rem; 
            padding-top: 1rem; 
            border-top-width: 1px; 
        }
        .quick-nav-container { 
            background-color: var(--bg-secondary); 
            -webkit-backdrop-filter: blur(8px);
            backdrop-filter: blur(8px); 
            border-bottom: 1px solid var(--border-primary);
            opacity: 0.95;
        }
        /* ä¼˜åŒ–ï¼šæ”¹è¿›å¿«é€Ÿå¯¼èˆªæ å¸ƒå±€ */
        .quick-nav .year-group { display: flex; align-items: center; flex-wrap: wrap; margin-bottom: 0.25rem; }
        .quick-nav .year-label { 
            font-weight: 700; 
            color: var(--text-primary); 
            padding: 0.5rem 0.75rem; 
            background-color: var(--bg-tertiary); 
            border-radius: 0.375rem; 
            margin-right: 0.75rem; 
        }
        .quick-nav .month-btn { 
            padding: 0.5rem 0.75rem; 
            margin: 0.25rem; 
            border-radius: 0.375rem; 
            font-weight: 500; 
            color: var(--text-secondary); 
            transition: background-color 0.2s, color 0.2s; 
            cursor: pointer; 
            border: 1px solid transparent;
        }
        .quick-nav .month-btn:hover { 
            background-color: var(--bg-tertiary); 
            color: var(--accent-primary); 
            border-color: var(--border-secondary);
        }
        .quick-nav .month-btn.active { 
            background-color: var(--accent-primary); 
            color: white; 
            font-weight: 600; 
        }
        .highlight { 
            background-color: var(--highlight-bg); 
            color: var(--highlight-text); 
            font-weight: bold; 
            padding: 1px 2px; 
            border-radius: 3px; 
        }
        /* ä¼˜åŒ–ï¼šä¸ºç›´æ¥é“¾æ¥çš„è®ºæ–‡æ·»åŠ é«˜äº®æ•ˆæœ */
        .highlight-shared-paper { 
            background-color: var(--bg-tertiary); 
            border-color: var(--accent-primary); 
            box-shadow: 0 0 0 2px var(--accent-secondary);
        }
        
        /* æ–°å¢ï¼šæ·±è‰²æ¨¡å¼åˆ‡æ¢æŒ‰é’® */
        .theme-toggle {
            background-color: var(--bg-tertiary);
            border: 1px solid var(--border-primary);
            color: var(--text-primary);
            padding: 0.5rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .theme-toggle:hover {
            background-color: var(--bg-secondary);
            border-color: var(--accent-primary);
        }
        
        /* æ–°å¢ï¼šæœç´¢å»ºè®®æ ·å¼ */
        .search-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-primary);
            border-top: none;
            border-radius: 0 0 0.5rem 0.5rem;
            box-shadow: 0 10px 15px -3px var(--shadow-light);
            max-height: 300px;
            overflow-y: auto;
            z-index: 50;
            display: none;
        }
        .search-suggestions.visible { display: block; }
        .suggestion-item {
            padding: 0.75rem 1rem;
            cursor: pointer;
            border-bottom: 1px solid var(--border-primary);
            transition: background-color 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .suggestion-item:hover, .suggestion-item.highlighted {
            background-color: var(--bg-tertiary);
        }
        .suggestion-item:last-child { border-bottom: none; }
        .suggestion-type {
            font-size: 0.75rem;
            color: var(--text-tertiary);
            background-color: var(--bg-tertiary);
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
        }
        
        /* æ–°å¢ï¼šæœç´¢å†å² */
        .search-history {
            background-color: var(--bg-tertiary);
            padding: 0.5rem;
            margin-bottom: 0.5rem;
            border-radius: 0.375rem;
        }
        .search-history-title {
            font-size: 0.75rem;
            color: var(--text-tertiary);
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .search-history-item {
            display: inline-block;
            background-color: var(--bg-secondary);
            color: var(--text-secondary);
            padding: 0.25rem 0.5rem;
            margin: 0.125rem;
            border-radius: 0.25rem;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .search-history-item:hover {
            background-color: var(--accent-primary);
            color: white;
        }
        
        /* æ–°å¢ï¼šè®ºæ–‡æ ‡ç­¾ç³»ç»Ÿ */
        .paper-tags {
            margin-top: 0.5rem;
            display: flex;
            flex-wrap: wrap;
            gap: 0.25rem;
        }
        .custom-tag {
            background-color: var(--accent-secondary);
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }
        .tag-remove {
            cursor: pointer;
            opacity: 0.7;
            transition: opacity 0.2s ease;
        }
        .tag-remove:hover { opacity: 1; }
        
        /* æ–°å¢ï¼šè®ºæ–‡ç¬”è®° */
        .paper-notes {
            background-color: var(--bg-tertiary);
            border: 1px solid var(--border-primary);
            border-radius: 0.375rem;
            padding: 0.75rem;
            margin-top: 0.5rem;
            display: none;
        }
        .paper-notes.visible { display: block; }
        .notes-textarea {
            width: 100%;
            min-height: 80px;
            padding: 0.5rem;
            border: 1px solid var(--border-primary);
            border-radius: 0.25rem;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            resize: vertical;
            font-family: inherit;
        }
        .notes-textarea:focus {
            outline: none;
            border-color: var(--accent-primary);
        }
        
        /* æ–°å¢ï¼šè¯„åˆ†ç³»ç»Ÿ */
        .paper-rating {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            margin-top: 0.5rem;
        }
        .star-rating {
            display: flex;
            gap: 0.125rem;
        }
        .star {
            cursor: pointer;
            color: var(--text-tertiary);
            transition: color 0.2s ease;
            font-size: 1.25rem;
        }
        .star:hover, .star.active {
            color: #fbbf24;
        }
        
        /* æ–°å¢ï¼šé˜…è¯»è¿›åº¦æŒ‡ç¤ºå™¨ */
        .reading-progress {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background-color: var(--bg-tertiary);
            z-index: 100;
        }
        .reading-progress-bar {
            height: 100%;
            background-color: var(--accent-primary);
            width: 0%;
            transition: width 0.1s ease;
        }
        .back-to-top-btn { 
            position: fixed; 
            bottom: 2rem; 
            right: 2rem; 
            background-color: var(--accent-primary); 
            color: white; 
            width: 3rem; 
            height: 3rem; 
            border-radius: 50%; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            cursor: pointer; 
            opacity: 0; 
            transform: translateY(100px); 
            transition: opacity 0.3s ease, transform 0.3s ease, background-color 0.2s ease; 
            z-index: 50; 
            box-shadow: 0 4px 6px var(--shadow-light);
            border: none;
            outline: none;
        }
        .back-to-top-btn.visible { opacity: 0.8; transform: translateY(0); }
        .back-to-top-btn:hover { opacity: 1; background-color: var(--accent-secondary); }
        .back-to-top-btn:focus {
            outline: 2px solid var(--accent-primary);
            outline-offset: 2px;
        }
        
        .skeleton-card { 
            background-color: var(--bg-secondary); 
            padding: 1.5rem; 
            border-radius: 0.5rem; 
            box-shadow: 0 4px 6px -1px var(--shadow-light), 0 2px 4px -2px var(--shadow-dark); 
            border: 1px solid var(--border-primary); 
        }
        .skeleton { background-color: var(--border-primary); border-radius: 0.25rem; } 
        .skeleton.h-4 { height: 1rem; }
        .skeleton.w-1\/4 { width: 25%; } 
        .skeleton.w-1\/2 { width: 50%; } 
        .skeleton.w-3\/4 { width: 75%; } 
        .skeleton.w-full { width: 100%; }
        @keyframes pulse { 50% { opacity: .5; } } 
        .skeleton-animate { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        
        .favorite-btn { 
            color: var(--text-tertiary); 
            transition: color 0.2s, transform 0.2s; 
            border: none;
            background: none;
            cursor: pointer;
            padding: 0.25rem;
            border-radius: 0.25rem;
        }
        .favorite-btn:hover { color: #facc15; transform: scale(1.1); } 
        .favorite-btn.favorited { color: #f59e0b; }
        .favorite-btn:focus {
            outline: 2px solid var(--accent-primary);
            outline-offset: 2px;
        }

        /* --- æœ€ç»ˆUI/UXæ‰“ç£¨ --- */
        header { padding-bottom: 1rem; }
        .view-toggle { 
            display: flex; 
            align-items: center; 
            background-color: var(--bg-tertiary); 
            border-radius: 9999px; 
            padding: 2px; 
            cursor: pointer; 
        }
        .view-toggle button { 
            padding: 0.25rem 0.75rem; 
            border-radius: 9999px; 
            font-size: 0.875rem; 
            font-weight: 500; 
            color: var(--text-secondary); 
            transition: all 0.2s ease; 
            border: none; 
            background-color: transparent; 
            cursor: pointer;
        }
        .view-toggle button.active { 
            background-color: var(--bg-secondary); 
            color: var(--accent-primary); 
            box-shadow: 0 1px 3px var(--shadow-light); 
        }
        .view-toggle button:focus {
            outline: 2px solid var(--accent-primary);
            outline-offset: 2px;
        }
        
        .compact-view .compact-hidden { display: none; }
        .compact-view .paper-card { padding: 1rem; }
        .compact-view .paper-card h2 { font-size: 1.125rem; }
        .compact-view .paper-card h3 { font-size: 1rem; margin-bottom: 0.5rem;}
        
        /* æ–°å¢ï¼šåˆ†äº«æŒ‰é’®æ ·å¼ */
        .share-btn { 
            color: var(--text-tertiary); 
            transition: color 0.2s, transform 0.2s; 
            border: none;
            background: none;
            cursor: pointer;
            padding: 0.25rem;
            border-radius: 0.25rem;
        }
        .share-btn:hover { color: var(--accent-primary); transform: scale(1.1); }
        .share-btn:focus {
            outline: 2px solid var(--accent-primary);
            outline-offset: 2px;
        }
        
        /* æ–°å¢ï¼šToasté€šçŸ¥æ ·å¼ */
        .toast { 
            position: fixed; 
            top: -100px; 
            left: 50%; 
            transform: translateX(-50%); 
            background-color: #22c55e; 
            color: white; 
            padding: 1rem 2rem; 
            border-radius: 0.5rem; 
            box-shadow: 0 4px 15px var(--shadow-dark); 
            transition: top 0.5s ease-in-out; 
            z-index: 100; 
        }
        .toast.show { top: 2rem; }
        .toast.error { background-color: #ef4444; }
        .toast.warning { background-color: #f59e0b; }
        
        /* æ–°å¢ï¼šåˆ†ç±»ç­›é€‰å™¨æ ·å¼ */
        .category-filter-btn { 
            padding: 0.5rem 1rem; 
            border: 1px solid var(--border-secondary); 
            border-radius: 9999px; 
            font-size: 0.875rem; 
            font-weight: 500; 
            color: var(--text-secondary); 
            cursor: pointer; 
            transition: all 0.2s ease;
            background-color: var(--bg-secondary);
        }
        .category-filter-btn:hover { 
            background-color: var(--bg-tertiary); 
            border-color: var(--text-tertiary); 
        }
        .category-filter-btn.active { 
            background-color: var(--accent-primary); 
            color: white; 
            border-color: var(--accent-primary); 
        }
        .category-filter-btn:focus {
            outline: 2px solid var(--accent-primary);
            outline-offset: 2px;
        }
        
        /* æ–°å¢ï¼šæ—¥æœŸç­›é€‰å™¨æ ·å¼ */
        .month-header { 
            font-size: 1.75rem; 
            font-weight: 700; 
            color: var(--text-primary); 
            padding: 2rem 0 1rem 0; 
            border-top: 1px solid var(--border-secondary); 
            margin-top: 2rem; 
        }
        .date-filter-btn { 
            padding: 0.375rem 0.75rem; 
            border: 1px solid var(--border-secondary); 
            border-radius: 0.375rem; 
            font-size: 0.875rem; 
            font-weight: 500; 
            color: var(--text-secondary); 
            cursor: pointer; 
            transition: all 0.2s ease;
            background-color: var(--bg-secondary);
        }
        .date-filter-btn:hover { 
            background-color: var(--bg-tertiary); 
            border-color: var(--text-tertiary); 
        }
        .date-filter-btn.active { 
            background-color: var(--accent-secondary); 
            color: white; 
            border-color: var(--accent-secondary); 
        }
        .date-filter-btn:focus {
            outline: 2px solid var(--accent-primary);
            outline-offset: 2px;
        }
        
        /* ä¼˜åŒ–ï¼šé¡¶éƒ¨åŠ è½½è¿›åº¦æ¡æ ·å¼ */
        #progress-container { 
            position: fixed; 
            top: 0; 
            left: 0; 
            right: 0; 
            height: auto; 
            z-index: 101; 
            opacity: 0; 
            transform: translateY(-100%); 
            transition: opacity 0.3s, transform 0.3s; 
        }
        #progress-container.visible { opacity: 1; transform: translateY(0); }
        #top-loader { 
            width: 100%; 
            height: 4px; 
            background-color: var(--bg-tertiary); 
        }
        #top-loader-bar { 
            width: 0%; 
            height: 100%; 
            background-color: var(--accent-primary); 
            transition: width 0.3s ease; 
        }
        #progress-text { 
            background-color: rgba(0, 0, 0, 0.6); 
            color: white; 
            font-size: 0.875rem; 
            padding: 0.25rem 0.75rem; 
            border-radius: 0 0 0.375rem 0; 
        }
        
        /* æ–°å¢ï¼šä¿¡æ¯æ¡†é¢œè‰²ç±» */
        .info-box-yellow { background-color: #fefce8; border-color: #facc15; }
        .info-box-yellow .info-box-title { color: #a16207; }
        .info-box-yellow p { color: #a16207; }
        
        .info-box-green { background-color: #f0fdf4; border-color: #22c55e; }
        .info-box-green .info-box-title { color: #15803d; }
        .info-box-green p { color: #15803d; }
        
        .info-box-indigo { background-color: #eef2ff; border-color: #6366f1; }
        .info-box-indigo .info-box-title { color: #4338ca; }
        .info-box-indigo p { color: #4338ca; }
        
        [data-theme="dark"] .info-box-yellow { background-color: #422006; border-color: #ca8a04; }
        [data-theme="dark"] .info-box-yellow .info-box-title { color: #fbbf24; }
        [data-theme="dark"] .info-box-yellow p { color: #fde047; }
        
        [data-theme="dark"] .info-box-green { background-color: #052e16; border-color: #059669; }
        [data-theme="dark"] .info-box-green .info-box-title { color: #34d399; }
        [data-theme="dark"] .info-box-green p { color: #6ee7b7; }
        
        [data-theme="dark"] .info-box-indigo { background-color: #1e1b4b; border-color: #8b5cf6; }
        [data-theme="dark"] .info-box-indigo .info-box-title { color: #a78bfa; }
        [data-theme="dark"] .info-box-indigo p { color: #c4b5fd; }
        
        /* æ–°å¢ï¼šé”®ç›˜å¯¼èˆªé«˜äº® */
        .focus-visible {
            outline: 2px solid var(--accent-primary);
            outline-offset: 2px;
        }
        
        /* æ–°å¢ï¼šæœç´¢æ å®¹å™¨ä¿®å¤å†…è”æ ·å¼é—®é¢˜ */
        .search-bar-container {
            position: sticky;
            z-index: 10;
            margin-bottom: 2rem;
            top: var(--nav-height, 8px);
        }
        
        /* ä¿®å¤ï¼šæ›´æ–°å¡ç‰‡é¢œè‰² */
        .paper-card {
            background-color: var(--bg-secondary) !important;
            border-color: var(--border-primary) !important;
            color: var(--text-primary) !important;
        }
        
        /* ä¿®å¤ï¼šæœç´¢è¾“å…¥æ¡†æ ·å¼ */
        #searchInput {
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            border-color: var(--border-primary);
        }
        
        #searchInput:focus {
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        /* ä¿®å¤ï¼šæŒ‰é’®æ ·å¼ */
        .paper-card button {
            background-color: transparent;
            border: none;
        }
        
        .paper-card a {
            color: inherit;
        }
        
        [data-theme="dark"] .paper-card a:hover {
            color: var(--accent-primary);
        }
    </style>
</head>
<body class="text-gray-800" data-theme="light">

<!-- æ–°å¢ï¼šé˜…è¯»è¿›åº¦æŒ‡ç¤ºå™¨ -->
<div class="reading-progress">
    <div class="reading-progress-bar" id="reading-progress-bar"></div>
</div>

<!-- æ–°å¢ï¼šå¸¦æ–‡æœ¬çš„é¡¶éƒ¨åŠ è½½è¿›åº¦æ¡ -->
<div id="progress-container">
    <div class="flex justify-end"><span id="progress-text"></span></div>
    <div id="top-loader"><div id="top-loader-bar"></div></div>
</div>

<div class="container mx-auto px-4 py-8">
    
    <header class="text-center mb-4">
        <div class="flex justify-between items-center mb-4">
            <div></div>
            <h1 class="text-4xl font-bold text-gray-900">AIè®ºæ–‡æ¯æ—¥é€Ÿè§ˆ</h1>
            <button id="theme-toggle" class="theme-toggle" aria-label="åˆ‡æ¢ä¸»é¢˜æ¨¡å¼" title="åˆ‡æ¢æ·±è‰²/æµ…è‰²æ¨¡å¼">
                <svg id="theme-icon-light" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" clip-rule="evenodd" />
                </svg>
                <svg id="theme-icon-dark" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 hidden" viewBox="0 0 20 20" fill="currentColor">
                    <path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z" />
                </svg>
            </button>
        </div>
        <p id="last-updated" class="text-sm text-gray-500 mt-2"></p>
    </header>

    <!-- ä¼˜åŒ–ï¼šæ”¹è¿›å¿«é€Ÿå¯¼èˆªæ HTMLç»“æ„ä»¥è·å¾—æ›´å¥½çš„å“åº”å¼æ•ˆæœ -->
    <div id="quick-nav-container" class="sticky top-0 z-20 py-2 mb-8 quick-nav-container">
        <nav id="quick-nav" class="quick-nav px-4 flex justify-between items-center flex-wrap gap-y-2">
            <!-- æœˆä»½å¯¼èˆªï¼ˆå·¦ä¾§ï¼Œå¯ä¼¸å±•ï¼‰ -->
            <div id="month-nav-wrapper" class="flex-grow"></div>
            <!-- å·¥å…·æ ï¼ˆå³ä¾§ï¼Œå›ºå®šå®½åº¦ï¼‰ -->
            <div class="flex items-center gap-4 flex-shrink-0">
                <div class="view-toggle">
                    <button id="view-detailed-btn">è¯¦ç»†</button>
                    <button id="view-compact-btn">ç´§å‡‘</button>
                </div>
                <div>
                    <button id="show-favorites-btn" class="flex items-center space-x-2 px-3 py-2 bg-yellow-400 text-white font-semibold rounded-lg hover:bg-yellow-500 transition shadow">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" /></svg>
                        <span>æˆ‘çš„æ”¶è—</span><span id="favorites-count" class="ml-1 bg-white text-yellow-500 text-xs font-bold rounded-full px-1.5 py-0.5"></span>
                    </button>
                </div>
            </div>
        </nav>
    </div>

    <div id="search-bar-container" class="search-bar-container">
        <div class="relative">
            <!-- æœç´¢å†å²æŒ‰é’® -->
            <div class="flex items-center gap-2 mb-2">
                <button id="search-history-toggle" class="text-sm text-gray-600 hover:text-gray-800 font-medium">
                    æœç´¢å†å²
                </button>
            </div>
            
            <!-- æ–°å¢ï¼šæœç´¢å†å²é¢æ¿ -->
            <div id="search-history-panel" class="search-history hidden">
                <div class="search-history-title">
                    <span>æœç´¢å†å²</span>
                    <button id="clear-history" class="text-xs text-red-600 hover:text-red-800">æ¸…é™¤å†å²</button>
                </div>
                <div id="search-history-items"></div>
            </div>
            
            <input type="text" id="searchInput" placeholder="æœç´¢è®ºæ–‡æˆ–ç‚¹å‡»åˆ†ç±»/å…³é”®è¯è¿›è¡Œç­›é€‰..." 
                   class="w-full p-4 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition"
                   autocomplete="off">
                   
            <!-- æ–°å¢ï¼šæœç´¢å»ºè®®ä¸‹æ‹‰æ¡† -->
            <div id="search-suggestions" class="search-suggestions">
                <!-- åŠ¨æ€å¡«å……æœç´¢å»ºè®® -->
            </div>
        </div>
    </div>

    <!-- æ–°å¢ï¼šåˆ†ç±»ç­›é€‰å™¨å®¹å™¨ -->
    <div id="category-filter-container" class="mb-8 hidden">
        <div id="category-filters" class="flex flex-wrap items-center gap-2"></div>
    </div>
    
    <main id="main-content">
        <div id="search-info" class="mb-4 text-lg text-gray-700 hidden"></div>
        <div id="papers-container"></div>
        <div id="search-results-container" class="space-y-8 hidden"></div>
        <div id="skeleton-container" class="space-y-8 hidden"></div>
    </main>

    <div id="loader" class="flex justify-center items-center py-8 hidden">
        <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12"></div>
    </div>

    <div id="end-of-list-message" class="text-center py-8 text-gray-500 hidden">
        <p>å·²åŠ è½½å…¨éƒ¨å†…å®¹</p>
    </div>
</div>

<!-- æ–°å¢ï¼šå¯è®¿é—®æ€§ä¼˜åŒ– -->
<button id="back-to-top" class="back-to-top-btn" aria-label="è¿”å›é¡¶éƒ¨" title="è¿”å›é¡µé¢é¡¶éƒ¨">
    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7" /></svg>
</button>

<!-- æ–°å¢ï¼šåˆ†äº«æ“ä½œçš„Toasté€šçŸ¥ -->
<div id="toast-notification" class="toast" role="alert"></div>

<script>
    // --- å…¨å±€çŠ¶æ€ç®¡ç† ---
    const state = {
        manifest: null, searchIndex: null, categoryIndex: null, allPapers: new Map(),
        loadedMonths: new Set(), currentMonthIndex: -1, isFetching: false, isSearchMode: false,
        navObserver: null, currentQuery: '', favorites: new Set(), viewMode: 'detailed',
        mainCategories: ['cs.CV', 'cs.LG', 'cs.CL', 'cs.AI', 'cs.RO', 'stat.ML'],
        currentSearchResults: [], 
        activeCategoryFilter: 'all',
        activeDateFilters: new Map(),
        // æ–°å¢çŠ¶æ€
        theme: 'light',
        searchHistory: [],
        searchSuggestions: [],
        searchHistoryVisible: false,
        currentSuggestionIndex: -1,
        paperTags: new Map(), // ç”¨æˆ·è‡ªå®šä¹‰æ ‡ç­¾ paperID -> [tags]
        paperNotes: new Map(), // è®ºæ–‡ç¬”è®° paperID -> note
        paperRatings: new Map(), // è®ºæ–‡è¯„åˆ† paperID -> rating(1-5)
        favoriteGroups: new Map(), // æ”¶è—å¤¹åˆ†ç»„ groupName -> Set<paperID>
        keyboardNavigation: {
            enabled: true,
            currentFocusIndex: -1,
            focusableElements: []
        }
    };

    // --- DOM å…ƒç´ å¼•ç”¨ ---
    const mainContainer = document.getElementById('main-content');
    const papersContainer = document.getElementById('papers-container');
    const searchResultsContainer = document.getElementById('search-results-container');
    const skeletonContainer = document.getElementById('skeleton-container');
    const searchInput = document.getElementById('searchInput');
    const loader = document.getElementById('loader');
    const endOfListMessage = document.getElementById('end-of-list-message');
    const quickNavContainer = document.getElementById('quick-nav-container');
    const searchBarContainer = document.getElementById('search-bar-container');
    const backToTopBtn = document.getElementById('back-to-top');
    const lastUpdatedEl = document.getElementById('last-updated');
    const searchInfoEl = document.getElementById('search-info');
    const toastNotificationEl = document.getElementById('toast-notification');
    const categoryFilterContainer = document.getElementById('category-filter-container');
    const categoryFiltersEl = document.getElementById('category-filters');
    const progressContainer = document.getElementById('progress-container');
    const topLoaderBar = document.getElementById('top-loader-bar');
    const progressText = document.getElementById('progress-text');
    // æ–°å¢å…ƒç´ å¼•ç”¨
    const themeToggle = document.getElementById('theme-toggle');
    const themeIconLight = document.getElementById('theme-icon-light');
    const themeIconDark = document.getElementById('theme-icon-dark');
    const searchHistoryToggle = document.getElementById('search-history-toggle');
    const searchHistoryPanel = document.getElementById('search-history-panel');
    const searchSuggestions = document.getElementById('search-suggestions');
    const searchHistoryItems = document.getElementById('search-history-items');
    const readingProgressBar = document.getElementById('reading-progress-bar');

    // --- æ€§èƒ½ç›‘æ§å’Œå†…å­˜ç®¡ç† ---
    const performance = {
        startTime: 0,
        loadTimes: new Map(),
        memoryUsage: 0,
        
        startTracking(operation) {
            this.startTime = Date.now();
            console.log(`â±ï¸ Started: ${operation}`);
        },
        
        endTracking(operation) {
            const duration = Date.now() - this.startTime;
            this.loadTimes.set(operation, duration);
            console.log(`âœ… Completed: ${operation} in ${duration}ms`);
            
            // æ£€æŸ¥å†…å­˜ä½¿ç”¨æƒ…å†µ
            if (window.performance && window.performance.memory) {
                this.memoryUsage = window.performance.memory.usedJSHeapSize / 1024 / 1024;
                console.log(`ğŸ§  Memory usage: ${this.memoryUsage.toFixed(1)}MB`);
                
                // å¦‚æœå†…å­˜ä½¿ç”¨è¶…è¿‡ 200MBï¼Œå»ºè®®ç”¨æˆ·åˆ·æ–°é¡µé¢
                if (this.memoryUsage > 200) {
                    showToast('å†…å­˜ä½¿ç”¨è¿‡é«˜ï¼Œå»ºè®®åˆ·æ–°é¡µé¢ä»¥è·å¾—æ›´å¥½æ€§èƒ½', 'warning');
                }
            }
        },
        
        cleanup() {
            // æ¸…ç†ä¸å¯è§çš„è®ºæ–‡å¡ç‰‡ä»¥é‡Šæ”¾å†…å­˜
            const cards = document.querySelectorAll('.paper-card');
            const viewportHeight = window.innerHeight;
            let cleanedCount = 0;
            
            cards.forEach(card => {
                const rect = card.getBoundingClientRect();
                // å¦‚æœå¡ç‰‡åœ¨è§†å£å¤–å¾ˆè¿œï¼ˆè¶…è¿‡3ä¸ªå±å¹•é«˜åº¦ï¼‰ï¼Œåˆ™æ¸…ç†å…¶è¯¦ç»†å†…å®¹
                if (rect.bottom < -viewportHeight * 3 || rect.top > viewportHeight * 4) {
                    const paperId = card.id.replace('card-', '');
                    const detailsSection = card.querySelector('.ai-details-section');
                    if (detailsSection && detailsSection.innerHTML.length > 1000) {
                        detailsSection.innerHTML = '<p class="text-gray-500">å†…å®¹å·²ç¼“å­˜ä»¥èŠ‚çœå†…å­˜</p>';
                        cleanedCount++;
                    }
                }
            });
            
            if (cleanedCount > 0) {
                console.log(`ğŸ§¹ Cleaned up ${cleanedCount} cards to save memory`);
            }
        }
    };

    // æ¯30ç§’æ‰§è¡Œä¸€æ¬¡å†…å­˜æ¸…ç†
    setInterval(() => {
        if (!state.isFetching) {
            performance.cleanup();
        }
    }, 30000);

    // --- å·¥å…·å‡½æ•° ---
    function escapeCQ(str) { return str ? String(str).replace(/'/g, "\\'") : ''; }
    function escapeRegex(string) { return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); }
    async function applyViewTransition(updateFunction, vtName = '') {
        if (!document.startViewTransition) {
            await updateFunction();
            return;
        }
        mainContainer.dataset.vtName = vtName;
        const transition = document.startViewTransition(updateFunction);
        try { await transition.finished; } 
        finally { delete mainContainer.dataset.vtName; }
    }
    function updateProgress(text, percentage) {
        progressText.textContent = text;
        topLoaderBar.style.width = `${percentage}%`;
    }
    function showProgress(text) {
        updateProgress(text, 0);
        progressContainer.classList.add('visible');
    }
    function hideProgress() {
        updateProgress('', 100);
        setTimeout(() => {
            progressContainer.classList.remove('visible');
            updateProgress('', 0);
        }, 300);
    }
    
    // --- æ·±è‰²æ¨¡å¼åŠŸèƒ½ ---
    function initializeTheme() {
        const savedTheme = localStorage.getItem('arxiv_theme') || 
            (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
        setTheme(savedTheme);
    }
    
    function setTheme(theme) {
        state.theme = theme;
        document.body.setAttribute('data-theme', theme);
        localStorage.setItem('arxiv_theme', theme);
        updateThemeIcons();
    }
    
    function toggleTheme() {
        const newTheme = state.theme === 'light' ? 'dark' : 'light';
        setTheme(newTheme);
        showToast(`å·²åˆ‡æ¢åˆ°${newTheme === 'dark' ? 'æ·±è‰²' : 'æµ…è‰²'}æ¨¡å¼`);
    }
    
    function updateThemeIcons() {
        if (state.theme === 'dark') {
            themeIconLight.classList.add('hidden');
            themeIconDark.classList.remove('hidden');
        } else {
            themeIconLight.classList.remove('hidden');
            themeIconDark.classList.add('hidden');
        }
    }
    
    // --- æœç´¢å»ºè®®åŠŸèƒ½ ---
    function initializeSearchSuggestions() {
        // åŸºç¡€æœç´¢å»ºè®®æ•°æ®
        state.searchSuggestions = [
            ...state.mainCategories.map(cat => ({
                text: cat,
                type: 'åˆ†ç±»',
                category: 'category'
            })),
            { text: 'transformer', type: 'å…³é”®è¯', category: 'keyword' },
            { text: 'neural network', type: 'å…³é”®è¯', category: 'keyword' },
            { text: 'deep learning', type: 'å…³é”®è¯', category: 'keyword' },
            { text: 'computer vision', type: 'å…³é”®è¯', category: 'keyword' },
            { text: 'natural language processing', type: 'å…³é”®è¯', category: 'keyword' },
            { text: 'reinforcement learning', type: 'å…³é”®è¯', category: 'keyword' },
            { text: 'generative adversarial network', type: 'å…³é”®è¯', category: 'keyword' },
            { text: 'attention mechanism', type: 'å…³é”®è¯', category: 'keyword' },
            { text: 'machine learning', type: 'å…³é”®è¯', category: 'keyword' },
            { text: 'artificial intelligence', type: 'å…³é”®è¯', category: 'keyword' }
        ];
    }
    
    function showSearchSuggestions(query) {
        if (!query.trim()) {
            hideSearchSuggestions();
            return;
        }
        
        const filtered = state.searchSuggestions
            .filter(suggestion => 
                suggestion.text.toLowerCase().includes(query.toLowerCase())
            )
            .slice(0, 8);
            
        // æ·»åŠ æœç´¢å†å²åŒ¹é…é¡¹
        const historyMatches = state.searchHistory
            .filter(item => 
                item.toLowerCase().includes(query.toLowerCase()) && 
                !filtered.some(f => f.text === item)
            )
            .slice(0, 3)
            .map(item => ({
                text: item,
                type: 'å†å²',
                category: 'history'
            }));
            
        const allSuggestions = [...historyMatches, ...filtered];
        
        if (allSuggestions.length === 0) {
            hideSearchSuggestions();
            return;
        }
        
        let html = '';
        allSuggestions.forEach((suggestion, index) => {
            html += `
                <div class="suggestion-item ${index === state.currentSuggestionIndex ? 'highlighted' : ''}" 
                     data-suggestion="${escapeCQ(suggestion.text)}" 
                     data-index="${index}">
                    <span>${suggestion.text}</span>
                    <span class="suggestion-type">${suggestion.type}</span>
                </div>
            `;
        });
        
        searchSuggestions.innerHTML = html;
        searchSuggestions.classList.add('visible');
    }
    
    function hideSearchSuggestions() {
        searchSuggestions.classList.remove('visible');
        state.currentSuggestionIndex = -1;
    }
    
    function selectSuggestion(suggestion) {
        searchInput.value = suggestion;
        hideSearchSuggestions();
        addToSearchHistory(suggestion);
        handleSearch();
    }
    
    // --- æœç´¢å†å²åŠŸèƒ½ ---
    function loadSearchHistory() {
        const history = localStorage.getItem('arxiv_search_history');
        if (history) {
            try {
                state.searchHistory = JSON.parse(history);
            } catch (e) {
                console.warn('Failed to load search history:', e);
                state.searchHistory = [];
            }
        }
    }
    
    function saveSearchHistory() {
        localStorage.setItem('arxiv_search_history', JSON.stringify(state.searchHistory));
    }
    
    function addToSearchHistory(query) {
        if (!query.trim() || query === 'favorites') return;
        
        // ç§»é™¤é‡å¤é¡¹
        state.searchHistory = state.searchHistory.filter(item => item !== query);
        // æ·»åŠ åˆ°å¼€å¤´
        state.searchHistory.unshift(query);
        // é™åˆ¶æ•°é‡
        state.searchHistory = state.searchHistory.slice(0, 10);
        saveSearchHistory();
        updateSearchHistoryDisplay();
    }
    
    function updateSearchHistoryDisplay() {
        if (state.searchHistory.length === 0) {
            searchHistoryItems.innerHTML = '<p class="text-sm text-gray-500">æš‚æ— æœç´¢å†å²</p>';
            return;
        }
        
        let html = '';
        state.searchHistory.forEach(item => {
            html += `<span class="search-history-item" data-query="${escapeCQ(item)}">${item}</span>`;
        });
        searchHistoryItems.innerHTML = html;
    }
    
    function clearSearchHistory() {
        state.searchHistory = [];
        saveSearchHistory();
        updateSearchHistoryDisplay();
        showToast('æœç´¢å†å²å·²æ¸…é™¤');
    }
    
    // --- é˜…è¯»è¿›åº¦åŠŸèƒ½ ---
    function updateReadingProgress() {
        const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
        const scrollHeight = document.documentElement.scrollHeight - document.documentElement.clientHeight;
        const progress = (scrollTop / scrollHeight) * 100;
        readingProgressBar.style.width = `${Math.min(progress, 100)}%`;
    }

    // --- æ ¸å¿ƒåŠŸèƒ½ ---
    async function init() {
        showProgress('æ­£åœ¨åˆå§‹åŒ–...');
        try {
            // åŠ è½½æ‰€æœ‰è®¾ç½®
            loadFavorites();
            loadViewMode();
            loadSearchHistory();
            loadPaperTags();
            loadPaperNotes();
            loadPaperRatings();
            initializeTheme();
            initializeSearchSuggestions();
            
            const response = await fetch('./data/index.json');
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            state.manifest = await response.json();
            
            if (state.manifest.availableMonths && state.manifest.availableMonths.length > 0) {
                setupUI();
                setupGlobalEventListeners();
                
                const urlParams = new URLSearchParams(window.location.search);
                const queryFromUrl = urlParams.get('q');
                const paperFromUrl = urlParams.get('paper');

                if (paperFromUrl) {
                    await handleDirectLink(paperFromUrl);
                } else if (queryFromUrl) {
                    searchInput.value = queryFromUrl;
                    await handleSearch();
                } else {
                    await loadNextMonth(false); 
                }
            } else {
                 papersContainer.innerHTML = `<p class="text-center text-gray-500">æ•°æ®æ¸…å•ä¸ºç©ºã€‚</p>`;
            }
        } catch (error) {
            console.error("Initialization failed:", error);
            papersContainer.innerHTML = `<p class="text-center text-red-500">åŠ è½½æ•°æ®å¤±è´¥ã€‚è¯·ç¡®ä¿æ‚¨åœ¨é¡¹ç›®çš„ 'docs' ç›®å½•ä¸‹å¯åŠ¨äº†æœ¬åœ°æœåŠ¡å™¨ã€‚</p>`;
        } finally {
            hideProgress();
        }
    }
    
    function setupUI() {
        setupQuickNav();
        setupCategoryFilters();
        updateSearchStickiness();
        setupNavObserver();
        setupBackToTopButton();
        setupIntersectionObserver();
        updateSearchHistoryDisplay();
        if(state.manifest.lastUpdated) lastUpdatedEl.textContent = `æ•°æ®æ›´æ–°äº: ${state.manifest.lastUpdated}`;
        document.getElementById('favorites-count').textContent = state.favorites.size;
    }
    
    // --- è®ºæ–‡æ ‡ç­¾ã€ç¬”è®°ã€è¯„åˆ†åŠŸèƒ½ ---
    function loadPaperTags() {
        const tags = localStorage.getItem('arxiv_paper_tags');
        if (tags) {
            try {
                const parsed = JSON.parse(tags);
                state.paperTags = new Map(Object.entries(parsed));
            } catch (e) {
                console.warn('Failed to load paper tags:', e);
                state.paperTags = new Map();
            }
        }
    }
    
    function savePaperTags() {
        const obj = Object.fromEntries(state.paperTags);
        localStorage.setItem('arxiv_paper_tags', JSON.stringify(obj));
    }
    
    function loadPaperNotes() {
        const notes = localStorage.getItem('arxiv_paper_notes');
        if (notes) {
            try {
                const parsed = JSON.parse(notes);
                state.paperNotes = new Map(Object.entries(parsed));
            } catch (e) {
                console.warn('Failed to load paper notes:', e);
                state.paperNotes = new Map();
            }
        }
    }
    
    function savePaperNotes() {
        const obj = Object.fromEntries(state.paperNotes);
        localStorage.setItem('arxiv_paper_notes', JSON.stringify(obj));
    }
    
    function loadPaperRatings() {
        const ratings = localStorage.getItem('arxiv_paper_ratings');
        if (ratings) {
            try {
                const parsed = JSON.parse(ratings);
                state.paperRatings = new Map(Object.entries(parsed));
            } catch (e) {
                console.warn('Failed to load paper ratings:', e);
                state.paperRatings = new Map();
            }
        }
    }
    
    function savePaperRatings() {
        const obj = Object.fromEntries(state.paperRatings);
        localStorage.setItem('arxiv_paper_ratings', JSON.stringify(obj));
    }
    
    function addPaperTag(paperId, tag) {
        if (!tag.trim()) return;
        
        const currentTags = state.paperTags.get(paperId) || [];
        if (!currentTags.includes(tag)) {
            currentTags.push(tag);
            state.paperTags.set(paperId, currentTags);
            savePaperTags();
            updatePaperTagsDisplay(paperId);
        }
    }
    
    function removePaperTag(paperId, tag) {
        const currentTags = state.paperTags.get(paperId) || [];
        const updated = currentTags.filter(t => t !== tag);
        
        if (updated.length === 0) {
            state.paperTags.delete(paperId);
        } else {
            state.paperTags.set(paperId, updated);
        }
        savePaperTags();
        updatePaperTagsDisplay(paperId);
    }
    
    function updatePaperTagsDisplay(paperId) {
        const container = document.getElementById(`paper-tags-${paperId}`);
        if (!container) return;
        
        const tags = state.paperTags.get(paperId) || [];
        let html = '';
        
        tags.forEach(tag => {
            html += `
                <span class="custom-tag">
                    ${tag}
                    <span class="tag-remove" data-action="remove-tag" data-paper-id="${paperId}" data-tag="${escapeCQ(tag)}">Ã—</span>
                </span>
            `;
        });
        
        // æ·»åŠ æ–°æ ‡ç­¾è¾“å…¥
        html += `
            <input type="text" 
                   id="tag-input-${paperId}" 
                   class="inline-block text-xs px-2 py-1 border border-gray-300 rounded" 
                   placeholder="æ·»åŠ æ ‡ç­¾..." 
                   style="width: 80px; font-size: 0.75rem;"
                   data-paper-id="${paperId}">
        `;
        
        container.innerHTML = html;
        
        // è®¾ç½®æ ‡ç­¾è¾“å…¥äº‹ä»¶
        const tagInput = document.getElementById(`tag-input-${paperId}`);
        if (tagInput) {
            tagInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    const tag = e.target.value.trim();
                    if (tag) {
                        addPaperTag(paperId, tag);
                        e.target.value = '';
                    }
                }
            });
        }
    }
    
    function setPaperRating(paperId, rating) {
        state.paperRatings.set(paperId, rating);
        savePaperRatings();
        updatePaperRatingDisplay(paperId);
    }
    
    function updatePaperRatingDisplay(paperId) {
        const container = document.getElementById(`paper-rating-${paperId}`);
        if (!container) return;
        
        const currentRating = state.paperRatings.get(paperId) || 0;
        let html = '<span class="text-sm text-gray-600 mr-2">è¯„åˆ†:</span>';
        
        for (let i = 1; i <= 5; i++) {
            html += `
                <span class="star ${i <= currentRating ? 'active' : ''}" 
                      data-action="rate-paper" 
                      data-paper-id="${paperId}" 
                      data-rating="${i}">â˜…</span>
            `;
        }
        
        container.innerHTML = html;
    }
    
    function savePaperNote(paperId, note) {
        if (note.trim()) {
            state.paperNotes.set(paperId, note.trim());
        } else {
            state.paperNotes.delete(paperId);
        }
        savePaperNotes();
    }
    
    function togglePaperNotes(paperId) {
        const notesContainer = document.getElementById(`paper-notes-${paperId}`);
        if (!notesContainer) return;
        
        notesContainer.classList.toggle('visible');
        
        if (notesContainer.classList.contains('visible')) {
            const textarea = notesContainer.querySelector('textarea');
            if (textarea) {
                textarea.focus();
                textarea.value = state.paperNotes.get(paperId) || '';
            }
        }
    }

    // --- UI/UX åŠŸèƒ½ ---
    function setupQuickNav() {
        const monthsByYear = state.manifest.availableMonths.reduce((acc, month) => {
            const year = month.substring(0, 4);
            if (!acc[year]) acc[year] = [];
            acc[year].push(month);
            return acc;
        }, {});
        let navHTML = '';
        const sortedYears = Object.keys(monthsByYear).sort((a, b) => b - a);
        sortedYears.forEach(year => {
            navHTML += `<div class="year-group"><span class="year-label">${year}</span>`;
            monthsByYear[year].forEach(month => {
                const monthLabel = month.substring(5, 7);
                navHTML += `<button class="month-btn" data-action="navigate-month" data-month="${month}">${monthLabel}æœˆ</button>`;
            });
            navHTML += `</div>`;
        });
        document.getElementById('month-nav-wrapper').innerHTML = navHTML;
        
        document.getElementById('view-detailed-btn').dataset.action = 'toggle-view';
        document.getElementById('view-detailed-btn').dataset.mode = 'detailed';
        document.getElementById('view-compact-btn').dataset.action = 'toggle-view';
        document.getElementById('view-compact-btn').dataset.mode = 'compact';
        document.getElementById('show-favorites-btn').dataset.action = 'search-tag';
        document.getElementById('show-favorites-btn').dataset.tagValue = 'favorites';
        updateViewModeUI();
    }
    
    function setupCategoryFilters() {
        let buttonsHTML = `<button class="category-filter-btn active" data-action="filter-category" data-category="all">å…¨éƒ¨</button>`;
        state.mainCategories.forEach(cat => {
            buttonsHTML += `<button class="category-filter-btn" data-action="filter-category" data-category="${cat}">${cat}</button>`;
        });
        categoryFiltersEl.innerHTML = buttonsHTML;
    }

    function setupNavObserver() {
        const options = { rootMargin: '-40% 0px -60% 0px', threshold: 0 };
        state.navObserver = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const month = entry.target.dataset.monthAnchor;
                    document.querySelectorAll('.month-btn.active').forEach(btn => btn.classList.remove('active'));
                    const targetBtn = document.querySelector(`.month-btn[data-month="${month}"]`);
                    if (targetBtn) targetBtn.classList.add('active');
                }
            });
        }, options);
    }

    function setupBackToTopButton() {
        window.addEventListener('scroll', () => {
            if (window.scrollY > 300) { backToTopBtn.classList.add('visible'); } 
            else { backToTopBtn.classList.remove('visible'); }
        });
        backToTopBtn.addEventListener('click', () => { window.scrollTo({ top: 0, behavior: 'smooth' }); });
    }
    
    function updateSearchStickiness() {
        const navHeight = quickNavContainer.offsetHeight;
        document.documentElement.style.setProperty('--nav-height', `${navHeight}px`);
    }

    // --- æ ¸å¿ƒé€»è¾‘ï¼šæ•°æ®åŠ è½½ä¸æ¸²æŸ“ ---
    async function fetchWithProgress(monthsToLoad) {
        console.log(`fetchWithProgress called with months: ${monthsToLoad}`);
        const total = monthsToLoad.length;
        if (total === 0) return;
        
        showProgress(`å¼€å§‹åŠ è½½ ${total} ä¸ªæ–‡ä»¶...`);
        let loadedCount = 0;
        
        for (const month of monthsToLoad) {
            loadedCount++;
            console.log(`Loading month ${month} (${loadedCount}/${total})`);
            updateProgress(`æ­£åœ¨åŠ è½½: ${month} (${loadedCount}/${total})`, (loadedCount / total) * 90);
            try {
                await fetchMonth(month);
                console.log(`Successfully loaded month ${month}`);
            } catch (error) {
                console.error(`Failed to load month ${month}:`, error);
                showToast(`åŠ è½½ ${month} å¤±è´¥`, 'error');
                // ç»§ç»­å°è¯•åŠ è½½å…¶ä»–æœˆä»½
            }
        }
        console.log('fetchWithProgress completed');
    }

    async function fetchMonth(month) {
        console.log(`fetchMonth called with month: ${month}`);
        if (state.loadedMonths.has(month)) {
            console.log(`Month ${month} already loaded, skipping`);
            return;
        }
        
        // æ£€æŸ¥æ˜¯å¦æ”¯æŒ Web Worker
        if (typeof Worker !== 'undefined') {
            return fetchMonthWithWorker(month);
        } else {
            return fetchMonthFallback(month);
        }
    }

    async function fetchMonthWithWorker(month) {
        console.log(`Using Web Worker for ${month}`);
        
        return new Promise((resolve, reject) => {
            const worker = new Worker('./json-parser-worker.js');
            const url = `./data/database-${month}.json`;
            
            updateProgress(`åŠ è½½ ${month} (ä½¿ç”¨ Web Worker)...`, 30);
            
            worker.postMessage({ url, month });
            
            let processedPapers = 0;
            const timeout = setTimeout(() => {
                worker.terminate();
                reject(new Error('Web Worker è¶…æ—¶'));
            }, 60000); // 60ç§’è¶…æ—¶
            
            worker.onmessage = function(e) {
                const { type, papers, progress, error } = e.data;
                
                switch (type) {
                    case 'batch':
                        // æ‰¹é‡å¤„ç†æ¥æ”¶åˆ°çš„è®ºæ–‡æ•°æ®
                        papers.forEach(paper => {
                            if (paper && paper.id && !state.allPapers.has(paper.id)) {
                                state.allPapers.set(paper.id, paper);
                            }
                        });
                        processedPapers += papers.length;
                        
                        if (progress) {
                            updateProgress(
                                `å¤„ç† ${month}: ${progress.current}/${progress.total}`, 
                                30 + (progress.percentage * 0.6)
                            );
                        }
                        break;
                        
                    case 'complete':
                        clearTimeout(timeout);
                        worker.terminate();
                        state.loadedMonths.add(month);
                        console.log(`Web Worker completed loading ${month}: ${processedPapers} papers`);
                        resolve();
                        break;
                        
                    case 'error':
                        clearTimeout(timeout);
                        worker.terminate();
                        console.error(`Web Worker error for ${month}:`, error);
                        reject(new Error(error));
                        break;
                }
            };
            
            worker.onerror = function(error) {
                clearTimeout(timeout);
                worker.terminate();
                console.error(`Web Worker error:`, error);
                reject(error);
            };
        });
    }

    async function fetchMonthFallback(month) {
        console.log(`Using fallback method for ${month}`);
        try {
            const url = `./data/database-${month}.json`;
            console.log(`Fetching URL: ${url}`);
            const response = await fetch(url);
            console.log(`Response status: ${response.status}`);
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            
            // è·å–æ–‡ä»¶å¤§å°ä»¥æ˜¾ç¤ºè¿›åº¦
            const contentLength = response.headers.get('content-length');
            const totalSize = contentLength ? parseInt(contentLength, 10) : 0;
            console.log(`File size: ${totalSize} bytes (${(totalSize/1024/1024).toFixed(1)}MB)`);
            
            // æ˜¾ç¤ºè§£æè¿›åº¦
            updateProgress(`è§£ææ•°æ®æ–‡ä»¶ ${month}...`, 50);
            
            // ä½¿ç”¨Promise.raceæ·»åŠ è¶…æ—¶æ§åˆ¶
            const parsePromise = response.json();
            const timeoutPromise = new Promise((_, reject) => 
                setTimeout(() => reject(new Error('JSONè§£æè¶…æ—¶')), 45000) // 45ç§’è¶…æ—¶
            );
            
            console.log('Starting JSON parsing...');
            const papers = await Promise.race([parsePromise, timeoutPromise]);
            console.log(`Loaded ${papers.length} papers for month ${month}`);
            
            // æ‰¹é‡å¤„ç†è®ºæ–‡æ•°æ®ä»¥é¿å…é˜»å¡
            let processedCount = 0;
            const batchSize = 500; // å‡å°æ‰¹æ¬¡å¤§å°
            for (let i = 0; i < papers.length; i += batchSize) {
                const batch = papers.slice(i, i + batchSize);
                batch.forEach(paper => { 
                    if (paper && paper.id && !state.allPapers.has(paper.id)) {
                        state.allPapers.set(paper.id, paper);
                    }
                });
                processedCount += batch.length;
                
                // æ¯å¤„ç†ä¸€æ‰¹æ•°æ®å°±è®©å‡ºæ§åˆ¶æƒ
                if (i + batchSize < papers.length) {
                    updateProgress(`å¤„ç†è®ºæ–‡æ•°æ®: ${processedCount}/${papers.length}`, 60 + (processedCount / papers.length) * 30);
                    await new Promise(resolve => setTimeout(resolve, 5)); // å¢åŠ å»¶è¿Ÿ
                }
            }
            
            state.loadedMonths.add(month);
            console.log(`Month ${month} added to loadedMonths`);
        } catch (error) { 
            console.error(`Failed to load data for month ${month}:`, error); 
            if (error.message === 'JSONè§£æè¶…æ—¶') {
                showToast(`${month} æ•°æ®æ–‡ä»¶è¿‡å¤§ï¼Œè§£æè¶…æ—¶ã€‚è¯·ç¨åé‡è¯•ã€‚`);
            }
            throw error; // é‡æ–°æŠ›å‡ºé”™è¯¯ä»¥ä¾¿ä¸Šå±‚å¤„ç†
        } 
    }

    function renderPapers(papersForMonth, month) {
        const monthWrapper = document.createElement('div');
        monthWrapper.id = `month-content-${month}`;
        monthWrapper.dataset.monthAnchor = month;

        const header = document.createElement('h2');
        header.className = 'month-header';
        header.textContent = `${month.substring(0,4)}å¹´${month.substring(5,7)}æœˆ`;
        
        const dateFilterWrapper = document.createElement('div');
        dateFilterWrapper.id = `date-filter-wrapper-${month}`;
        dateFilterWrapper.className = 'flex flex-wrap items-center gap-2 mb-6';
        
        const papersListWrapper = document.createElement('div');
        papersListWrapper.id = `papers-list-wrapper-${month}`;
        papersListWrapper.className = 'space-y-8';
        
        monthWrapper.append(header, dateFilterWrapper, papersListWrapper);
        papersContainer.appendChild(monthWrapper);
        
        if (state.navObserver) {
            state.navObserver.observe(monthWrapper);
            console.log(`navObserver now observing month ${month}`);
        } else {
            console.log('navObserver is null, skipping observe');
        }
        
        updateMonthView(month, papersForMonth);
    }
    
    function updateMonthView(month, allPapersForMonth) {
        const dateFilterWrapper = document.getElementById(`date-filter-wrapper-${month}`);
        const papersListWrapper = document.getElementById(`papers-list-wrapper-${month}`);
        if (!dateFilterWrapper || !papersListWrapper) return;

        const activeDay = state.activeDateFilters.get(month) || 'all';

        renderDateFilter(month, allPapersForMonth, dateFilterWrapper);

        const filteredPapers = (activeDay === 'all')
            ? allPapersForMonth
            : allPapersForMonth.filter(p => p.date && p.date.endsWith(`-${String(activeDay).padStart(2, '0')}`));

        papersListWrapper.innerHTML = '';
        if (filteredPapers.length > 0) {
            renderInChunks(filteredPapers, papersListWrapper);
        } else {
            papersListWrapper.innerHTML = `<p class="text-center text-gray-500 py-4">è¯¥æ—¥æœŸæ²¡æœ‰è®ºæ–‡ã€‚</p>`;
        }
    }

    function renderDateFilter(month, papers, container) {
        const activeDay = state.activeDateFilters.get(month) || 'all';
        const daysWithPapers = [...new Set(papers.map(p => p.date.split('-')[2]))].sort((a, b) => b - a);

        let buttonsHTML = `<button class="date-filter-btn ${activeDay === 'all' ? 'active' : ''}" data-action="filter-by-date" data-month="${month}" data-day="all">å…¨éƒ¨æ—¥æœŸ</button>`;
        daysWithPapers.forEach(day => {
            buttonsHTML += `<button class="date-filter-btn ${activeDay == day ? 'active' : ''}" data-action="filter-by-date" data-month="${month}" data-day="${day}">${day}æ—¥</button>`;
        });
        container.innerHTML = buttonsHTML;
    }

    function renderInChunks(papers, container, index = 0) {
        const CHUNK_SIZE = 3; // è¿›ä¸€æ­¥å‡å°æ‰¹æ¬¡å¤§å°
        if (index >= papers.length) {
            console.log(`Rendering completed. Total papers rendered: ${papers.length}`);
            // æ¸²æŸ“å®Œæˆåå¯ç”¨æ‡’åŠ è½½
            enableLazyLoading();
            return;
        }
        
        const fragment = document.createDocumentFragment();
        const endIndex = Math.min(index + CHUNK_SIZE, papers.length);
        
        for (let i = index; i < endIndex; i++) {
            if (papers[i] && papers[i].id) {
                try { 
                    fragment.appendChild(createPaperCard(papers[i], i >= 20)); // å‰20ä¸ªæ­£å¸¸æ¸²æŸ“ï¼Œåé¢æ‡’åŠ è½½
                } catch (e) { 
                    console.error(`Error creating card for paper #${papers[i].id} at index ${i}:`, papers[i], e); 
                }
            }
        }
        
        container.appendChild(fragment);
        
        // æ˜¾ç¤ºæ¸²æŸ“è¿›åº¦
        if (index % 30 === 0) { // æ¯30ä¸ªè®ºæ–‡æ˜¾ç¤ºä¸€æ¬¡è¿›åº¦
            const progress = Math.round((endIndex / papers.length) * 100);
            console.log(`Rendering progress: ${endIndex}/${papers.length} (${progress}%)`);
            
            // æ›´æ–°è¿›åº¦æ¡
            if (papers.length > 100) {
                updateProgress(`æ¸²æŸ“è®ºæ–‡: ${endIndex}/${papers.length}`, 95 + (progress * 0.05));
            }
        }
        
        // ä½¿ç”¨requestIdleCallbackæ¥ä¼˜åŒ–æ€§èƒ½
        if (window.requestIdleCallback) {
            requestIdleCallback(() => renderInChunks(papers, container, endIndex), { timeout: 100 });
        } else {
            // é™çº§åˆ°setTimeoutï¼Œå¢åŠ å»¶è¿Ÿä»¥é¿å…é˜»å¡
            setTimeout(() => renderInChunks(papers, container, endIndex), 15);
        }
    }

    function enableLazyLoading() {
        // ä¸ºæ‡’åŠ è½½çš„å›¾ç‰‡å’Œå†…å®¹è®¾ç½® Intersection Observer
        const lazyElements = document.querySelectorAll('.lazy-load');
        if (lazyElements.length === 0) return;
        
        const lazyObserver = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const element = entry.target;
                    // è§¦å‘æ‡’åŠ è½½å†…å®¹çš„æ¸²æŸ“
                    if (element.dataset.paperId) {
                        loadPaperDetails(element.dataset.paperId);
                    }
                    lazyObserver.unobserve(element);
                }
            });
        }, {
            rootMargin: '100px' // æå‰100pxå¼€å§‹åŠ è½½
        });
        
        lazyElements.forEach(el => lazyObserver.observe(el));
    }

    function loadPaperDetails(paperId) {
        const placeholder = document.getElementById(`lazy-${paperId}`);
        if (!placeholder) return;
        
        // å»¶è¿ŸåŠ è½½è¯¦ç»†å†…å®¹
        setTimeout(() => {
            const paper = state.allPapers.get(paperId);
            if (paper) {
                placeholder.outerHTML = createDetailedPaperContent(paper);
                // é‡æ–°åˆå§‹åŒ–è¿™ä¸ªè®ºæ–‡å¡ç‰‡çš„åŠŸèƒ½
                setTimeout(() => {
                    updatePaperRatingDisplay(paperId);
                    updatePaperTagsDisplay(paperId);
                }, 0);
            }
        }, 50);
    }

    function createPaperCard(paper, isLazy = false) {
        const card = document.createElement('article');
        card.id = `card-${paper.id}`;
        card.style.viewTransitionName = `card-${paper.id}`;
        card.className = 'paper-card bg-white p-6 rounded-lg shadow-md border border-gray-200';
        card.setAttribute('tabindex', '0');
        card.setAttribute('role', 'article');
        card.setAttribute('aria-label', `è®ºæ–‡: ${paper.title || 'æ— æ ‡é¢˜'}`);
        
        if (isLazy) {
            // æ‡’åŠ è½½æ¨¡å¼ï¼šåªæ¸²æŸ“åŸºæœ¬ä¿¡æ¯
            card.innerHTML = createLazyPaperContent(paper);
        } else {
            // æ­£å¸¸æ¨¡å¼ï¼šæ¸²æŸ“å®Œæ•´å†…å®¹
            card.innerHTML = createDetailedPaperContent(paper);
            // åˆå§‹åŒ–ç”¨æˆ·åŠŸèƒ½æ˜¾ç¤º
            setTimeout(() => {
                updatePaperRatingDisplay(paper.id);
                updatePaperTagsDisplay(paper.id);
            }, 0);
        }
        
        return card;
    }

    function createLazyPaperContent(paper) {
        const isFavorited = state.favorites.has(paper.id);
        const categoriesHTML = (paper.categories && paper.categories.length > 0) ? 
            paper.categories.slice(0, 2).map(cat => `<span class="keyword-tag inline-block bg-gray-100 text-gray-600 text-xs px-2 py-1 rounded">${cat}</span>`).join('') : '';
        
        return `
            <div class="flex justify-between items-start">
                <p class="text-sm text-gray-500 mb-2 flex-grow">${paper.date || 'æœªçŸ¥æ—¥æœŸ'} ${categoriesHTML ? '| ' : ''}${categoriesHTML}</p>
                <button data-action="toggle-favorite" data-paper-id="${paper.id}" title="æ”¶è—/å–æ¶ˆæ”¶è—" class="favorite-btn ${isFavorited ? 'favorited' : ''}">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" /></svg>
                </button>
            </div>
            <h2 class="text-lg font-bold mb-2 text-gray-900">${paper.title || 'æ— æ ‡é¢˜'}</h2>
            <p class="text-sm text-gray-600 mb-2">${paper.authors ? paper.authors.slice(0, 100) + (paper.authors.length > 100 ? '...' : '') : 'æœªçŸ¥ä½œè€…'}</p>
            <div id="lazy-${paper.id}" class="lazy-load" data-paper-id="${paper.id}">
                <div class="text-center py-4 text-gray-400">
                    <div class="inline-block w-6 h-6 border-2 border-gray-300 border-t-gray-600 rounded-full animate-spin"></div>
                    <p class="mt-2 text-sm">åŠ è½½è¯¦ç»†å†…å®¹...</p>
                </div>
            </div>
        `;
    }

    function createDetailedPaperContent(paper) {
        let title = paper.title || 'æ— æ ‡é¢˜';
        if (state.isSearchMode && state.currentQuery && !state.categoryIndex[state.currentQuery] && state.currentQuery !== 'favorites') {
            const queryTerms = state.currentQuery.toLowerCase().split(/\s+/).filter(Boolean);
            const regex = new RegExp(queryTerms.map(escapeRegex).join('|'), 'gi');
            title = title.replace(regex, match => `<span class="highlight">${match}</span>`);
        }
        
        const keywordsHTML = (paper.keywords && paper.keywords.length > 0) ? paper.keywords.map(kw => `<span class="keyword-tag inline-block bg-blue-100 text-blue-800 text-sm font-medium mr-2 mb-2 px-3 py-1 rounded-full" data-action="search-tag" data-tag-value="${escapeCQ(kw)}">${kw}</span>`).join('') : 'æ— ';
        const categoriesHTML = (paper.categories && paper.categories.length > 0) ? paper.categories.map(cat => `<span class="keyword-tag inline-block bg-gray-100 text-gray-600 text-sm font-medium mr-2 mb-2 px-3 py-1 rounded-full" data-action="search-tag" data-tag-value="${escapeCQ(cat)}">${cat}</span>`).join('') : '';
        const absUrl = paper.id ? `https://arxiv.org/abs/${paper.id}` : '#';
        const pdfUrl = paper.id ? `https://arxiv.org/pdf/${paper.id}` : '#';
        const isFavorited = state.favorites.has(paper.id);
        
        const createInfoBox = (title, content, color) => {
            if (!content) return '';
            const isTldr = title === 'TL;DR';
            const titleClass = isTldr ? 'italic' : '';
            let contentClasses = [''];
            if (isTldr) {
                contentClasses.push('italic', 'text-sm');
            }
            return `<div class="info-box info-box-${color}"><p class="info-box-title ${titleClass}">${title}:</p><p class="${contentClasses.join(' ')}">${content}</p></div>`;
        };

        return `
            <div class="flex justify-between items-start">
                <p class="text-sm text-gray-500 mb-2 flex-grow">${paper.date||'æœªçŸ¥æ—¥æœŸ'} ${categoriesHTML?'| ':''}${categoriesHTML}</p>
                <div class="flex items-center space-x-2">
                    <button data-action="toggle-notes" data-paper-id="${paper.id}" title="æ·»åŠ /ç¼–è¾‘ç¬”è®°" class="text-gray-500 hover:text-blue-600 transition">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg>
                    </button>
                    <button data-action="share-paper" data-paper-id="${paper.id}" title="åˆ†äº«è®ºæ–‡é“¾æ¥" class="share-btn">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M15 8a3 3 0 10-2.977-2.63l-4.94 2.47a3 3 0 100 4.319l4.94 2.47a3 3 0 10.895-1.789l-4.94-2.47a3.027 3.027 0 000-.74l4.94-2.47C13.456 7.68 14.19 8 15 8z" /></svg>
                    </button>
                    <button data-action="toggle-favorite" data-paper-id="${paper.id}" title="æ”¶è—/å–æ¶ˆæ”¶è—" aria-label="æ”¶è—æˆ–å–æ¶ˆæ”¶è—" class="favorite-btn ${isFavorited?'favorited':''}">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" /></svg>
                    </button>
                </div>
            </div>
            <h2 class="text-xl md:text-2xl font-bold mb-2 text-gray-900">${title}</h2>
            <h3 class="text-base font-semibold mb-3 text-blue-700 italic">${paper.zh_title||''}</h3>
            
            <!-- æ–°å¢ï¼šç”¨æˆ·è¯„åˆ† -->
            <div id="paper-rating-${paper.id}" class="paper-rating compact-hidden"></div>
            
            <!-- æ–°å¢ï¼šç”¨æˆ·æ ‡ç­¾ -->
            <div id="paper-tags-${paper.id}" class="paper-tags compact-hidden"></div>
            
            <div class="text-sm text-gray-600 mb-3 compact-hidden">
                <p><strong>ä½œè€…:</strong> ${paper.authors||'æœªçŸ¥ä½œè€…'}</p>
                <p class="mt-2"><strong>Keyword:</strong> ${keywordsHTML}</p>
            </div>
            
            <!-- æ–°å¢ï¼šç”¨æˆ·ç¬”è®° -->
            <div id="paper-notes-${paper.id}" class="paper-notes compact-hidden">
                <textarea class="notes-textarea" placeholder="åœ¨è¿™é‡Œè®°å½•æ‚¨çš„æƒ³æ³•å’Œç¬”è®°..." data-paper-id="${paper.id}"></textarea>
                <div class="flex justify-end mt-2">
                    <button class="text-sm bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700" data-action="save-note" data-paper-id="${paper.id}">ä¿å­˜ç¬”è®°</button>
                </div>
            </div>
            
            <div class="compact-hidden">
                ${createInfoBox('Comment',paper.comment,'yellow')}
                ${createInfoBox('TL;DR',paper.tldr,'green')}
                ${createInfoBox('AIç‚¹è¯„',paper.comments,'indigo')}
            </div>
            <div id="ai-details-${paper.id}" class="details-section ai-details-section compact-hidden">
                <h2 class="text-2xl font-bold mb-4 text-gray-800">AIåˆ†æä¸æ‘˜è¦</h2>
                ${paper.motivation?`<h3>ç ”ç©¶åŠ¨æœº</h3><p>${paper.motivation}</p><br/>`:''}
                ${paper.method?`<h3>ç ”ç©¶æ–¹æ³•</h3><p>${paper.method}</p><br/>`:''}
                ${paper.results?`<h3>ç ”ç©¶ç»“æœ</h3><p>${paper.results}</p><br/>`:''}
                ${paper.conclusion?`<h3>ç ”ç©¶ç»“è®º</h3><p>${paper.conclusion}</p><br/>`:''}
                <h3>æ‘˜è¦ç¿»è¯‘</h3><p class="italic text-sm">${paper.translation||'æ— '}</p><br/>
                <h3>åŸæ–‡æ‘˜è¦</h3><p class="italic text-sm">${paper.abstract||'æ— '}</p>
            </div>
            <div class="flex items-center space-x-4 mt-4">
                <a href="${absUrl}" target="_blank" class="text-blue-500 hover:text-blue-700 font-semibold">æ‘˜è¦é¡µ</a>
                <a href="${pdfUrl}" target="_blank" class="text-red-500 hover:text-red-700 font-semibold">PDF</a>
                <button data-action="toggle-ai-details" data-paper-id="${paper.id}" class="ml-auto bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg transition compact-hidden">AIåˆ†æ</button>
            </div>`;
    }

    function toggleAIDetails(paperId) {
        const detailsSection = document.getElementById(`ai-details-${paperId}`);
        if (detailsSection) detailsSection.classList.toggle('expanded');
    }
    
    function loadFavorites() { const favs = localStorage.getItem('arxiv_favorites'); if (favs) { try { state.favorites = new Set(JSON.parse(favs)); } catch (e) { state.favorites = new Set(); } } }
    function saveFavorites() { localStorage.setItem('arxiv_favorites', JSON.stringify(Array.from(state.favorites))); }
    function toggleFavorite(event, paperId, btn) {
        event.stopPropagation();
        const update = () => {
            if (state.favorites.has(paperId)) {
                state.favorites.delete(paperId); btn.classList.remove('favorited');
                if (state.currentQuery === 'favorites') btn.closest('.paper-card').remove();
            } else {
                state.favorites.add(paperId); btn.classList.add('favorited');
            }
            saveFavorites();
            document.getElementById('favorites-count').textContent = state.favorites.size;
        }
        if (state.currentQuery === 'favorites' && state.favorites.has(paperId)) {
            applyViewTransition(update, 'fav-remove');
        } else { update(); }
    }
    
    function loadViewMode() { const savedMode = localStorage.getItem('arxiv_view_mode') || 'detailed'; state.viewMode = savedMode; mainContainer.className = `${savedMode}-view`; }
    function toggleViewMode(mode) {
        if (state.viewMode === mode) return;
        applyViewTransition(() => {
            state.viewMode = mode;
            localStorage.setItem('arxiv_view_mode', mode);
            mainContainer.className = `${mode}-view`;
            updateViewModeUI();
        }, 'view-toggle');
    }
    function updateViewModeUI() {
        document.getElementById('view-detailed-btn')?.classList.toggle('active', state.viewMode === 'detailed');
        document.getElementById('view-compact-btn')?.classList.toggle('active', state.viewMode === 'compact');
    }

    // --- æ ¸å¿ƒé€»è¾‘ï¼šçŠ¶æ€åˆ‡æ¢ä¸å¯¼èˆª ---
    // ä¿®å¤ï¼šé‡æ„æœˆä»½å¯¼èˆªé€»è¾‘ï¼Œç¡®ä¿å…¶è¡Œä¸ºæ­£ç¡®
    async function navigateToMonth(month) {
        console.log(`=== NAVIGATE TO MONTH START ===`);
        performance.startTracking(`Navigate to ${month}`);
        
        console.log(`navigateToMonth called with month: ${month}`);
        console.log(`isFetching: ${state.isFetching}`);
        
        if (state.isFetching) {
            console.log('Already fetching, returning early');
            return;
        }
        
        state.isFetching = true;
        console.log('Set isFetching to true');
        showProgress('å‡†å¤‡å¯¼èˆª...');
        
        try {
            if (state.isSearchMode) {
                console.log('Resetting search mode...');
                resetToDefaultView(false); // ä»…é‡ç½®UIï¼Œä¸é‡è½½æ•°æ®ä»¥ä¿ç•™ç¼“å­˜
            }
            
            console.log(`Available months: ${JSON.stringify(state.manifest.availableMonths)}`);
            const targetIndex = state.manifest.availableMonths.indexOf(month);
            console.log(`Target index for ${month}: ${targetIndex}`);
            
            if (targetIndex === -1) {
                console.error(`æ— æ•ˆçš„æœˆä»½: ${month}`);
                showToast(`æ— æ•ˆçš„æœˆä»½: ${month}`);
                return;
            }
            
            // å¯¹å¤§æ•°æ®æ–‡ä»¶æ˜¾ç¤ºè­¦å‘Š
            if (month === '2025-06' || month === '2025-05') {
                showToast(`${month} åŒ…å«å¤§é‡æ•°æ®ï¼ŒåŠ è½½å¯èƒ½éœ€è¦è¾ƒé•¿æ—¶é—´...`);
            }
            
            console.log('Starting fetchWithProgress...');
            await fetchWithProgress([month]);
            console.log('fetchWithProgress completed');
            
            console.log('Starting UI updates...');
            updateProgress('æ¸²æŸ“è®ºæ–‡...', 95);
            papersContainer.innerHTML = ''; // å½»åº•æ¸…ç©ºå®¹å™¨
            console.log('Papers container cleared');
            
            if (state.navObserver) {
                state.navObserver.disconnect();
                console.log('navObserver disconnected');
            } else {
                console.log('navObserver is null, skipping disconnect');
            }
            state.activeDateFilters.clear();
            console.log('Date filters cleared');
            
            // æ¸²æŸ“ç›®æ ‡æœˆä»½
            console.log('Filtering papers for month...');
            const papersInMonth = Array.from(state.allPapers.values()).filter(p => p.id.startsWith(month.replace('-', '').substring(2)));
            console.log(`Found ${papersInMonth.length} papers for month ${month}`);
            
            console.log('Calling renderPapers...');
            renderPapers(papersInMonth.sort((a,b)=>b.date.localeCompare(a.date)), month);
            console.log('renderPapers completed');
            
            // æ­£ç¡®è®¾ç½®å½“å‰æœˆä»½ç´¢å¼•ï¼Œä¸ºæ— é™æ»šåŠ¨åšå‡†å¤‡
            state.currentMonthIndex = targetIndex;
            console.log(`Set currentMonthIndex to ${targetIndex}`);
            
            window.scrollTo({ top: 0, behavior: 'auto' });
            console.log('Scrolled to top');
            console.log('Navigation completed successfully');
            
            performance.endTracking(`Navigate to ${month}`);

        } catch (error) {
            console.error('Navigation error:', error);
            console.error('Error stack:', error.stack);
            showToast('å¯¼èˆªå¤±è´¥ï¼Œè¯·é‡è¯•');
        } finally {
            console.log('=== FINALLY BLOCK START ===');
            state.isFetching = false;
            console.log('Set isFetching to false');
            hideProgress();
            console.log('Hidden progress indicator');
            console.log('=== NAVIGATE TO MONTH END ===');
        }
    }

    // ä¿®å¤ï¼šç¡®ä¿loadNextMonthä»…è¿½åŠ å†…å®¹
    async function loadNextMonth(triggeredByScroll = true) {
        if (state.isFetching || state.isSearchMode) return;
        loader.classList.remove('hidden');
        state.isFetching = true;
        try {
            const nextIndex = state.currentMonthIndex + 1;
            if (state.manifest && state.manifest.availableMonths && nextIndex < state.manifest.availableMonths.length) {
                const nextMonth = state.manifest.availableMonths[nextIndex];
                await fetchMonth(nextMonth);
                const papersInMonth = Array.from(state.allPapers.values()).filter(p => p.id.startsWith(nextMonth.replace('-', '').substring(2)));
                // å…³é”®ä¿®å¤ï¼šrenderPapersç°åœ¨åªæ¥æ”¶æ–°æœˆä»½çš„æ•°æ®ï¼Œå¹¶å°†å…¶è¿½åŠ åˆ°å®¹å™¨ä¸­
                renderPapers(papersInMonth.sort((a,b)=>b.date.localeCompare(a.date)), nextMonth);
                state.currentMonthIndex = nextIndex;
            } else {
                if (endOfListMessage && triggeredByScroll) endOfListMessage.classList.remove('hidden');
            }
        } finally {
            state.isFetching = false;
            loader.classList.add('hidden');
        }
    }
    
    async function handleSearch() {
        if (state.isFetching) return;
        state.isFetching = true;
        
        try {
            const query = searchInput.value.trim();
            
            if (query !== state.currentQuery) {
                showProgress(`æ­£åœ¨æœç´¢ "${query}"...`);
            }
            
            await applyViewTransition(async () => {
                state.currentQuery = query;
                const url = new URL(window.location);
                url.searchParams.delete('paper');
                query ? url.searchParams.set('q', query) : url.searchParams.delete('q');
                history.pushState({}, '', url);

                if (!query) { resetToDefaultView(); return; }
                
                state.isSearchMode = true;
                state.activeCategoryFilter = 'all';
                papersContainer.classList.add('hidden');
                searchResultsContainer.classList.remove('hidden');
                quickNavContainer.style.display = 'none';
                categoryFilterContainer.classList.remove('hidden');
                searchInfoEl.classList.remove('hidden');
                searchResultsContainer.innerHTML = '';

                let results = [];
                let requiredMonths = new Set();

                if (query === 'favorites') {
                    const favoriteIds = Array.from(state.favorites);
                    if (favoriteIds.length > 0) {
                        requiredMonths = new Set(favoriteIds.map(id => `20${id.substring(0, 2)}-${id.substring(2, 4)}`));
                    }
                } else {
                    try {
                        if (!state.categoryIndex) {
                            updateProgress('åŠ è½½åˆ†ç±»ç´¢å¼•...', 10);
                            state.categoryIndex = await (await fetch('./data/category_index.json')).json();
                        }
                        if (!state.searchIndex) {
                            updateProgress('åŠ è½½æœç´¢ç´¢å¼•...', 20);
                            state.searchIndex = await (await fetch('./data/search_index.json')).json();
                        }
                    } catch(error) { searchResultsContainer.innerHTML = `<p class="text-center text-red-500">ç´¢å¼•æ–‡ä»¶åŠ è½½å¤±è´¥: ${error.message}ã€‚</p>`; return; }

                    let matchingIds;
                    if (state.categoryIndex[query]) { matchingIds = new Set(state.categoryIndex[query]); } 
                    else { matchingIds = new Set(); const queryTokens = query.toLowerCase().split(/\s+/).filter(Boolean); queryTokens.forEach((token, index) => { const foundIds = new Set(); for (const key in state.searchIndex) { if (key.includes(token)) state.searchIndex[key].forEach(id => foundIds.add(id)); } if (index === 0) {matchingIds = foundIds;} else { matchingIds = new Set([...matchingIds].filter(id => foundIds.has(id)));} }); }
                    
                    requiredMonths = new Set([...matchingIds].map(id => `20${id.substring(0, 2)}-${id.substring(2, 4)}`));
                }
                
                const monthsToLoad = [...requiredMonths].filter(m => !state.loadedMonths.has(m));
                await fetchWithProgress(monthsToLoad);

                updateProgress('æ•´ç†ç»“æœ...', 95);
                
                if (query === 'favorites') {
                     results = Array.from(state.favorites).map(id => state.allPapers.get(id)).filter(Boolean).sort((a,b) => b.date.localeCompare(a.date));
                } else {
                    let finalMatchingIds;
                    if (state.categoryIndex[query]) { finalMatchingIds = new Set(state.categoryIndex[query]); }
                    else {
                        finalMatchingIds = new Set();
                        const queryTokens = query.toLowerCase().split(/\s+/).filter(Boolean);
                        queryTokens.forEach((token, index) => {
                            const foundIds = new Set();
                            for (const key in state.searchIndex) {
                                if (key.includes(token)) {
                                    state.searchIndex[key].forEach(id => foundIds.add(id));
                                }
                            }
                            if (index === 0) {
                                finalMatchingIds = foundIds;
                            } else {
                                finalMatchingIds = new Set([...finalMatchingIds].filter(id => foundIds.has(id)));
                            }
                        });
                    }
                    results = Array.from(finalMatchingIds).map(id => state.allPapers.get(id)).filter(Boolean).sort((a,b) => b.date.localeCompare(a.date));
                }
                
                state.currentSearchResults = results;
                renderFilteredResults();
            });
        } finally {
            state.isFetching = false;
            hideProgress();
        }
    }
    
    function renderFilteredResults() {
        const { currentSearchResults, activeCategoryFilter, currentQuery } = state;
        
        const filtered = activeCategoryFilter === 'all'
            ? currentSearchResults
            : currentSearchResults.filter(paper => paper.categories && paper.categories.includes(activeCategoryFilter));

        searchResultsContainer.innerHTML = '';
        
        let infoText;
        if (currentQuery === 'favorites') {
            infoText = `æ­£åœ¨æ˜¾ç¤ºæ‚¨çš„ <strong>${currentSearchResults.length}</strong> ç¯‡æ”¶è—`;
        } else {
            infoText = `ä¸ºæ‚¨æ‰¾åˆ° <strong>${currentSearchResults.length}</strong> ç¯‡å…³äº "<strong>${currentQuery}</strong>" çš„è®ºæ–‡`;
        }
        
        if (activeCategoryFilter !== 'all') {
            infoText += `ï¼Œå…¶ä¸­ <strong>${filtered.length}</strong> ç¯‡å±äº <strong>${activeCategoryFilter}</strong> åˆ†ç±»ï¼š`;
        } else {
            infoText += 'ï¼š';
        }

        searchInfoEl.innerHTML = infoText;

        if (filtered.length > 0) {
            renderInChunks(filtered, searchResultsContainer);
        } else {
            searchResultsContainer.innerHTML = `<p class="text-center text-gray-500">åœ¨æ­¤åˆ†ç±»ä¸‹æœªæ‰¾åˆ°ç›¸å…³è®ºæ–‡ã€‚</p>`;
        }
        
        document.querySelectorAll('.category-filter-btn').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.category === activeCategoryFilter);
        });
    }
    
    function resetToDefaultView(reload = true) {
        state.isSearchMode = false;
        searchInput.value = ''; 
        state.currentQuery = '';
        
        const url = new URL(window.location);
        url.searchParams.delete('q');
        url.searchParams.delete('paper');
        history.pushState({}, '', url);

        searchResultsContainer.classList.add('hidden');
        papersContainer.classList.remove('hidden');
        quickNavContainer.style.display = 'block';
        searchInfoEl.classList.add('hidden');
        categoryFilterContainer.classList.add('hidden');
        state.currentSearchResults = [];
        state.activeCategoryFilter = 'all';

        if (reload) {
            papersContainer.innerHTML = '';
            state.currentMonthIndex = -1;
            loadNextMonth(false);
        }
        updateSearchStickiness();
    }

    function performTagSearch(tag) {
        window.scrollTo({ top: 0, behavior: 'auto' });
        searchInput.value = tag;
        handleSearch();
    };

    function setupIntersectionObserver() {
        const options = { root: null, rootMargin: '0px', threshold: 0.1 };
        const observer = new IntersectionObserver((entries, observer) => { entries.forEach(entry => { if (entry.isIntersecting && !state.isFetching && !state.isSearchMode) { loadNextMonth(); } }); }, options);
        if (loader) observer.observe(loader);
    }

    // --- æ–°å¢å’Œä¼˜åŒ–çš„äº‹ä»¶å¤„ç† ---
    
    async function handleDirectLink(paperId) {
        if (state.isFetching) return;
        state.isFetching = true;
        showProgress('æ­£åœ¨å®šä½è®ºæ–‡...');
        try {
            if (!/^\d{4}\.\d{4,5}$/.test(paperId)) {
                showToast(`æ— æ•ˆçš„è®ºæ–‡IDæ ¼å¼: ${paperId}`);
                console.error(`æ— æ•ˆçš„è®ºæ–‡IDæ ¼å¼: ${paperId}`);
                const url = new URL(window.location);
                url.searchParams.delete('paper');
                history.replaceState({}, '', url);
                await loadNextMonth(false);
                return;
            }

            const month = `20${paperId.substring(0, 2)}-${paperId.substring(2, 4)}`;
            await navigateToMonth(month);
            
            if (!state.allPapers.has(paperId)) {
                console.error(`è®ºæ–‡ ID ${paperId} åœ¨æ•°æ®ä¸­æœªæ‰¾åˆ°ã€‚`);
                showToast(`æ‰¾ä¸åˆ°æŒ‡å®šçš„è®ºæ–‡ (ID: ${paperId})`);
                const url = new URL(window.location);
                url.searchParams.delete('paper');
                history.replaceState({}, '', url);
                return;
            }

            const checkCardExists = (resolve) => {
                const card = document.getElementById(`card-${paperId}`);
                if (card) { resolve(card); } 
                else { requestAnimationFrame(() => checkCardExists(resolve)); }
            };

            const card = await new Promise(checkCardExists);
            
            card.scrollIntoView({ behavior: 'smooth', block: 'center' });
            card.classList.add('highlight-shared-paper');
            setTimeout(() => card.classList.remove('highlight-shared-paper'), 3000);
        } finally {
            state.isFetching = false;
            hideProgress();
        }
    }
    
    function showToast(message) {
        toastNotificationEl.textContent = message;
        toastNotificationEl.classList.add('show');
        setTimeout(() => {
            toastNotificationEl.classList.remove('show');
        }, 3000);
    }

    async function sharePaper(paperId) {
        const url = new URL(window.location.origin + window.location.pathname);
        url.searchParams.set('paper', paperId);
        try {
            await navigator.clipboard.writeText(url.href);
            showToast('é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
        } catch (err) {
            console.error('æ— æ³•å¤åˆ¶é“¾æ¥: ', err);
            showToast('å¤åˆ¶å¤±è´¥ã€‚');
        }
    }

    function setupGlobalEventListeners() {
        // ä¸»å®¹å™¨äº‹ä»¶ä»£ç†
        mainContainer.addEventListener('click', (event) => {
            const target = event.target.closest('[data-action]');
            if (!target || state.isFetching) return;
            const { action, paperId, tagValue, month, day, tag, rating } = target.dataset;

            switch (action) {
                case 'toggle-ai-details': toggleAIDetails(paperId); break;
                case 'search-tag': performTagSearch(tagValue); break;
                case 'toggle-favorite': toggleFavorite(event, paperId, target); break;
                case 'share-paper': sharePaper(paperId); break;
                case 'toggle-notes': togglePaperNotes(paperId); break;
                case 'save-note': 
                    const textarea = document.querySelector(`#paper-notes-${paperId} textarea`);
                    if (textarea) savePaperNote(paperId, textarea.value);
                    showToast('ç¬”è®°å·²ä¿å­˜');
                    break;
                case 'remove-tag': removePaperTag(paperId, tag); break;
                case 'rate-paper': setPaperRating(paperId, parseInt(rating)); break;
                case 'filter-by-date':
                    state.activeDateFilters.set(month, day);
                    const papersForMonth = Array.from(state.allPapers.values())
                        .filter(p => p.id.startsWith(month.replace('-', '').substring(2)))
                        .sort((a,b)=>b.date.localeCompare(a.date));
                    updateMonthView(month, papersForMonth);
                    break;
            }
        });
        
        // å¿«é€Ÿå¯¼èˆªå®¹å™¨äº‹ä»¶
        quickNavContainer.addEventListener('click', async (event) => {
             const target = event.target.closest('[data-action]');
             if (!target || state.isFetching) return;
             const { action, month, mode, tagValue } = target.dataset;

             switch (action) {
                case 'navigate-month': await navigateToMonth(month); break;
                case 'toggle-view': toggleViewMode(mode); break;
                case 'search-tag': performTagSearch(tagValue); break;
             }
        });
        
        // åˆ†ç±»ç­›é€‰å®¹å™¨äº‹ä»¶
        categoryFilterContainer.addEventListener('click', (event) => {
            const target = event.target.closest('[data-action="filter-category"]');
            if (!target || state.isFetching) return;
            state.activeCategoryFilter = target.dataset.category;
            renderFilteredResults();
        });

        // ä¸»é¢˜åˆ‡æ¢
        themeToggle.addEventListener('click', toggleTheme);
        
        // æœç´¢å†å²æ§åˆ¶
        searchHistoryToggle.addEventListener('click', () => {
            state.searchHistoryVisible = !state.searchHistoryVisible;
            searchHistoryPanel.classList.toggle('hidden', !state.searchHistoryVisible);
            searchHistoryToggle.textContent = state.searchHistoryVisible ? 'éšè—å†å²' : 'æœç´¢å†å²';
        });
        
        // æ¸…é™¤æœç´¢å†å²
        document.getElementById('clear-history')?.addEventListener('click', clearSearchHistory);
        
        // æœç´¢å†å²é¡¹ç‚¹å‡»
        searchHistoryItems.addEventListener('click', (event) => {
            const query = event.target.dataset.query;
            if (query) {
                searchInput.value = query;
                handleSearch();
                searchHistoryPanel.classList.add('hidden');
                state.searchHistoryVisible = false;
                searchHistoryToggle.textContent = 'æœç´¢å†å²';
            }
        });
        
        // æœç´¢å»ºè®®äº¤äº’
        searchSuggestions.addEventListener('click', (event) => {
            const suggestion = event.target.closest('.suggestion-item')?.dataset.suggestion;
            if (suggestion) selectSuggestion(suggestion);
        });

        // æœç´¢è¾“å…¥æ¡†äº‹ä»¶
        let searchTimeout;
        searchInput.addEventListener('input', (event) => {
            clearTimeout(searchTimeout);
            const query = event.target.value;
            showSearchSuggestions(query);
            searchTimeout = setTimeout(() => {
                if (!state.isFetching) handleSearch();
            }, 300);
        });
        
        // é”®ç›˜å¯¼èˆªæ”¯æŒ
        searchInput.addEventListener('keydown', (event) => {
            if (searchSuggestions.classList.contains('visible')) {
                const items = searchSuggestions.querySelectorAll('.suggestion-item');
                switch (event.key) {
                    case 'ArrowDown':
                        event.preventDefault();
                        state.currentSuggestionIndex = Math.min(state.currentSuggestionIndex + 1, items.length - 1);
                        updateSuggestionHighlight();
                        break;
                    case 'ArrowUp':
                        event.preventDefault();
                        state.currentSuggestionIndex = Math.max(state.currentSuggestionIndex - 1, -1);
                        updateSuggestionHighlight();
                        break;
                    case 'Enter':
                        if (state.currentSuggestionIndex >= 0) {
                            event.preventDefault();
                            const suggestion = items[state.currentSuggestionIndex]?.dataset.suggestion;
                            if (suggestion) selectSuggestion(suggestion);
                        }
                        break;
                    case 'Escape':
                        hideSearchSuggestions();
                        break;
                }
            }
        });
        
        // ç‚¹å‡»å¤–éƒ¨éšè—æœç´¢å»ºè®®
        document.addEventListener('click', (event) => {
            if (!searchBarContainer.contains(event.target)) {
                hideSearchSuggestions();
            }
        });
        
        // æ»šåŠ¨äº‹ä»¶ï¼šé˜…è¯»è¿›åº¦å’Œè¿”å›é¡¶éƒ¨
        window.addEventListener('scroll', () => {
            updateReadingProgress();
            if (window.scrollY > 300) { 
                backToTopBtn.classList.add('visible'); 
            } else { 
                backToTopBtn.classList.remove('visible'); 
            }
        });
        
        // è¿”å›é¡¶éƒ¨æŒ‰é’®
        backToTopBtn.addEventListener('click', () => { 
            window.scrollTo({ top: 0, behavior: 'smooth' }); 
        });
        
        // é”®ç›˜è®¿é—®æ€§æ”¯æŒ
        document.addEventListener('keydown', handleGlobalKeyNavigation);
    }
    
    function updateSuggestionHighlight() {
        const items = searchSuggestions.querySelectorAll('.suggestion-item');
        items.forEach((item, index) => {
            item.classList.toggle('highlighted', index === state.currentSuggestionIndex);
        });
    }
    
    function handleGlobalKeyNavigation(event) {
        // ESCé”®é‡ç½®ç„¦ç‚¹
        if (event.key === 'Escape') {
            document.activeElement?.blur();
            hideSearchSuggestions();
        }
        
        // Ctrl/Cmd + K å¿«é€Ÿèšç„¦æœç´¢æ¡†
        if ((event.ctrlKey || event.metaKey) && event.key === 'k') {
            event.preventDefault();
            searchInput.focus();
        }
        
        // Ctrl/Cmd + D åˆ‡æ¢æ·±è‰²æ¨¡å¼
        if ((event.ctrlKey || event.metaKey) && event.key === 'd') {
            event.preventDefault();
            toggleTheme();
        }
    }

    window.addEventListener('popstate', () => { 
        const urlParams = new URLSearchParams(window.location.search);
        const query = urlParams.get('q') || '';
        if (searchInput.value !== query) {
            searchInput.value = query;
            handleSearch();
        }
    });

    window.addEventListener('resize', updateSearchStickiness);
    
    // ç›‘å¬ç³»ç»Ÿä¸»é¢˜å˜åŒ–
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
        if (!localStorage.getItem('arxiv_theme')) {
            setTheme(e.matches ? 'dark' : 'light');
        }
    });
    
    document.addEventListener('DOMContentLoaded', init);
</script>

</body>
</html>