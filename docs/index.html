<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI论文每日速览 | Daily Arxiv AI Enhancer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* CSS 变量系统 - 支持深色模式 */
        :root {
            --bg-primary: #f8f9fa;
            --bg-secondary: #ffffff;
            --bg-tertiary: #f3f4f6;
            --text-primary: #1f2937;
            --text-secondary: #4b5563;
            --text-tertiary: #6b7280;
            --border-primary: #e5e7eb;
            --border-secondary: #d1d5db;
            --accent-primary: #3b82f6;
            --accent-secondary: #60a5fa;
            --shadow-light: rgba(0, 0, 0, 0.1);
            --shadow-dark: rgba(0, 0, 0, 0.2);
            --highlight-bg: #fef9c3;
            --highlight-text: #713f12;
        }
        
        [data-theme="dark"] {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #334155;
            --text-primary: #f1f5f9;
            --text-secondary: #cbd5e1;
            --text-tertiary: #94a3b8;
            --border-primary: #334155;
            --border-secondary: #475569;
            --accent-primary: #60a5fa;
            --accent-secondary: #3b82f6;
            --shadow-light: rgba(0, 0, 0, 0.3);
            --shadow-dark: rgba(0, 0, 0, 0.5);
            --highlight-bg: #422006;
            --highlight-text: #fbbf24;
        }
        
        /* 新增：为平滑滚动提供基础 */
        html { scroll-behavior: smooth; }
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: var(--bg-primary); 
            color: var(--text-primary);
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .paper-card { 
            background-color: var(--bg-secondary) !important;
            border-color: var(--border-primary) !important;
            color: var(--text-primary) !important;
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out, background-color 0.3s ease; 
        }
        .paper-card:hover { 
            transform: translateY(-5px); 
            box-shadow: 0 10px 15px -3px var(--shadow-light), 0 4px 6px -2px var(--shadow-dark); 
        }
        .loader { border-top-color: var(--accent-primary); animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .keyword-tag { 
            background-color: var(--bg-tertiary);
            color: var(--text-secondary);
            transition: background-color 0.2s ease, color 0.2s ease; 
            cursor: pointer; 
        }
        .keyword-tag:hover { background-color: var(--accent-primary); color: white; }
        .details-section h3 { font-size: 1.125rem; font-weight: 600; margin-bottom: 0.5rem; color: var(--accent-primary); }
        .details-section p { color: var(--text-secondary); line-height: 1.6; }
        .info-box { 
            border-left-width: 4px; 
            padding: 1rem; 
            margin-top: 1rem; 
            margin-bottom: 1rem; 
            border-radius: 0 0.5rem 0.5rem 0;
            background-color: var(--bg-tertiary);
            border-color: var(--border-secondary);
        }
        .info-box-title { font-weight: 600; color: var(--text-primary); }
        .ai-details-section { 
            max-height: 0; 
            opacity: 0; 
            overflow: hidden; 
            transition: max-height 0.5s ease-in-out, opacity 0.3s ease-in-out, margin-top 0.5s ease-in-out, padding-top 0.5s ease-in-out, border-top-width 0.5s ease-in-out; 
            border-top-width: 0; 
            border-top-style: solid; 
            border-color: var(--border-primary); 
        }
        .ai-details-section.expanded { 
            max-height: 2000px; 
            opacity: 1; 
            margin-top: 1rem; 
            padding-top: 1rem; 
            border-top-width: 1px; 
        }
        .quick-nav-container { 
            background-color: var(--bg-secondary); 
            -webkit-backdrop-filter: blur(8px);
            backdrop-filter: blur(8px); 
            border-bottom: 1px solid var(--border-primary);
            opacity: 0.95;
        }
        /* 优化：改进快速导航栏布局 */
        .quick-nav .year-group { display: flex; align-items: center; flex-wrap: wrap; margin-bottom: 0.25rem; }
        .quick-nav .year-label { 
            font-weight: 700; 
            color: var(--text-primary); 
            padding: 0.5rem 0.75rem; 
            background-color: var(--bg-tertiary); 
            border-radius: 0.375rem; 
            margin-right: 0.75rem; 
        }
        .quick-nav .month-btn { 
            padding: 0.5rem 0.75rem; 
            margin: 0.25rem; 
            border-radius: 0.375rem; 
            font-weight: 500; 
            color: var(--text-secondary); 
            transition: background-color 0.2s, color 0.2s; 
            cursor: pointer; 
            border: 1px solid transparent;
        }
        .quick-nav .month-btn:hover { 
            background-color: var(--bg-tertiary); 
            color: var(--accent-primary); 
            border-color: var(--border-secondary);
        }
        .quick-nav .month-btn.active { 
            background-color: var(--accent-primary); 
            color: white; 
            font-weight: 600; 
        }
        .highlight { 
            background-color: var(--highlight-bg); 
            color: var(--highlight-text); 
            font-weight: bold; 
            padding: 1px 2px; 
            border-radius: 3px; 
        }
        /* 优化：为直接链接的论文添加高亮效果 */
        .highlight-shared-paper { 
            background-color: var(--bg-tertiary); 
            border-color: var(--accent-primary); 
            box-shadow: 0 0 0 2px var(--accent-secondary);
        }
        
        /* 新增：深色模式切换按钮 */
        .theme-toggle {
            background-color: var(--bg-tertiary);
            border: 1px solid var(--border-primary);
            color: var(--text-primary);
            padding: 0.5rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .theme-toggle:hover {
            background-color: var(--bg-secondary);
            border-color: var(--accent-primary);
        }
        
        /* 新增：搜索建议样式 */
        .search-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-primary);
            border-top: none;
            border-radius: 0 0 0.5rem 0.5rem;
            box-shadow: 0 10px 15px -3px var(--shadow-light);
            max-height: 300px;
            overflow-y: auto;
            z-index: 50;
            display: none;
        }
        .search-suggestions.visible { display: block; }
        .suggestion-item {
            padding: 0.75rem 1rem;
            cursor: pointer;
            border-bottom: 1px solid var(--border-primary);
            transition: background-color 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .suggestion-item:hover, .suggestion-item.highlighted {
            background-color: var(--bg-tertiary);
        }
        .suggestion-item:last-child { border-bottom: none; }
        .suggestion-type {
            font-size: 0.75rem;
            color: var(--text-tertiary);
            background-color: var(--bg-tertiary);
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
        }
        
        /* 新增：搜索历史 */
        .search-history {
            background-color: var(--bg-tertiary);
            padding: 0.5rem;
            margin-bottom: 0.5rem;
            border-radius: 0.375rem;
        }
        .search-history-title {
            font-size: 0.75rem;
            color: var(--text-tertiary);
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .search-history-item {
            display: inline-block;
            background-color: var(--bg-secondary);
            color: var(--text-secondary);
            padding: 0.25rem 0.5rem;
            margin: 0.125rem;
            border-radius: 0.25rem;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .search-history-item:hover {
            background-color: var(--accent-primary);
            color: white;
        }
        
        /* 新增：论文标签系统 */
        .paper-tags {
            margin-top: 0.5rem;
            display: flex;
            flex-wrap: wrap;
            gap: 0.25rem;
        }
        .custom-tag {
            background-color: var(--accent-secondary);
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }
        .tag-remove {
            cursor: pointer;
            opacity: 0.7;
            transition: opacity 0.2s ease;
        }
        .tag-remove:hover { opacity: 1; }
        
        /* 新增：论文笔记 */
        .paper-notes {
            background-color: var(--bg-tertiary);
            border: 1px solid var(--border-primary);
            border-radius: 0.375rem;
            padding: 0.75rem;
            margin-top: 0.5rem;
            display: none;
        }
        .paper-notes.visible { display: block; }
        .notes-textarea {
            width: 100%;
            min-height: 80px;
            padding: 0.5rem;
            border: 1px solid var(--border-primary);
            border-radius: 0.25rem;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            resize: vertical;
            font-family: inherit;
        }
        .notes-textarea:focus {
            outline: none;
            border-color: var(--accent-primary);
        }
        
        /* 新增：评分系统 */
        .paper-rating {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            margin-top: 0.5rem;
        }
        .star-rating {
            display: flex;
            gap: 0.125rem;
        }
        .star {
            cursor: pointer;
            color: var(--text-tertiary);
            transition: color 0.2s ease;
            font-size: 1.25rem;
        }
        .star:hover, .star.active {
            color: #fbbf24;
        }
        
        /* 新增：阅读进度指示器 */
        .reading-progress {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background-color: var(--bg-tertiary);
            z-index: 100;
        }
        .reading-progress-bar {
            height: 100%;
            background-color: var(--accent-primary);
            width: 0%;
            transition: width 0.1s ease;
        }
        .back-to-top-btn { 
            position: fixed; 
            bottom: 2rem; 
            right: 2rem; 
            background-color: var(--accent-primary); 
            color: white; 
            width: 3rem; 
            height: 3rem; 
            border-radius: 50%; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            cursor: pointer; 
            opacity: 0; 
            transform: translateY(100px); 
            transition: opacity 0.3s ease, transform 0.3s ease, background-color 0.2s ease; 
            z-index: 50; 
            box-shadow: 0 4px 6px var(--shadow-light);
            border: none;
            outline: none;
        }
        .back-to-top-btn.visible { opacity: 0.8; transform: translateY(0); }
        .back-to-top-btn:hover { opacity: 1; background-color: var(--accent-secondary); }
        .back-to-top-btn:focus {
            outline: 2px solid var(--accent-primary);
            outline-offset: 2px;
        }
        
        .skeleton-card { 
            background-color: var(--bg-secondary); 
            padding: 1.5rem; 
            border-radius: 0.5rem; 
            box-shadow: 0 4px 6px -1px var(--shadow-light), 0 2px 4px -2px var(--shadow-dark); 
            border: 1px solid var(--border-primary); 
        }
        .skeleton { background-color: var(--border-primary); border-radius: 0.25rem; } 
        .skeleton.h-4 { height: 1rem; }
        .skeleton.w-1\/4 { width: 25%; } 
        .skeleton.w-1\/2 { width: 50%; } 
        .skeleton.w-3\/4 { width: 75%; } 
        .skeleton.w-full { width: 100%; }
        @keyframes pulse { 50% { opacity: .5; } } 
        .skeleton-animate { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        
        .favorite-btn { 
            color: var(--text-tertiary); 
            transition: color 0.2s, transform 0.2s; 
            border: none;
            background: none;
            cursor: pointer;
            padding: 0.25rem;
            border-radius: 0.25rem;
        }
        .favorite-btn:hover { color: #facc15; transform: scale(1.1); } 
        .favorite-btn.favorited { color: #f59e0b; }
        .favorite-btn:focus {
            outline: 2px solid var(--accent-primary);
            outline-offset: 2px;
        }

        /* --- 最终UI/UX打磨 --- */
        header { padding-bottom: 1rem; }
        .view-toggle { 
            display: flex; 
            align-items: center; 
            background-color: var(--bg-tertiary); 
            border-radius: 9999px; 
            padding: 2px; 
            cursor: pointer; 
        }
        .view-toggle button { 
            padding: 0.25rem 0.75rem; 
            border-radius: 9999px; 
            font-size: 0.875rem; 
            font-weight: 500; 
            color: var(--text-secondary); 
            transition: all 0.2s ease; 
            border: none; 
            background-color: transparent; 
            cursor: pointer;
        }
        .view-toggle button.active { 
            background-color: var(--bg-secondary); 
            color: var(--accent-primary); 
            box-shadow: 0 1px 3px var(--shadow-light); 
        }
        .view-toggle button:focus {
            outline: 2px solid var(--accent-primary);
            outline-offset: 2px;
        }
        
        .compact-view .compact-hidden { display: none; }
        .compact-view .paper-card { padding: 1rem; }
        .compact-view .paper-card h2 { font-size: 1.125rem; }
        .compact-view .paper-card h3 { font-size: 1rem; margin-bottom: 0.5rem;}
        
        /* 新增：分享按钮样式 */
        .share-btn { 
            color: var(--text-tertiary); 
            transition: color 0.2s, transform 0.2s; 
            border: none;
            background: none;
            cursor: pointer;
            padding: 0.25rem;
            border-radius: 0.25rem;
        }
        .share-btn:hover { color: var(--accent-primary); transform: scale(1.1); }
        .share-btn:focus {
            outline: 2px solid var(--accent-primary);
            outline-offset: 2px;
        }
        
        /* 新增：Toast通知样式 */
        .toast { 
            position: fixed; 
            top: -100px; 
            left: 50%; 
            transform: translateX(-50%); 
            background-color: #22c55e; 
            color: white; 
            padding: 1rem 2rem; 
            border-radius: 0.5rem; 
            box-shadow: 0 4px 15px var(--shadow-dark); 
            transition: top 0.5s ease-in-out; 
            z-index: 100; 
        }
        .toast.show { top: 2rem; }
        .toast.error { background-color: #ef4444; }
        .toast.warning { background-color: #f59e0b; }
        
        /* 新增：分类筛选器样式 */
        .category-filter-btn { 
            padding: 0.5rem 1rem; 
            border: 1px solid var(--border-secondary); 
            border-radius: 9999px; 
            font-size: 0.875rem; 
            font-weight: 500; 
            color: var(--text-secondary); 
            cursor: pointer; 
            transition: all 0.2s ease;
            background-color: var(--bg-secondary);
        }
        .category-filter-btn:hover { 
            background-color: var(--bg-tertiary); 
            border-color: var(--text-tertiary); 
        }
        .category-filter-btn.active { 
            background-color: var(--accent-primary); 
            color: white; 
            border-color: var(--accent-primary); 
        }
        .category-filter-btn:focus {
            outline: 2px solid var(--accent-primary);
            outline-offset: 2px;
        }
        
        /* 新增：日期筛选器样式 */
        .month-header { 
            font-size: 1.75rem; 
            font-weight: 700; 
            color: var(--text-primary); 
            padding: 2rem 0 1rem 0; 
            border-top: 1px solid var(--border-secondary); 
            margin-top: 2rem; 
        }
        .date-filter-btn { 
            padding: 0.375rem 0.75rem; 
            border: 1px solid var(--border-secondary); 
            border-radius: 0.375rem; 
            font-size: 0.875rem; 
            font-weight: 500; 
            color: var(--text-secondary); 
            cursor: pointer; 
            transition: all 0.2s ease;
            background-color: var(--bg-secondary);
        }
        .date-filter-btn:hover { 
            background-color: var(--bg-tertiary); 
            border-color: var(--text-tertiary); 
        }
        .date-filter-btn.active { 
            background-color: var(--accent-secondary); 
            color: white; 
            border-color: var(--accent-secondary); 
        }
        .date-filter-btn:focus {
            outline: 2px solid var(--accent-primary);
            outline-offset: 2px;
        }
        
        /* 优化：顶部加载进度条样式 */
        #progress-container { 
            position: fixed; 
            top: 0; 
            left: 0; 
            right: 0; 
            height: auto; 
            z-index: 101; 
            opacity: 0; 
            transform: translateY(-100%); 
            transition: opacity 0.3s, transform 0.3s; 
        }
        #progress-container.visible { opacity: 1; transform: translateY(0); }
        #top-loader { 
            width: 100%; 
            height: 4px; 
            background-color: var(--bg-tertiary); 
        }
        #top-loader-bar { 
            width: 0%; 
            height: 100%; 
            background-color: var(--accent-primary); 
            transition: width 0.3s ease; 
        }
        #progress-text { 
            background-color: rgba(0, 0, 0, 0.6); 
            color: white; 
            font-size: 0.875rem; 
            padding: 0.25rem 0.75rem; 
            border-radius: 0 0 0.375rem 0; 
        }
        
        /* 新增：信息框颜色类 */
        .info-box-yellow { background-color: #fefce8; border-color: #facc15; }
        .info-box-yellow .info-box-title { color: #a16207; }
        .info-box-yellow p { color: #a16207; }
        
        .info-box-green { background-color: #f0fdf4; border-color: #22c55e; }
        .info-box-green .info-box-title { color: #15803d; }
        .info-box-green p { color: #15803d; }
        
        .info-box-indigo { background-color: #eef2ff; border-color: #6366f1; }
        .info-box-indigo .info-box-title { color: #4338ca; }
        .info-box-indigo p { color: #4338ca; }
        
        [data-theme="dark"] .info-box-yellow { background-color: #422006; border-color: #ca8a04; }
        [data-theme="dark"] .info-box-yellow .info-box-title { color: #fbbf24; }
        [data-theme="dark"] .info-box-yellow p { color: #fde047; }
        
        [data-theme="dark"] .info-box-green { background-color: #052e16; border-color: #059669; }
        [data-theme="dark"] .info-box-green .info-box-title { color: #34d399; }
        [data-theme="dark"] .info-box-green p { color: #6ee7b7; }
        
        [data-theme="dark"] .info-box-indigo { background-color: #1e1b4b; border-color: #8b5cf6; }
        [data-theme="dark"] .info-box-indigo .info-box-title { color: #a78bfa; }
        [data-theme="dark"] .info-box-indigo p { color: #c4b5fd; }
        
        /* 新增：键盘导航高亮 */
        .focus-visible {
            outline: 2px solid var(--accent-primary);
            outline-offset: 2px;
        }
        
        /* 新增：搜索栏容器修复内联样式问题 */
        .search-bar-container {
            position: sticky;
            z-index: 10;
            margin-bottom: 2rem;
            top: var(--nav-height, 8px);
        }
        
        /* 修复：更新卡片颜色 */
        .paper-card {
            background-color: var(--bg-secondary) !important;
            border-color: var(--border-primary) !important;
            color: var(--text-primary) !important;
        }
        
        /* 修复：搜索输入框样式 */
        #searchInput {
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            border-color: var(--border-primary);
        }
        
        #searchInput:focus {
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        /* ===== 用户引导和教程样式 ===== */
        
        /* 教程覆盖层 */
        .tutorial-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .tutorial-overlay.active {
            display: flex;
            opacity: 1;
        }
        
        /* 教程高亮区域 */
        .tutorial-highlight {
            position: absolute;
            background-color: transparent;
            border: 3px solid var(--accent-primary);
            border-radius: 8px;
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.7);
            z-index: 1001;
            pointer-events: none;
            transition: all 0.3s ease;
            animation: pulse-highlight 2s infinite;
        }
        
        @keyframes pulse-highlight {
            0%, 100% {
                border-color: var(--accent-primary);
                box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.7), 0 0 20px var(--accent-primary);
            }
            50% {
                border-color: var(--accent-secondary);
                box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.7), 0 0 30px var(--accent-secondary);
            }
        }
        
        /* 教程信息卡片 */
        .tutorial-card {
            position: fixed;
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3);
            max-width: 400px;
            width: 90%;
            z-index: 1002;
            transform: scale(0.9);
            opacity: 0;
            transition: all 0.3s ease;
            border: 1px solid var(--border-primary);
        }
        
        .tutorial-card.active {
            transform: scale(1);
            opacity: 1;
        }
        
        .tutorial-card h3 {
            color: var(--accent-primary);
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .tutorial-card p {
            color: var(--text-secondary);
            line-height: 1.6;
            margin-bottom: 1.5rem;
        }
        
        .tutorial-card .feature-list {
            list-style: none;
            padding: 0;
            margin: 1rem 0;
        }
        
        .tutorial-card .feature-list li {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0;
            color: var(--text-secondary);
        }
        
        .tutorial-card .feature-list .check-icon {
            color: #22c55e;
            font-weight: bold;
        }
        
        /* 教程按钮 */
        .tutorial-buttons {
            display: flex;
            gap: 0.75rem;
            justify-content: flex-end;
            margin-top: 1.5rem;
        }
        
        .tutorial-btn {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
            font-size: 0.875rem;
        }
        
        .tutorial-btn-primary {
            background-color: var(--accent-primary);
            color: white;
        }
        
        .tutorial-btn-primary:hover {
            background-color: var(--accent-secondary);
            transform: translateY(-1px);
        }
        
        .tutorial-btn-secondary {
            background-color: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-primary);
        }
        
        .tutorial-btn-secondary:hover {
            background-color: var(--bg-primary);
        }
        
        .tutorial-btn-skip {
            background-color: transparent;
            color: var(--text-tertiary);
            border: none;
            text-decoration: underline;
        }
        
        .tutorial-btn-skip:hover {
            color: var(--text-secondary);
        }
        
        /* 教程进度指示器 */
        .tutorial-progress {
            position: fixed;
            top: 2rem;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--bg-secondary);
            padding: 1rem 2rem;
            border-radius: 2rem;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            z-index: 1003;
            border: 1px solid var(--border-primary);
            display: none;
        }
        
        .tutorial-progress.active {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .tutorial-progress-bar {
            width: 150px;
            height: 6px;
            background-color: var(--bg-tertiary);
            border-radius: 3px;
            overflow: hidden;
        }
        
        .tutorial-progress-fill {
            height: 100%;
            background-color: var(--accent-primary);
            transition: width 0.3s ease;
            border-radius: 3px;
        }
        
        .tutorial-progress-text {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        /* 功能提示气泡 */
        .feature-tooltip {
            position: absolute;
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            font-size: 0.875rem;
            z-index: 100;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease, transform 0.3s ease;
            border: 1px solid var(--border-primary);
            max-width: 250px;
            white-space: pre-wrap;
        }
        
        .feature-tooltip.show {
            opacity: 1;
            transform: translateY(-5px);
        }
        
        .feature-tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-top-color: var(--bg-secondary);
        }
        
        .feature-tooltip.tooltip-bottom::after {
            top: -12px;
            border-top-color: transparent;
            border-bottom-color: var(--bg-secondary);
        }
        
        /* 热门关键词展示 */
        .popular-keywords {
            background-color: var(--bg-tertiary);
            border-radius: 0.75rem;
            padding: 1rem;
            margin-bottom: 1rem;
            border: 1px solid var(--border-primary);
        }
        
        .popular-keywords h4 {
            color: var(--text-primary);
            font-size: 0.875rem;
            font-weight: 600;
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .popular-keywords-list {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        
        .popular-keyword {
            background-color: var(--bg-secondary);
            color: var(--text-secondary);
            padding: 0.375rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid var(--border-primary);
        }
        
        .popular-keyword:hover {
            background-color: var(--accent-primary);
            color: white;
            border-color: var(--accent-primary);
            transform: translateY(-1px);
        }
        
        /* 功能介绍卡片 */
        .welcome-card {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            color: white;
            padding: 2rem;
            border-radius: 1rem;
            margin-bottom: 2rem;
            position: relative;
            overflow: hidden;
        }
        
        .welcome-card::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 100%;
            height: 100%;
            background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cpath d='M20 20h60v60H20z' fill='none' stroke='rgba(255,255,255,0.1)' stroke-width='1'/%3E%3C/svg%3E") repeat;
            animation: float 20s linear infinite;
        }
        
        @keyframes float {
            0% { transform: translateX(0) translateY(0); }
            100% { transform: translateX(-50px) translateY(-50px); }
        }
        
        .welcome-card h2 {
            font-size: 1.75rem;
            font-weight: 800;
            margin-bottom: 1rem;
            position: relative;
            z-index: 1;
        }
        
        .welcome-card p {
            font-size: 1rem;
            opacity: 0.9;
            line-height: 1.6;
            margin-bottom: 1.5rem;
            position: relative;
            z-index: 1;
        }
        
        .welcome-actions {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            position: relative;
            z-index: 1;
        }
        
        .welcome-btn {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
            font-size: 0.875rem;
        }
        
        .welcome-btn-primary {
            background-color: white;
            color: var(--accent-primary);
        }
        
        .welcome-btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        
        .welcome-btn-secondary {
            background-color: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        .welcome-btn-secondary:hover {
            background-color: rgba(255, 255, 255, 0.3);
        }
        
        /* 快速功能访问面板 */
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .quick-action-card {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-primary);
            border-radius: 0.75rem;
            padding: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }
        
        .quick-action-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            border-color: var(--accent-primary);
        }
        
        .quick-action-icon {
            width: 3rem;
            height: 3rem;
            margin: 0 auto 1rem;
            background-color: var(--accent-primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
        }
        
        .quick-action-title {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }
        
        .quick-action-desc {
            font-size: 0.875rem;
            color: var(--text-secondary);
            line-height: 1.4;
        }
        
        /* 首次访问检测和状态 */
        .first-visit-indicator {
            position: fixed;
            top: -100px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #10b981;
            color: white;
            padding: 1rem 2rem;
            border-radius: 0.5rem;
            font-weight: 600;
            z-index: 200;
            transition: top 0.5s ease;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
        }
        
        .first-visit-indicator.show {
            top: 2rem;
        }
        
        /* 移动端教程优化 */
        @media (max-width: 768px) {
            .tutorial-card {
                width: 95%;
                padding: 1.5rem;
                border-radius: 0.75rem;
                max-width: none;
                position: fixed !important;
                top: 50% !important;
                left: 50% !important;
                transform: translate(-50%, -50%) !important;
            }
            
            .tutorial-card h3 {
                font-size: 1.125rem;
            }
            
            .tutorial-buttons {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .tutorial-btn {
                width: 100%;
                justify-content: center;
                display: flex;
                min-height: 44px;
            }
            
            .tutorial-progress {
                top: 1rem;
                width: 90%;
                padding: 0.75rem 1rem;
            }
            
            .tutorial-progress-bar {
                width: 100px;
            }
            
            .tutorial-highlight {
                border-width: 2px;
                animation: none; /* 在移动端禁用动画以提高性能 */
            }
            
            .welcome-card {
                padding: 1.5rem;
                text-align: center;
            }
            
            .welcome-card h2 {
                font-size: 1.5rem;
            }
            
            .welcome-actions {
                justify-content: center;
                flex-direction: column;
                gap: 0.75rem;
            }
            
            .welcome-btn {
                width: 100%;
                min-height: 44px;
                justify-content: center;
                display: flex;
                align-items: center;
            }
            
            .quick-actions {
                grid-template-columns: 1fr;
                gap: 0.75rem;
            }
            
            .quick-action-card {
                padding: 1rem;
            }
            
            .quick-action-card:active {
                transform: scale(0.98);
            }
            
            .feature-tooltip {
                max-width: 200px;
                font-size: 0.75rem;
                position: fixed !important;
                top: auto !important;
                bottom: 6rem !important;
                left: 1rem !important;
                right: 1rem !important;
                transform: none !important;
                text-align: center;
            }
            
            .feature-tooltip::after {
                display: none; /* 隐藏箭头 */
            }
            
            .popular-keywords {
                margin-bottom: 0.75rem;
            }
            
            .popular-keyword {
                min-height: 36px;
                padding: 0.5rem 0.75rem;
                font-size: 0.875rem;
                display: inline-flex;
                align-items: center;
                justify-content: center;
            }
        }
        
        /* 无障碍和可访问性优化 */
        .tutorial-overlay:focus-within {
            outline: none;
        }
        
        .tutorial-btn:focus,
        .welcome-btn:focus,
        .quick-action-card:focus {
            outline: 2px solid var(--accent-primary);
            outline-offset: 2px;
        }
        
        /* 减少动画的用户偏好 */
        @media (prefers-reduced-motion: reduce) {
            .tutorial-highlight,
            .tutorial-card,
            .feature-tooltip,
            .welcome-card::before {
                animation: none;
                transition: none;
            }
        }
        
        /* 深色模式下的教程样式优化 */
        [data-theme="dark"] .tutorial-overlay {
            background-color: rgba(0, 0, 0, 0.8);
        }
        
        [data-theme="dark"] .tutorial-highlight {
            border-color: var(--accent-secondary);
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.8), 0 0 30px var(--accent-secondary);
        }
        
        [data-theme="dark"] .welcome-card {
            background: linear-gradient(135deg, #1e40af, #3b82f6);
        }
        
        [data-theme="dark"] .first-visit-indicator {
            background-color: #059669;
            box-shadow: 0 4px 15px rgba(5, 150, 105, 0.4);
        }
        
        /* 修复：按钮样式 */
        .paper-card button {
            background-color: transparent;
            border: none;
        }
        
        .paper-card a {
            color: inherit;
        }
        
        [data-theme="dark"] .paper-card a:hover {
            color: var(--accent-primary);
        }
        
        /* 新增：AI分析按钮样式 */
        .ai-toggle-btn {
            background-color: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-primary);
            transition: all 0.2s ease;
        }
        
        .ai-toggle-btn:hover {
            background-color: var(--accent-primary);
            color: white;
            border-color: var(--accent-primary);
        }
        
        /* 新增：论文标题样式 */
        .paper-title {
            color: var(--text-primary) !important;
        }
        
        .paper-title-zh {
            color: var(--accent-primary) !important;
        }
        
        /* 新增：AI分析标题样式 */
        .ai-analysis-title {
            color: var(--text-primary) !important;
        }
        
        /* 新增：论文链接样式 */
        .paper-link-abstract {
            color: #3b82f6;
            transition: color 0.2s ease;
        }
        
        .paper-link-abstract:hover {
            color: #1d4ed8;
        }
        
        .paper-link-pdf {
            color: #ef4444;
            transition: color 0.2s ease;
        }
        
        .paper-link-pdf:hover {
            color: #dc2626;
        }
        
        [data-theme="dark"] .paper-link-abstract {
            color: #60a5fa;
        }
        
        [data-theme="dark"] .paper-link-abstract:hover {
            color: #93c5fd;
        }
        
        [data-theme="dark"] .paper-link-pdf {
            color: #f87171;
        }
        
        [data-theme="dark"] .paper-link-pdf:hover {
            color: #fca5a5;
        }
        
        /* ===== 移动端优化样式 ===== */
        
        /* 基础响应式设置 */
        @media (max-width: 768px) {
            /* 容器和间距优化 */
            .container {
                padding-left: 1rem;
                padding-right: 1rem;
            }
            
            /* 标题优化 */
            header h1 {
                font-size: 1.75rem;
                line-height: 1.2;
            }
            
            /* 快速导航栏移动端优化 */
            .quick-nav {
                flex-direction: column;
                gap: 0.75rem;
                align-items: stretch;
            }
            
            .quick-nav .year-group {
                flex-direction: column;
                align-items: stretch;
                gap: 0.5rem;
                margin-bottom: 0.5rem;
            }
            
            .quick-nav .year-label {
                text-align: center;
                font-size: 0.875rem;
                padding: 0.375rem 0.5rem;
            }
            
            .quick-nav .month-btn {
                min-height: 44px; /* 触摸目标最小尺寸 */
                padding: 0.75rem;
                font-size: 0.875rem;
                text-align: center;
                margin: 0.125rem;
                border: 2px solid transparent;
                position: relative;
                overflow: hidden;
            }
            
            /* 触摸反馈涟漪效果 */
            .month-btn::before {
                content: '';
                position: absolute;
                top: 50%;
                left: 50%;
                width: 0;
                height: 0;
                background: rgba(59, 130, 246, 0.3);
                border-radius: 50%;
                transform: translate(-50%, -50%);
                transition: width 0.3s, height 0.3s;
                pointer-events: none;
            }
            
            .month-btn:active::before {
                width: 300px;
                height: 300px;
            }
            
            /* 工具栏移动端优化 */
            .quick-nav .flex.items-center {
                flex-direction: column;
                gap: 0.5rem;
                width: 100%;
            }
            
            .view-toggle {
                width: 100%;
                justify-content: center;
            }
            
            .view-toggle button {
                flex: 1;
                min-height: 44px;
                padding: 0.75rem 1rem;
            }
            
            #show-favorites-btn {
                width: 100%;
                min-height: 44px;
                justify-content: center;
                padding: 0.75rem 1rem;
            }
        }
        
        /* 移动端导航栏汉堡菜单 */
        @media (max-width: 640px) {
            .mobile-nav-toggle {
                display: block;
                background: none;
                border: none;
                font-size: 1.5rem;
                padding: 0.5rem;
                cursor: pointer;
                color: var(--text-primary);
                min-height: 44px;
                min-width: 44px;
            }
            
            .mobile-nav-content {
                display: none;
                position: absolute;
                top: 100%;
                left: 0;
                right: 0;
                background-color: var(--bg-secondary);
                border: 1px solid var(--border-primary);
                border-radius: 0.5rem;
                margin-top: 0.5rem;
                padding: 1rem;
                box-shadow: 0 10px 25px var(--shadow-dark);
                z-index: 50;
            }
            
            .mobile-nav-content.active {
                display: block;
            }
            
            .quick-nav-container {
                position: relative;
            }
            
            /* 隐藏桌面端导航 */
            .hidden.md\\:flex {
                display: none !important;
            }
        }
        
        /* 桌面端隐藏移动端元素 */
        @media (min-width: 769px) {
            .mobile-nav-toggle {
                display: none;
            }
            
            .mobile-nav-content {
                display: none !important;
            }
            
            .md\\:hidden {
                display: none !important;
            }
        }
        
        /* 搜索框移动端优化 */
        @media (max-width: 768px) {
            #searchInput {
                font-size: 1rem; /* 防止iOS缩放 */
                padding: 1rem;
                min-height: 44px;
            }
            
            .search-suggestions {
                max-height: 200px;
                border-radius: 0.5rem;
            }
            
            .suggestion-item {
                padding: 1rem;
                min-height: 44px;
                display: flex;
                align-items: center;
            }
            
            .search-history-panel {
                border-radius: 0.5rem;
                margin-bottom: 1rem;
            }
            
            .search-history-item {
                min-height: 36px;
                padding: 0.5rem 0.75rem;
                margin: 0.25rem;
                display: inline-flex;
                align-items: center;
            }
        }
        
        /* 论文卡片移动端优化 */
        @media (max-width: 768px) {
            .paper-card {
                padding: 1rem;
                margin-bottom: 1rem;
                border-radius: 0.75rem;
            }
            
            .paper-card h2 {
                font-size: 1.125rem;
                line-height: 1.4;
                margin-bottom: 0.75rem;
            }
            
            .paper-card h3 {
                font-size: 1rem;
                margin-bottom: 0.5rem;
            }
            
            .paper-card .flex.justify-between {
                flex-direction: column;
                align-items: stretch;
                gap: 0.75rem;
            }
            
            .paper-card .flex.items-center.space-x-2 {
                justify-content: space-between;
                margin-top: 0.5rem;
            }
            
            .paper-card button,
            .paper-card a {
                min-height: 44px;
                min-width: 44px;
                display: inline-flex;
                align-items: center;
                justify-content: center;
                padding: 0.75rem;
                border-radius: 0.5rem;
                transition: all 0.2s ease;
            }
            
            /* 分类和关键词标签优化 */
            .keyword-tag {
                font-size: 0.75rem;
                padding: 0.5rem 0.75rem;
                margin: 0.125rem;
                min-height: 32px;
                display: inline-flex;
                align-items: center;
            }
            
            /* AI分析按钮优化 */
            .ai-toggle-btn {
                width: 100%;
                min-height: 44px;
                margin-top: 0.75rem;
            }
            
            /* 论文链接优化 */
            .paper-card .flex.items-center.space-x-4 {
                flex-direction: column;
                gap: 0.75rem;
                align-items: stretch;
            }
            
            .paper-card .flex.items-center.space-x-4 a {
                text-align: center;
                padding: 0.75rem 1rem;
                border: 1px solid var(--border-primary);
                border-radius: 0.5rem;
                font-weight: 600;
                transition: all 0.2s ease;
            }
            
            .paper-link-abstract {
                background-color: rgba(59, 130, 246, 0.1);
            }
            
            .paper-link-pdf {
                background-color: rgba(239, 68, 68, 0.1);
            }
        }
        
        /* 收藏按钮移动端优化 */
        @media (max-width: 768px) {
            .favorite-btn {
                min-height: 44px;
                min-width: 44px;
                padding: 0.75rem;
                border-radius: 0.5rem;
                background-color: var(--bg-tertiary);
                transition: all 0.2s ease;
            }
            
            .favorite-btn:active {
                transform: scale(0.95);
                background-color: var(--accent-primary);
                color: white;
            }
        }
        
        /* 分类筛选器移动端优化 */
        @media (max-width: 768px) {
            .category-filter-btn {
                min-height: 44px;
                padding: 0.75rem 1rem;
                font-size: 0.875rem;
                margin: 0.25rem;
                flex-shrink: 0;
            }
            
            #category-filters {
                overflow-x: auto;
                padding-bottom: 0.5rem;
            }
            
            #category-filters::-webkit-scrollbar {
                height: 4px;
            }
            
            #category-filters::-webkit-scrollbar-track {
                background: var(--bg-tertiary);
                border-radius: 2px;
            }
            
            #category-filters::-webkit-scrollbar-thumb {
                background: var(--accent-primary);
                border-radius: 2px;
            }
        }
        
        /* 日期筛选器移动端优化 */
        @media (max-width: 768px) {
            .date-filter-btn {
                min-height: 40px;
                padding: 0.5rem 0.75rem;
                font-size: 0.875rem;
                margin: 0.125rem;
            }
            
            .flex.flex-wrap.items-center.gap-2 {
                overflow-x: auto;
                flex-wrap: nowrap;
                padding-bottom: 0.5rem;
            }
        }
        
        /* 返回顶部按钮移动端优化 */
        @media (max-width: 768px) {
            .back-to-top-btn {
                bottom: 1rem;
                right: 1rem;
                width: 3.5rem;
                height: 3.5rem;
                box-shadow: 0 8px 25px var(--shadow-dark);
            }
        }
        
        /* Toast通知移动端优化 */
        @media (max-width: 768px) {
            .toast {
                left: 1rem;
                right: 1rem;
                transform: none;
                border-radius: 0.75rem;
                padding: 1rem;
                font-size: 0.875rem;
            }
            
            .toast.show {
                top: 1rem;
            }
        }
        
        /* 底部导航栏（移动端专用） */
        @media (max-width: 768px) {
            .mobile-bottom-nav {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                background-color: var(--bg-secondary);
                border-top: 1px solid var(--border-primary);
                padding: 0.75rem 1rem;
                display: flex;
                justify-content: space-around;
                align-items: center;
                z-index: 40;
                box-shadow: 0 -4px 10px var(--shadow-light);
            }
            
            .mobile-bottom-nav button {
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 0.25rem;
                background: none;
                border: none;
                color: var(--text-secondary);
                font-size: 0.75rem;
                font-weight: 500;
                padding: 0.5rem;
                border-radius: 0.5rem;
                transition: all 0.2s ease;
                min-height: 44px;
                min-width: 44px;
            }
            
            .mobile-bottom-nav button.active {
                color: var(--accent-primary);
                background-color: rgba(59, 130, 246, 0.1);
            }
            
            .mobile-bottom-nav svg {
                width: 1.25rem;
                height: 1.25rem;
            }
            
            .mobile-badge {
                position: absolute;
                top: -0.25rem;
                right: -0.25rem;
                background-color: #ef4444;
                color: white;
                font-size: 0.75rem;
                border-radius: 50%;
                height: 1.25rem;
                width: 1.25rem;
                display: flex;
                align-items: center;
                justify-content: center;
                font-weight: bold;
            }
            
            /* 为底部导航栏添加空间 */
            body {
                padding-bottom: 5rem;
            }
        }
        
        /* 手势操作支持 */
        @media (max-width: 768px) {
            .swipe-container {
                touch-action: pan-x;
                position: relative;
                overflow: hidden;
            }
            
            .swipe-indicator {
                position: fixed;
                top: 50%;
                transform: translateY(-50%);
                background-color: var(--accent-primary);
                color: white;
                padding: 1rem;
                border-radius: 0.5rem;
                font-size: 0.875rem;
                font-weight: 600;
                opacity: 0;
                transition: opacity 0.2s ease;
                z-index: 60;
                pointer-events: none;
            }
            
            .swipe-indicator.left {
                left: 1rem;
            }
            
            .swipe-indicator.right {
                right: 1rem;
            }
            
            .swipe-indicator.show {
                opacity: 0.9;
            }
        }
        
        /* 加载状态移动端优化 */
        @media (max-width: 768px) {
            #progress-container {
                font-size: 0.875rem;
            }
            
            #progress-text {
                padding: 0.5rem 0.75rem;
                border-radius: 0 0 0.5rem 0;
            }
            
            .skeleton-card {
                padding: 1rem;
                margin-bottom: 1rem;
            }
        }
        
        /* 搜索信息移动端优化 */
        @media (max-width: 768px) {
            #search-info {
                font-size: 1rem;
                padding: 0.75rem;
                background-color: var(--bg-tertiary);
                border-radius: 0.5rem;
                margin-bottom: 1rem;
            }
        }
        
        /* 月份标题移动端优化 */
        @media (max-width: 768px) {
            .month-header {
                font-size: 1.5rem;
                padding: 1.5rem 0 0.75rem 0;
                text-align: center;
            }
        }
        
        /* 修复移动端特定问题 */
        @media (max-width: 768px) {
            /* 防止横向滚动 */
            .container {
                overflow-x: hidden;
            }
            
            /* 优化文本选择 */
            .paper-card {
                -webkit-user-select: text;
                user-select: text;
            }
            
            /* 优化滚动性能 */
            html {
                scroll-behavior: smooth;
            }
            
            /* 提升触摸反馈 */
            button:active,
            .keyword-tag:active,
            .suggestion-item:active {
                transform: scale(0.98);
                opacity: 0.8;
            }
        }
    </style>
</head>
<body class="text-gray-800" data-theme="light">

<!-- 新增：阅读进度指示器 -->
<div class="reading-progress">
    <div class="reading-progress-bar" id="reading-progress-bar"></div>
</div>

<!-- 新增：带文本的顶部加载进度条 -->
<div id="progress-container">
    <div class="flex justify-end"><span id="progress-text"></span></div>
    <div id="top-loader"><div id="top-loader-bar"></div></div>
</div>

<div class="container mx-auto px-4 py-8">
    
    <header class="text-center mb-4">
        <div class="flex justify-between items-center mb-4">
            <div></div>
            <h1 class="text-4xl font-bold text-gray-900">AI论文每日速览</h1>
            <button id="theme-toggle" class="theme-toggle" aria-label="切换主题模式" title="切换深色/浅色模式">
                <svg id="theme-icon-light" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" clip-rule="evenodd" />
                </svg>
                <svg id="theme-icon-dark" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 hidden" viewBox="0 0 20 20" fill="currentColor">
                    <path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z" />
                </svg>
            </button>
        </div>
        <p id="last-updated" class="text-sm text-gray-500 mt-2"></p>
        
        <!-- 帮助按钮 -->
        <div class="flex justify-center items-center gap-4 mt-4">
            <button id="help-btn" class="flex items-center gap-2 px-4 py-2 bg-blue-50 text-blue-600 rounded-lg hover:bg-blue-100 transition" title="查看使用帮助">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <span class="text-sm font-medium">使用帮助</span>
            </button>
            <button id="tutorial-btn" class="flex items-center gap-2 px-4 py-2 bg-green-50 text-green-600 rounded-lg hover:bg-green-100 transition" title="开始新手教程">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
                </svg>
                <span class="text-sm font-medium">新手教程</span>
            </button>
        </div>
    </header>

    <!-- 优化：改进快速导航栏HTML结构以获得更好的响应式效果 -->
    <div id="quick-nav-container" class="sticky top-0 z-20 py-2 mb-8 quick-nav-container">
        <nav id="quick-nav" class="quick-nav px-4">
            <!-- 移动端汉堡菜单按钮 -->
            <div class="flex justify-between items-center md:hidden mb-2">
                <h2 class="text-lg font-semibold text-gray-800">月份导航</h2>
                <button id="mobile-nav-toggle" class="mobile-nav-toggle" aria-label="展开/收起导航菜单">
                    <span id="hamburger-icon">☰</span>
                    <span id="close-icon" class="hidden">✕</span>
                </button>
            </div>
            
            <!-- 导航内容 -->
            <div id="mobile-nav-content" class="mobile-nav-content">
                <!-- 月份导航 -->
                <div id="month-nav-wrapper" class="mb-4"></div>
                
                <!-- 工具栏 -->
                <div class="flex flex-col gap-3 md:hidden">
                    <div class="view-toggle">
                        <button id="view-detailed-btn-mobile">详细视图</button>
                        <button id="view-compact-btn-mobile">紧凑视图</button>
                    </div>
                    <button id="show-favorites-btn-mobile" class="flex items-center justify-center space-x-2 px-3 py-2 bg-yellow-400 text-white font-semibold rounded-lg hover:bg-yellow-500 transition shadow min-h-[44px]">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" /></svg>
                        <span>我的收藏</span>
                        <span id="favorites-count-mobile" class="ml-1 bg-white text-yellow-500 text-xs font-bold rounded-full px-1.5 py-0.5"></span>
                    </button>
                </div>
            </div>
            
            <!-- 桌面端导航 -->
            <div class="hidden md:flex justify-between items-center flex-wrap gap-y-2">
                <!-- 月份导航（左侧，可伸展） -->
                <div id="month-nav-wrapper-desktop" class="flex-grow"></div>
                <!-- 工具栏（右侧，固定宽度） -->
                <div class="flex items-center gap-4 flex-shrink-0">
                    <div class="view-toggle">
                        <button id="view-detailed-btn">详细</button>
                        <button id="view-compact-btn">紧凑</button>
                    </div>
                    <div>
                        <button id="show-favorites-btn" class="flex items-center space-x-2 px-3 py-2 bg-yellow-400 text-white font-semibold rounded-lg hover:bg-yellow-500 transition shadow">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" /></svg>
                            <span>我的收藏</span><span id="favorites-count" class="ml-1 bg-white text-yellow-500 text-xs font-bold rounded-full px-1.5 py-0.5"></span>
                        </button>
                    </div>
                </div>
            </div>
        </nav>
    </div>

    <div id="search-bar-container" class="search-bar-container">
        <!-- 首次访问欢迎卡片 -->
        <div id="welcome-card" class="welcome-card hidden">
            <h2>欢迎使用 AI 论文每日速览！</h2>
            <p>探索最新的人工智能研究论文，获取中文AI增强摘要，发现科研前沿动态。</p>
            <div class="welcome-actions">
                <button id="start-tutorial" class="welcome-btn welcome-btn-primary">开始新手教程</button>
                <button id="explore-now" class="welcome-btn welcome-btn-secondary">直接探索</button>
            </div>
        </div>
        
        <!-- 快速功能访问面板 -->
        <div id="quick-actions" class="quick-actions hidden">
            <div class="quick-action-card" data-action="search">
                <div class="quick-action-icon">🔍</div>
                <div class="quick-action-title">智能搜索</div>
                <div class="quick-action-desc">搜索论文标题、作者、关键词或AI摘要</div>
            </div>
            <div class="quick-action-card" data-action="categories">
                <div class="quick-action-icon">📁</div>
                <div class="quick-action-title">分类浏览</div>
                <div class="quick-action-desc">按机器学习、计算机视觉等领域分类</div>
            </div>
            <div class="quick-action-card" data-action="favorites">
                <div class="quick-action-icon">⭐</div>
                <div class="quick-action-title">收藏管理</div>
                <div class="quick-action-desc">收藏感兴趣的论文，随时回顾</div>
            </div>
            <div class="quick-action-card" data-action="timeline">
                <div class="quick-action-icon">📅</div>
                <div class="quick-action-title">时间线浏览</div>
                <div class="quick-action-desc">按日期浏览历史论文数据</div>
            </div>
        </div>
        
        <!-- 热门关键词展示 -->
        <div id="popular-keywords" class="popular-keywords hidden">
            <h4>
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                </svg>
                热门关键词
            </h4>
            <div class="popular-keywords-list">
                <span class="popular-keyword" data-keyword="transformer">Transformer</span>
                <span class="popular-keyword" data-keyword="diffusion">Diffusion</span>
                <span class="popular-keyword" data-keyword="llm">LLM</span>
                <span class="popular-keyword" data-keyword="computer vision">Computer Vision</span>
                <span class="popular-keyword" data-keyword="reinforcement learning">Reinforcement Learning</span>
                <span class="popular-keyword" data-keyword="neural network">Neural Network</span>
                <span class="popular-keyword" data-keyword="deep learning">Deep Learning</span>
                <span class="popular-keyword" data-keyword="generative ai">Generative AI</span>
            </div>
        </div>
        
        <div class="relative">
            <!-- 搜索历史按钮 -->
            <div class="flex items-center gap-2 mb-2">
                <button id="search-history-toggle" class="text-sm text-gray-600 hover:text-gray-800 font-medium">
                    搜索历史
                </button>
            </div>
            
            <!-- 新增：搜索历史面板 -->
            <div id="search-history-panel" class="search-history hidden">
                <div class="search-history-title">
                    <span>搜索历史</span>
                    <button id="clear-history" class="text-xs text-red-600 hover:text-red-800">清除历史</button>
                </div>
                <div id="search-history-items"></div>
            </div>
            
            <input type="text" id="searchInput" placeholder="搜索论文或点击分类/关键词进行筛选..." 
                   class="w-full p-4 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition"
                   autocomplete="off">
                   
            <!-- 新增：搜索建议下拉框 -->
            <div id="search-suggestions" class="search-suggestions">
                <!-- 动态填充搜索建议 -->
            </div>
        </div>
    </div>

    <!-- 新增：分类筛选器容器 -->
    <div id="category-filter-container" class="mb-8 hidden">
        <div id="category-filters" class="flex flex-wrap items-center gap-2"></div>
    </div>
    
    <main id="main-content">
        <div id="search-info" class="mb-4 text-lg text-gray-700 hidden"></div>
        <div id="papers-container"></div>
        <div id="search-results-container" class="space-y-8 hidden"></div>
        <div id="skeleton-container" class="space-y-8 hidden"></div>
    </main>

    <div id="loader" class="flex justify-center items-center py-8 hidden">
        <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12"></div>
    </div>

    <div id="end-of-list-message" class="text-center py-8 text-gray-500 hidden">
        <p>已加载全部内容</p>
    </div>
</div>

<!-- 新增：可访问性优化 -->
<button id="back-to-top" class="back-to-top-btn" aria-label="返回顶部" title="返回页面顶部">
    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7" /></svg>
</button>

<!-- 新增：分享操作的Toast通知 -->
<div id="toast-notification" class="toast" role="alert"></div>

<!-- 用户引导和教程系统 -->
<div id="tutorial-overlay" class="tutorial-overlay">
    <!-- 教程高亮区域 -->
    <div id="tutorial-highlight" class="tutorial-highlight"></div>
    
    <!-- 教程进度指示器 -->
    <div id="tutorial-progress" class="tutorial-progress">
        <span id="tutorial-progress-text" class="tutorial-progress-text">步骤 1 / 6</span>
        <div class="tutorial-progress-bar">
            <div id="tutorial-progress-fill" class="tutorial-progress-fill"></div>
        </div>
    </div>
    
    <!-- 教程信息卡片 -->
    <div id="tutorial-card" class="tutorial-card">
        <h3 id="tutorial-title">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
            </svg>
            欢迎使用
        </h3>
        <p id="tutorial-content">
            欢迎来到 AI 论文每日速览！让我们通过简单的教程来了解主要功能。
        </p>
        <ul id="tutorial-features" class="feature-list">
            <li><span class="check-icon">✓</span> 搜索和筛选最新 AI 论文</li>
            <li><span class="check-icon">✓</span> 查看 AI 增强的中文摘要</li>
            <li><span class="check-icon">✓</span> 收藏和管理感兴趣的论文</li>
            <li><span class="check-icon">✓</span> 按分类和时间浏览论文</li>
        </ul>
        <div class="tutorial-buttons">
            <button id="tutorial-skip" class="tutorial-btn tutorial-btn-skip">跳过教程</button>
            <button id="tutorial-prev" class="tutorial-btn tutorial-btn-secondary">上一步</button>
            <button id="tutorial-next" class="tutorial-btn tutorial-btn-primary">开始教程</button>
        </div>
    </div>
</div>

<!-- 功能提示气泡 -->
<div id="feature-tooltip" class="feature-tooltip"></div>

<!-- 首次访问指示器 -->
<div id="first-visit-indicator" class="first-visit-indicator">
    🎉 欢迎首次访问！点击右上角的"新手教程"开始了解功能
</div>

<!-- 新增：移动端底部导航栏 -->
<div class="mobile-bottom-nav md:hidden">
    <button id="mobile-nav-home" class="active" data-action="scroll-to-top">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/>
        </svg>
        <span>首页</span>
    </button>
    
    <button id="mobile-nav-search" data-action="focus-search">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
        </svg>
        <span>搜索</span>
    </button>
    
    <button id="mobile-nav-favorites" data-action="show-favorites">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/>
        </svg>
        <span>收藏</span>
        <span id="mobile-favorites-badge" class="mobile-badge">0</span>
    </button>
    
    <button id="mobile-nav-menu" data-action="toggle-mobile-menu">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
        </svg>
        <span>菜单</span>
    </button>
</div>

<!-- 新增：手势操作提示 -->
<div id="swipe-indicator-left" class="swipe-indicator left">← 上一月</div>
<div id="swipe-indicator-right" class="swipe-indicator right">下一月 →</div>

<script>
    // --- 全局状态管理 ---
    const state = {
        manifest: null, searchIndex: null, categoryIndex: null, allPapers: new Map(),
        loadedMonths: new Set(), currentMonthIndex: -1, isFetching: false, isSearchMode: false,
        navObserver: null, currentQuery: '', favorites: new Set(), viewMode: 'detailed',
        mainCategories: ['cs.CV', 'cs.LG', 'cs.CL', 'cs.AI', 'cs.RO', 'stat.ML'],
        currentSearchResults: [], 
        activeCategoryFilter: 'all',
        activeDateFilters: new Map(),
        // 新增状态
        theme: 'light',
        searchHistory: [],
        searchSuggestions: [],
        searchHistoryVisible: false,
        currentSuggestionIndex: -1,
        paperTags: new Map(), // 用户自定义标签 paperID -> [tags]
        paperNotes: new Map(), // 论文笔记 paperID -> note
        paperRatings: new Map(), // 论文评分 paperID -> rating(1-5)
        favoriteGroups: new Map(), // 收藏夹分组 groupName -> Set<paperID>
        keyboardNavigation: {
            enabled: true,
            currentFocusIndex: -1,
            focusableElements: []
        },
        // 移动端状态
        mobile: {
            isMenuOpen: false,
            isTouchDevice: 'ontouchstart' in window,
            swipeThreshold: 50,
            touchStartX: 0,
            touchEndX: 0,
            isSwipeGestureActive: false
        },
        // 用户引导状态
        tutorial: {
            isActive: false,
            currentStep: 0,
            totalSteps: 6,
            isFirstVisit: false,
            hasSeenWelcome: false,
            steps: [
                {
                    target: 'header',
                    title: '欢迎使用 AI 论文每日速览',
                    content: '这里展示每日最新的 AI 研究论文，所有内容都配有 AI 增强的中文摘要，帮助您快速了解前沿研究。',
                    position: 'bottom'
                },
                {
                    target: '#searchInput',
                    title: '智能搜索功能',
                    content: '在这里输入关键词搜索论文。支持搜索论文标题、作者、摘要内容，还有智能搜索建议和历史记录。',
                    position: 'bottom'
                },
                {
                    target: '#quick-nav',
                    title: '时间导航',
                    content: '点击不同月份快速跳转到对应时间的论文。支持键盘导航和移动端手势操作。',
                    position: 'bottom'
                },
                {
                    target: '.paper-card:first-child',
                    title: '论文卡片功能',
                    content: '每张论文卡片包含原文摘要、AI 增强的中文摘要，以及收藏、分享等功能。点击"查看 AI 分析"展开详细解读。',
                    position: 'top'
                },
                {
                    target: '.view-toggle',
                    title: '视图切换',
                    content: '在详细视图和紧凑视图之间切换，根据您的阅读习惯选择最适合的展示方式。',
                    position: 'bottom'
                },
                {
                    target: '#theme-toggle',
                    title: '个性化设置',
                    content: '切换深色/浅色主题，支持系统主题跟随。所有设置都会自动保存。',
                    position: 'bottom'
                }
            ]
        },
        // 用户偏好设置
        userPreferences: {
            hasSeenTutorial: false,
            preferredTheme: 'system',
            defaultView: 'detailed',
            autoHideWelcome: false,
            showTooltips: true,
            enableKeyboardNav: true
        }
    };

    // --- DOM 元素引用 ---
    const mainContainer = document.getElementById('main-content');
    const papersContainer = document.getElementById('papers-container');
    const searchResultsContainer = document.getElementById('search-results-container');
    const skeletonContainer = document.getElementById('skeleton-container');
    const searchInput = document.getElementById('searchInput');
    const loader = document.getElementById('loader');
    const endOfListMessage = document.getElementById('end-of-list-message');
    const quickNavContainer = document.getElementById('quick-nav-container');
    const searchBarContainer = document.getElementById('search-bar-container');
    const backToTopBtn = document.getElementById('back-to-top');
    const lastUpdatedEl = document.getElementById('last-updated');
    const searchInfoEl = document.getElementById('search-info');
    const toastNotificationEl = document.getElementById('toast-notification');
    const categoryFilterContainer = document.getElementById('category-filter-container');
    const categoryFiltersEl = document.getElementById('category-filters');
    const progressContainer = document.getElementById('progress-container');
    const topLoaderBar = document.getElementById('top-loader-bar');
    const progressText = document.getElementById('progress-text');
    // DOM 元素引用
    const themeToggle = document.getElementById('theme-toggle');
    const themeIconLight = document.getElementById('theme-icon-light');
    const themeIconDark = document.getElementById('theme-icon-dark');
    const searchHistoryToggle = document.getElementById('search-history-toggle');
    const searchHistoryPanel = document.getElementById('search-history-panel');
    const searchSuggestions = document.getElementById('search-suggestions');
    const searchHistoryItems = document.getElementById('search-history-items');
    const readingProgressBar = document.getElementById('reading-progress-bar');
    
    // 移动端元素引用
    const mobileNavToggle = document.getElementById('mobile-nav-toggle');
    const mobileNavContent = document.getElementById('mobile-nav-content');
    const hamburgerIcon = document.getElementById('hamburger-icon');
    const closeIcon = document.getElementById('close-icon');
    const mobileBottomNav = document.querySelector('.mobile-bottom-nav');
    const swipeIndicatorLeft = document.getElementById('swipe-indicator-left');
    const swipeIndicatorRight = document.getElementById('swipe-indicator-right');
    
    // 用户引导元素引用
    const tutorialBtn = document.getElementById('tutorial-btn');
    const helpBtn = document.getElementById('help-btn');
    const welcomeCard = document.getElementById('welcome-card');
    const quickActions = document.getElementById('quick-actions');
    const popularKeywords = document.getElementById('popular-keywords');
    const tutorialOverlay = document.getElementById('tutorial-overlay');
    const tutorialCard = document.getElementById('tutorial-card');
    const tutorialHighlight = document.getElementById('tutorial-highlight');
    const tutorialProgress = document.getElementById('tutorial-progress');
    const tutorialTitle = document.getElementById('tutorial-title');
    const tutorialContent = document.getElementById('tutorial-content');
    const tutorialFeatures = document.getElementById('tutorial-features');
    const tutorialPrevBtn = document.getElementById('tutorial-prev');
    const tutorialNextBtn = document.getElementById('tutorial-next');
    const tutorialSkipBtn = document.getElementById('tutorial-skip');
    const tutorialProgressText = document.getElementById('tutorial-progress-text');
    const tutorialProgressFill = document.getElementById('tutorial-progress-fill');
    const featureTooltip = document.getElementById('feature-tooltip');
    const firstVisitIndicator = document.getElementById('first-visit-indicator');
    const startTutorialBtn = document.getElementById('start-tutorial');
    const exploreNowBtn = document.getElementById('explore-now');

    // --- 性能监控和内存管理 ---
    const performance = {
        startTime: 0,
        loadTimes: new Map(),
        memoryUsage: 0,
        
        startTracking(operation) {
            this.startTime = Date.now();
            console.log(`⏱️ Started: ${operation}`);
        },
        
        endTracking(operation) {
            const duration = Date.now() - this.startTime;
            this.loadTimes.set(operation, duration);
            console.log(`✅ Completed: ${operation} in ${duration}ms`);
            
            // 检查内存使用情况
            if (window.performance && window.performance.memory) {
                this.memoryUsage = window.performance.memory.usedJSHeapSize / 1024 / 1024;
                console.log(`🧠 Memory usage: ${this.memoryUsage.toFixed(1)}MB`);
                
                // 如果内存使用超过 200MB，建议用户刷新页面
                if (this.memoryUsage > 200) {
                    showToast('内存使用过高，建议刷新页面以获得更好性能', 'warning');
                }
            }
        },
        
        cleanup() {
            // 清理不可见的论文卡片以释放内存
            const cards = document.querySelectorAll('.paper-card');
            const viewportHeight = window.innerHeight;
            let cleanedCount = 0;
            
            cards.forEach(card => {
                const rect = card.getBoundingClientRect();
                // 如果卡片在视口外很远（超过3个屏幕高度），则清理其详细内容
                if (rect.bottom < -viewportHeight * 3 || rect.top > viewportHeight * 4) {
                    const paperId = card.id.replace('card-', '');
                    const detailsSection = card.querySelector('.ai-details-section');
                    if (detailsSection && detailsSection.innerHTML.length > 1000) {
                        detailsSection.innerHTML = '<p class="text-gray-500">内容已缓存以节省内存</p>';
                        cleanedCount++;
                    }
                }
            });
            
            if (cleanedCount > 0) {
                console.log(`🧹 Cleaned up ${cleanedCount} cards to save memory`);
            }
        }
    };

    // 每30秒执行一次内存清理
    setInterval(() => {
        if (!state.isFetching) {
            performance.cleanup();
        }
    }, 30000);

    // --- 工具函数 ---
    function escapeCQ(str) { return str ? String(str).replace(/'/g, "\\'") : ''; }
    function escapeRegex(string) { return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); }
    async function applyViewTransition(updateFunction, vtName = '') {
        if (!document.startViewTransition) {
            await updateFunction();
            return;
        }
        mainContainer.dataset.vtName = vtName;
        const transition = document.startViewTransition(updateFunction);
        try { await transition.finished; } 
        finally { delete mainContainer.dataset.vtName; }
    }
    function updateProgress(text, percentage) {
        progressText.textContent = text;
        topLoaderBar.style.width = `${percentage}%`;
    }
    function showProgress(text) {
        updateProgress(text, 0);
        progressContainer.classList.add('visible');
    }
    function hideProgress() {
        updateProgress('', 100);
        setTimeout(() => {
            progressContainer.classList.remove('visible');
            updateProgress('', 0);
        }, 300);
    }
    
    // --- 深色模式功能 ---
    function initializeTheme() {
        const savedTheme = localStorage.getItem('arxiv_theme') || 
            (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
        setTheme(savedTheme);
    }
    
    function setTheme(theme) {
        state.theme = theme;
        document.body.setAttribute('data-theme', theme);
        localStorage.setItem('arxiv_theme', theme);
        updateThemeIcons();
    }
    
    function toggleTheme() {
        const newTheme = state.theme === 'light' ? 'dark' : 'light';
        setTheme(newTheme);
        showToast(`已切换到${newTheme === 'dark' ? '深色' : '浅色'}模式`);
    }
    
    function updateThemeIcons() {
        if (state.theme === 'dark') {
            themeIconLight.classList.add('hidden');
            themeIconDark.classList.remove('hidden');
        } else {
            themeIconLight.classList.remove('hidden');
            themeIconDark.classList.add('hidden');
        }
    }
    
    // --- 搜索建议功能 ---
    function initializeSearchSuggestions() {
        // 基础搜索建议数据
        state.searchSuggestions = [
            ...state.mainCategories.map(cat => ({
                text: cat,
                type: '分类',
                category: 'category'
            })),
            { text: 'transformer', type: '关键词', category: 'keyword' },
            { text: 'neural network', type: '关键词', category: 'keyword' },
            { text: 'deep learning', type: '关键词', category: 'keyword' },
            { text: 'computer vision', type: '关键词', category: 'keyword' },
            { text: 'natural language processing', type: '关键词', category: 'keyword' },
            { text: 'reinforcement learning', type: '关键词', category: 'keyword' },
            { text: 'generative adversarial network', type: '关键词', category: 'keyword' },
            { text: 'attention mechanism', type: '关键词', category: 'keyword' },
            { text: 'machine learning', type: '关键词', category: 'keyword' },
            { text: 'artificial intelligence', type: '关键词', category: 'keyword' }
        ];
    }
    
    function showSearchSuggestions(query) {
        if (!query.trim()) {
            hideSearchSuggestions();
            return;
        }
        
        const filtered = state.searchSuggestions
            .filter(suggestion => 
                suggestion.text.toLowerCase().includes(query.toLowerCase())
            )
            .slice(0, 8);
            
        // 添加搜索历史匹配项
        const historyMatches = state.searchHistory
            .filter(item => 
                item.toLowerCase().includes(query.toLowerCase()) && 
                !filtered.some(f => f.text === item)
            )
            .slice(0, 3)
            .map(item => ({
                text: item,
                type: '历史',
                category: 'history'
            }));
            
        const allSuggestions = [...historyMatches, ...filtered];
        
        if (allSuggestions.length === 0) {
            hideSearchSuggestions();
            return;
        }
        
        let html = '';
        allSuggestions.forEach((suggestion, index) => {
            html += `
                <div class="suggestion-item ${index === state.currentSuggestionIndex ? 'highlighted' : ''}" 
                     data-suggestion="${escapeCQ(suggestion.text)}" 
                     data-index="${index}">
                    <span>${suggestion.text}</span>
                    <span class="suggestion-type">${suggestion.type}</span>
                </div>
            `;
        });
        
        searchSuggestions.innerHTML = html;
        searchSuggestions.classList.add('visible');
    }
    
    function hideSearchSuggestions() {
        searchSuggestions.classList.remove('visible');
        state.currentSuggestionIndex = -1;
    }
    
    function selectSuggestion(suggestion) {
        searchInput.value = suggestion;
        hideSearchSuggestions();
        addToSearchHistory(suggestion);
        handleSearch();
    }
    
    // --- 搜索历史功能 ---
    function loadSearchHistory() {
        const history = localStorage.getItem('arxiv_search_history');
        if (history) {
            try {
                state.searchHistory = JSON.parse(history);
            } catch (e) {
                console.warn('Failed to load search history:', e);
                state.searchHistory = [];
            }
        }
    }
    
    function saveSearchHistory() {
        localStorage.setItem('arxiv_search_history', JSON.stringify(state.searchHistory));
    }
    
    function addToSearchHistory(query) {
        if (!query.trim() || query === 'favorites') return;
        
        // 移除重复项
        state.searchHistory = state.searchHistory.filter(item => item !== query);
        // 添加到开头
        state.searchHistory.unshift(query);
        // 限制数量
        state.searchHistory = state.searchHistory.slice(0, 10);
        saveSearchHistory();
        updateSearchHistoryDisplay();
    }
    
    function updateSearchHistoryDisplay() {
        if (state.searchHistory.length === 0) {
            searchHistoryItems.innerHTML = '<p class="text-sm text-gray-500">暂无搜索历史</p>';
            return;
        }
        
        let html = '';
        state.searchHistory.forEach(item => {
            html += `<span class="search-history-item" data-query="${escapeCQ(item)}">${item}</span>`;
        });
        searchHistoryItems.innerHTML = html;
    }
    
    function clearSearchHistory() {
        state.searchHistory = [];
        saveSearchHistory();
        updateSearchHistoryDisplay();
        showToast('搜索历史已清除');
    }
    
    // --- 阅读进度功能 ---
    function updateReadingProgress() {
        const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
        const scrollHeight = document.documentElement.scrollHeight - document.documentElement.clientHeight;
        const progress = (scrollTop / scrollHeight) * 100;
        readingProgressBar.style.width = `${Math.min(progress, 100)}%`;
    }

    // --- 移动端优化功能 ---
    
    function initializeMobileFeatures() {
        if (!state.mobile.isTouchDevice) return;
        
        setupMobileNavigation();
        setupTouchGestures();
        setupMobileBottomNav();
        optimizeMobileSearch();
        setupMobileViewportFix();
    }
    
    function setupMobileNavigation() {
        if (mobileNavToggle && mobileNavContent) {
            mobileNavToggle.addEventListener('click', toggleMobileMenu);
            
            // 点击外部关闭菜单
            document.addEventListener('click', (e) => {
                if (state.mobile.isMenuOpen && 
                    !quickNavContainer.contains(e.target)) {
                    closeMobileMenu();
                }
            });
        }
    }
    
    function toggleMobileMenu() {
        state.mobile.isMenuOpen = !state.mobile.isMenuOpen;
        updateMobileMenuState();
    }
    
    function closeMobileMenu() {
        state.mobile.isMenuOpen = false;
        updateMobileMenuState();
    }
    
    function updateMobileMenuState() {
        if (mobileNavContent && hamburgerIcon && closeIcon) {
            if (state.mobile.isMenuOpen) {
                mobileNavContent.classList.add('active');
                hamburgerIcon.classList.add('hidden');
                closeIcon.classList.remove('hidden');
            } else {
                mobileNavContent.classList.remove('active');
                hamburgerIcon.classList.remove('hidden');
                closeIcon.classList.add('hidden');
            }
        }
    }
    
    function setupTouchGestures() {
        let touchStartX = 0;
        let touchEndX = 0;
        let touchStartY = 0;
        let touchEndY = 0;
        let isVerticalScroll = false;
        
        mainContainer.addEventListener('touchstart', (e) => {
            touchStartX = e.changedTouches[0].screenX;
            touchStartY = e.changedTouches[0].screenY;
            state.mobile.touchStartX = touchStartX;
            state.mobile.touchStartY = touchStartY;
            isVerticalScroll = false;
        }, { passive: true });
        
        mainContainer.addEventListener('touchmove', (e) => {
            const currentX = e.changedTouches[0].screenX;
            const currentY = e.changedTouches[0].screenY;
            
            // 检查是否是垂直滚动
            const deltaY = Math.abs(currentY - touchStartY);
            const deltaX = Math.abs(currentX - touchStartX);
            
            if (deltaY > deltaX && deltaY > 10) {
                isVerticalScroll = true;
            }
            
            // 显示滑动提示
            if (!isVerticalScroll && deltaX > 20) {
                const direction = currentX > touchStartX ? 'right' : 'left';
                showSwipeIndicator(direction);
            }
        }, { passive: true });
        
        mainContainer.addEventListener('touchend', (e) => {
            touchEndX = e.changedTouches[0].screenX;
            touchEndY = e.changedTouches[0].screenY;
            state.mobile.touchEndX = touchEndX;
            state.mobile.touchEndY = touchEndY;
            
            hideSwipeIndicators();
            
            if (!isVerticalScroll) {
                handleSwipeGesture();
            }
        }, { passive: true });
    }
    
    function handleSwipeGesture() {
        const deltaX = state.mobile.touchEndX - state.mobile.touchStartX;
        const deltaY = Math.abs(state.mobile.touchEndY - state.mobile.touchStartY);
        
        // 只有水平滑动距离足够且垂直滑动距离不大时才处理
        if (Math.abs(deltaX) > state.mobile.swipeThreshold && deltaY < 100) {
            if (deltaX > 0) {
                // 向右滑动 - 加载上一月
                handleSwipeRight();
            } else {
                // 向左滑动 - 加载下一月
                handleSwipeLeft();
            }
        }
    }
    
    function handleSwipeLeft() {
        // 加载下一月
        if (!state.isFetching && !state.isSearchMode) {
            loadNextMonth(false);
            showToast('滑动加载下一月');
        }
    }
    
    function handleSwipeRight() {
        // 加载上一月
        if (!state.isFetching && !state.isSearchMode && state.currentMonthIndex > 0) {
            const prevMonth = state.manifest.availableMonths[state.currentMonthIndex - 1];
            if (prevMonth) {
                navigateToMonth(prevMonth);
                showToast('滑动加载上一月');
            }
        }
    }
    
    function showSwipeIndicator(direction) {
        const indicator = direction === 'left' ? swipeIndicatorLeft : swipeIndicatorRight;
        if (indicator) {
            indicator.classList.add('show');
        }
    }
    
    function hideSwipeIndicators() {
        if (swipeIndicatorLeft) swipeIndicatorLeft.classList.remove('show');
        if (swipeIndicatorRight) swipeIndicatorRight.classList.remove('show');
    }
    
    function setupMobileBottomNav() {
        if (!mobileBottomNav) return;
        
        const buttons = mobileBottomNav.querySelectorAll('button');
        buttons.forEach(button => {
            button.addEventListener('click', handleMobileBottomNavClick);
        });
        
        // 更新收藏计数
        updateMobileFavoritesCount();
    }
    
    function handleMobileBottomNavClick(e) {
        const action = e.currentTarget.dataset.action;
        
        // 更新活跃状态
        mobileBottomNav.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
        e.currentTarget.classList.add('active');
        
        switch (action) {
            case 'scroll-to-top':
                window.scrollTo({ top: 0, behavior: 'smooth' });
                break;
            case 'focus-search':
                searchInput.focus();
                searchInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
                break;
            case 'show-favorites':
                performTagSearch('favorites');
                break;
            case 'toggle-mobile-menu':
                toggleMobileMenu();
                break;
        }
    }
    
    function updateMobileFavoritesCount() {
        const badge = document.getElementById('mobile-favorites-badge');
        const mobileCount = document.getElementById('favorites-count-mobile');
        if (badge) badge.textContent = state.favorites.size;
        if (mobileCount) mobileCount.textContent = state.favorites.size;
    }
    
    function optimizeMobileSearch() {
        // 移动端搜索框优化
        searchInput.addEventListener('focus', () => {
            // 滚动到搜索框
            setTimeout(() => {
                searchInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }, 300);
        });
        
        // 优化搜索建议在移动端的显示
        const suggestions = document.getElementById('search-suggestions');
        if (suggestions) {
            suggestions.addEventListener('touchstart', (e) => {
                e.preventDefault(); // 防止双击缩放
            });
        }
    }
    
    function setupMobileViewportFix() {
        // 修复移动端 100vh 问题
        function setVH() {
            const vh = window.innerHeight * 0.01;
            document.documentElement.style.setProperty('--vh', `${vh}px`);
        }
        
        setVH();
        window.addEventListener('resize', setVH);
        window.addEventListener('orientationchange', () => {
            setTimeout(setVH, 500);
        });
    }
    
    function optimizeMobileTouchTargets() {
        // 确保所有可点击元素达到最小触摸目标尺寸
        const clickableElements = document.querySelectorAll('button, a, .keyword-tag, .suggestion-item');
        clickableElements.forEach(element => {
            if (window.innerWidth <= 768) {
                const rect = element.getBoundingClientRect();
                if (rect.height < 44) {
                    element.style.minHeight = '44px';
                    element.style.display = 'inline-flex';
                    element.style.alignItems = 'center';
                    element.style.justifyContent = 'center';
                }
            }
        });
    }
    
    function addRippleEffect(element) {
        element.addEventListener('touchstart', function(e) {
            const ripple = document.createElement('span');
            const rect = this.getBoundingClientRect();
            const size = Math.max(rect.width, rect.height);
            const x = e.touches[0].clientX - rect.left - size / 2;
            const y = e.touches[0].clientY - rect.top - size / 2;
            
            ripple.style.cssText = `
                position: absolute;
                width: ${size}px;
                height: ${size}px;
                left: ${x}px;
                top: ${y}px;
                background: rgba(255, 255, 255, 0.3);
                border-radius: 50%;
                transform: scale(0);
                animation: ripple 0.6s linear;
                pointer-events: none;
            `;
            
            this.style.position = 'relative';
            this.style.overflow = 'hidden';
            this.appendChild(ripple);
            
            setTimeout(() => {
                ripple.remove();
            }, 600);
        });
        
        // 添加 CSS 动画
        if (!document.getElementById('ripple-animation')) {
            const style = document.createElement('style');
            style.id = 'ripple-animation';
            style.textContent = `
                @keyframes ripple {
                    to {
                        transform: scale(4);
                        opacity: 0;
                    }
                }
            `;
            document.head.appendChild(style);
        }
    }

    // --- 核心功能 ---
    async function init() {
        showProgress('正在初始化...');
        try {
            // 加载所有设置
            loadFavorites();
            loadViewMode();
            loadSearchHistory();
            loadPaperTags();
            loadPaperNotes();
            loadPaperRatings();
            initializeTheme();
            initializeSearchSuggestions();
            initializeUserGuidance(); // 初始化用户引导系统
            
            const response = await fetch('./data/index.json');
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            state.manifest = await response.json();
            
            if (state.manifest.availableMonths && state.manifest.availableMonths.length > 0) {
                setupUI();
                setupGlobalEventListeners();
                
                const urlParams = new URLSearchParams(window.location.search);
                const queryFromUrl = urlParams.get('q');
                const paperFromUrl = urlParams.get('paper');

                if (paperFromUrl) {
                    await handleDirectLink(paperFromUrl);
                } else if (queryFromUrl) {
                    searchInput.value = queryFromUrl;
                    await handleSearch();
                } else {
                    await loadNextMonth(false); 
                }
            } else {
                 papersContainer.innerHTML = `<p class="text-center text-gray-500">数据清单为空。</p>`;
            }
        } catch (error) {
            console.error("Initialization failed:", error);
            papersContainer.innerHTML = `<p class="text-center text-red-500">加载数据失败。请确保您在项目的 'docs' 目录下启动了本地服务器。</p>`;
        } finally {
            hideProgress();
        }
    }
    
    function setupUI() {
        setupQuickNav();
        setupCategoryFilters();
        updateSearchStickiness();
        setupNavObserver();
        setupBackToTopButton();
        setupIntersectionObserver();
        updateSearchHistoryDisplay();
        initializeMobileFeatures(); // 新增移动端功能初始化
        if(state.manifest.lastUpdated) lastUpdatedEl.textContent = `数据更新于: ${state.manifest.lastUpdated}`;
        document.getElementById('favorites-count').textContent = state.favorites.size;
        updateMobileFavoritesCount(); // 更新移动端收藏计数
    }
    
    // --- 论文标签、笔记、评分功能 ---
    function loadPaperTags() {
        const tags = localStorage.getItem('arxiv_paper_tags');
        if (tags) {
            try {
                const parsed = JSON.parse(tags);
                state.paperTags = new Map(Object.entries(parsed));
            } catch (e) {
                console.warn('Failed to load paper tags:', e);
                state.paperTags = new Map();
            }
        }
    }
    
    function savePaperTags() {
        const obj = Object.fromEntries(state.paperTags);
        localStorage.setItem('arxiv_paper_tags', JSON.stringify(obj));
    }
    
    function loadPaperNotes() {
        const notes = localStorage.getItem('arxiv_paper_notes');
        if (notes) {
            try {
                const parsed = JSON.parse(notes);
                state.paperNotes = new Map(Object.entries(parsed));
            } catch (e) {
                console.warn('Failed to load paper notes:', e);
                state.paperNotes = new Map();
            }
        }
    }
    
    function savePaperNotes() {
        const obj = Object.fromEntries(state.paperNotes);
        localStorage.setItem('arxiv_paper_notes', JSON.stringify(obj));
    }
    
    function loadPaperRatings() {
        const ratings = localStorage.getItem('arxiv_paper_ratings');
        if (ratings) {
            try {
                const parsed = JSON.parse(ratings);
                state.paperRatings = new Map(Object.entries(parsed));
            } catch (e) {
                console.warn('Failed to load paper ratings:', e);
                state.paperRatings = new Map();
            }
        }
    }
    
    function savePaperRatings() {
        const obj = Object.fromEntries(state.paperRatings);
        localStorage.setItem('arxiv_paper_ratings', JSON.stringify(obj));
    }
    
    function addPaperTag(paperId, tag) {
        if (!tag.trim()) return;
        
        const currentTags = state.paperTags.get(paperId) || [];
        if (!currentTags.includes(tag)) {
            currentTags.push(tag);
            state.paperTags.set(paperId, currentTags);
            savePaperTags();
            updatePaperTagsDisplay(paperId);
        }
    }
    
    function removePaperTag(paperId, tag) {
        const currentTags = state.paperTags.get(paperId) || [];
        const updated = currentTags.filter(t => t !== tag);
        
        if (updated.length === 0) {
            state.paperTags.delete(paperId);
        } else {
            state.paperTags.set(paperId, updated);
        }
        savePaperTags();
        updatePaperTagsDisplay(paperId);
    }
    
    function updatePaperTagsDisplay(paperId) {
        const container = document.getElementById(`paper-tags-${paperId}`);
        if (!container) return;
        
        const tags = state.paperTags.get(paperId) || [];
        let html = '';
        
        tags.forEach(tag => {
            html += `
                <span class="custom-tag">
                    ${tag}
                    <span class="tag-remove" data-action="remove-tag" data-paper-id="${paperId}" data-tag="${escapeCQ(tag)}">×</span>
                </span>
            `;
        });
        
        // 添加新标签输入
        html += `
            <input type="text" 
                   id="tag-input-${paperId}" 
                   class="inline-block text-xs px-2 py-1 border border-gray-300 rounded" 
                   placeholder="添加标签..." 
                   style="width: 80px; font-size: 0.75rem;"
                   data-paper-id="${paperId}">
        `;
        
        container.innerHTML = html;
        
        // 设置标签输入事件
        const tagInput = document.getElementById(`tag-input-${paperId}`);
        if (tagInput) {
            tagInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    const tag = e.target.value.trim();
                    if (tag) {
                        addPaperTag(paperId, tag);
                        e.target.value = '';
                    }
                }
            });
        }
    }
    
    function setPaperRating(paperId, rating) {
        state.paperRatings.set(paperId, rating);
        savePaperRatings();
        updatePaperRatingDisplay(paperId);
    }
    
    function updatePaperRatingDisplay(paperId) {
        const container = document.getElementById(`paper-rating-${paperId}`);
        if (!container) return;
        
        const currentRating = state.paperRatings.get(paperId) || 0;
        let html = '<span class="text-sm text-gray-600 mr-2">评分:</span>';
        
        for (let i = 1; i <= 5; i++) {
            html += `
                <span class="star ${i <= currentRating ? 'active' : ''}" 
                      data-action="rate-paper" 
                      data-paper-id="${paperId}" 
                      data-rating="${i}">★</span>
            `;
        }
        
        container.innerHTML = html;
    }
    
    function savePaperNote(paperId, note) {
        if (note.trim()) {
            state.paperNotes.set(paperId, note.trim());
        } else {
            state.paperNotes.delete(paperId);
        }
        savePaperNotes();
    }
    
    function togglePaperNotes(paperId) {
        const notesContainer = document.getElementById(`paper-notes-${paperId}`);
        if (!notesContainer) return;
        
        notesContainer.classList.toggle('visible');
        
        if (notesContainer.classList.contains('visible')) {
            const textarea = notesContainer.querySelector('textarea');
            if (textarea) {
                textarea.focus();
                textarea.value = state.paperNotes.get(paperId) || '';
            }
        }
    }

    // --- UI/UX 功能 ---
    function setupQuickNav() {
        const monthsByYear = state.manifest.availableMonths.reduce((acc, month) => {
            const year = month.substring(0, 4);
            if (!acc[year]) acc[year] = [];
            acc[year].push(month);
            return acc;
        }, {});
        let navHTML = '';
        const sortedYears = Object.keys(monthsByYear).sort((a, b) => b - a);
        sortedYears.forEach(year => {
            navHTML += `<div class="year-group"><span class="year-label">${year}</span>`;
            monthsByYear[year].forEach(month => {
                const monthLabel = month.substring(5, 7);
                navHTML += `<button class="month-btn" data-action="navigate-month" data-month="${month}">${monthLabel}月</button>`;
            });
            navHTML += `</div>`;
        });
        
        // 填充移动端和桌面端导航
        const mobileNavWrapper = document.getElementById('month-nav-wrapper');
        const desktopNavWrapper = document.getElementById('month-nav-wrapper-desktop');
        
        if (mobileNavWrapper) mobileNavWrapper.innerHTML = navHTML;
        if (desktopNavWrapper) desktopNavWrapper.innerHTML = navHTML;
        
        // 设置按钮事件
        setupViewToggleButtons();
        setupFavoritesButtons();
        updateViewModeUI();
        
        // 为移动端按钮添加涟漪效果
        if (state.mobile.isTouchDevice) {
            document.querySelectorAll('.month-btn').forEach(addRippleEffect);
        }
    }
    
    function setupViewToggleButtons() {
        // 桌面端按钮
        const detailedBtn = document.getElementById('view-detailed-btn');
        const compactBtn = document.getElementById('view-compact-btn');
        if (detailedBtn) {
            detailedBtn.dataset.action = 'toggle-view';
            detailedBtn.dataset.mode = 'detailed';
        }
        if (compactBtn) {
            compactBtn.dataset.action = 'toggle-view';
            compactBtn.dataset.mode = 'compact';
        }
        
        // 移动端按钮
        const detailedBtnMobile = document.getElementById('view-detailed-btn-mobile');
        const compactBtnMobile = document.getElementById('view-compact-btn-mobile');
        if (detailedBtnMobile) {
            detailedBtnMobile.dataset.action = 'toggle-view';
            detailedBtnMobile.dataset.mode = 'detailed';
        }
        if (compactBtnMobile) {
            compactBtnMobile.dataset.action = 'toggle-view';
            compactBtnMobile.dataset.mode = 'compact';
        }
    }
    
    function setupFavoritesButtons() {
        // 桌面端收藏按钮
        const favBtn = document.getElementById('show-favorites-btn');
        if (favBtn) {
            favBtn.dataset.action = 'search-tag';
            favBtn.dataset.tagValue = 'favorites';
        }
        
        // 移动端收藏按钮
        const favBtnMobile = document.getElementById('show-favorites-btn-mobile');
        if (favBtnMobile) {
            favBtnMobile.dataset.action = 'search-tag';
            favBtnMobile.dataset.tagValue = 'favorites';
        }
    }
    
    function setupCategoryFilters() {
        let buttonsHTML = `<button class="category-filter-btn active" data-action="filter-category" data-category="all">全部</button>`;
        state.mainCategories.forEach(cat => {
            buttonsHTML += `<button class="category-filter-btn" data-action="filter-category" data-category="${cat}">${cat}</button>`;
        });
        categoryFiltersEl.innerHTML = buttonsHTML;
    }

    function setupNavObserver() {
        const options = { rootMargin: '-40% 0px -60% 0px', threshold: 0 };
        state.navObserver = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const month = entry.target.dataset.monthAnchor;
                    document.querySelectorAll('.month-btn.active').forEach(btn => btn.classList.remove('active'));
                    const targetBtn = document.querySelector(`.month-btn[data-month="${month}"]`);
                    if (targetBtn) targetBtn.classList.add('active');
                }
            });
        }, options);
    }

    function setupBackToTopButton() {
        window.addEventListener('scroll', () => {
            if (window.scrollY > 300) { backToTopBtn.classList.add('visible'); } 
            else { backToTopBtn.classList.remove('visible'); }
            
            // 更新阅读进度
            updateReadingProgress();
        });
        backToTopBtn.addEventListener('click', () => { window.scrollTo({ top: 0, behavior: 'smooth' }); });
    }
    
    function updateSearchStickiness() {
        const navHeight = quickNavContainer.offsetHeight;
        document.documentElement.style.setProperty('--nav-height', `${navHeight}px`);
    }

    // --- 核心逻辑：数据加载与渲染 ---
    async function fetchWithProgress(monthsToLoad) {
        console.log(`fetchWithProgress called with months: ${monthsToLoad}`);
        const total = monthsToLoad.length;
        if (total === 0) return;
        
        showProgress(`开始加载 ${total} 个文件...`);
        let loadedCount = 0;
        
        for (const month of monthsToLoad) {
            loadedCount++;
            console.log(`Loading month ${month} (${loadedCount}/${total})`);
            updateProgress(`正在加载: ${month} (${loadedCount}/${total})`, (loadedCount / total) * 90);
            try {
                await fetchMonth(month);
                console.log(`Successfully loaded month ${month}`);
            } catch (error) {
                console.error(`Failed to load month ${month}:`, error);
                showToast(`加载 ${month} 失败`, 'error');
                // 继续尝试加载其他月份
            }
        }
        console.log('fetchWithProgress completed');
    }

    async function fetchMonth(month) {
        console.log(`fetchMonth called with month: ${month}`);
        if (state.loadedMonths.has(month)) {
            console.log(`Month ${month} already loaded, skipping`);
            return;
        }
        
        // 检查是否支持 Web Worker
        if (typeof Worker !== 'undefined') {
            return fetchMonthWithWorker(month);
        } else {
            return fetchMonthFallback(month);
        }
    }

    async function fetchMonthWithWorker(month) {
        console.log(`Using Web Worker for ${month}`);
        
        return new Promise((resolve, reject) => {
            const worker = new Worker('./json-parser-worker.js');
            const url = `./data/database-${month}.json`;
            
            updateProgress(`加载 ${month} (使用 Web Worker)...`, 30);
            
            worker.postMessage({ url, month });
            
            let processedPapers = 0;
            const timeout = setTimeout(() => {
                worker.terminate();
                reject(new Error('Web Worker 超时'));
            }, 60000); // 60秒超时
            
            worker.onmessage = function(e) {
                const { type, papers, progress, error } = e.data;
                
                switch (type) {
                    case 'batch':
                        // 批量处理接收到的论文数据
                        papers.forEach(paper => {
                            if (paper && paper.id && !state.allPapers.has(paper.id)) {
                                state.allPapers.set(paper.id, paper);
                            }
                        });
                        processedPapers += papers.length;
                        
                        if (progress) {
                            updateProgress(
                                `处理 ${month}: ${progress.current}/${progress.total}`, 
                                30 + (progress.percentage * 0.6)
                            );
                        }
                        break;
                        
                    case 'complete':
                        clearTimeout(timeout);
                        worker.terminate();
                        state.loadedMonths.add(month);
                        console.log(`Web Worker completed loading ${month}: ${processedPapers} papers`);
                        resolve();
                        break;
                        
                    case 'error':
                        clearTimeout(timeout);
                        worker.terminate();
                        console.error(`Web Worker error for ${month}:`, error);
                        reject(new Error(error));
                        break;
                }
            };
            
            worker.onerror = function(error) {
                clearTimeout(timeout);
                worker.terminate();
                console.error(`Web Worker error:`, error);
                reject(error);
            };
        });
    }

    async function fetchMonthFallback(month) {
        console.log(`Using fallback method for ${month}`);
        try {
            const url = `./data/database-${month}.json`;
            console.log(`Fetching URL: ${url}`);
            const response = await fetch(url);
            console.log(`Response status: ${response.status}`);
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            
            // 获取文件大小以显示进度
            const contentLength = response.headers.get('content-length');
            const totalSize = contentLength ? parseInt(contentLength, 10) : 0;
            console.log(`File size: ${totalSize} bytes (${(totalSize/1024/1024).toFixed(1)}MB)`);
            
            // 显示解析进度
            updateProgress(`解析数据文件 ${month}...`, 50);
            
            // 使用Promise.race添加超时控制
            const parsePromise = response.json();
            const timeoutPromise = new Promise((_, reject) => 
                setTimeout(() => reject(new Error('JSON解析超时')), 45000) // 45秒超时
            );
            
            console.log('Starting JSON parsing...');
            const papers = await Promise.race([parsePromise, timeoutPromise]);
            console.log(`Loaded ${papers.length} papers for month ${month}`);
            
            // 批量处理论文数据以避免阻塞
            let processedCount = 0;
            const batchSize = 500; // 减小批次大小
            for (let i = 0; i < papers.length; i += batchSize) {
                const batch = papers.slice(i, i + batchSize);
                batch.forEach(paper => { 
                    if (paper && paper.id && !state.allPapers.has(paper.id)) {
                        state.allPapers.set(paper.id, paper);
                    }
                });
                processedCount += batch.length;
                
                // 每处理一批数据就让出控制权
                if (i + batchSize < papers.length) {
                    updateProgress(`处理论文数据: ${processedCount}/${papers.length}`, 60 + (processedCount / papers.length) * 30);
                    await new Promise(resolve => setTimeout(resolve, 5)); // 增加延迟
                }
            }
            
            state.loadedMonths.add(month);
            console.log(`Month ${month} added to loadedMonths`);
        } catch (error) { 
            console.error(`Failed to load data for month ${month}:`, error); 
            if (error.message === 'JSON解析超时') {
                showToast(`${month} 数据文件过大，解析超时。请稍后重试。`);
            }
            throw error; // 重新抛出错误以便上层处理
        } 
    }

    function renderPapers(papersForMonth, month) {
        const monthWrapper = document.createElement('div');
        monthWrapper.id = `month-content-${month}`;
        monthWrapper.dataset.monthAnchor = month;

        const header = document.createElement('h2');
        header.className = 'month-header';
        header.textContent = `${month.substring(0,4)}年${month.substring(5,7)}月`;
        
        const dateFilterWrapper = document.createElement('div');
        dateFilterWrapper.id = `date-filter-wrapper-${month}`;
        dateFilterWrapper.className = 'flex flex-wrap items-center gap-2 mb-6';
        
        const papersListWrapper = document.createElement('div');
        papersListWrapper.id = `papers-list-wrapper-${month}`;
        papersListWrapper.className = 'space-y-8';
        
        monthWrapper.append(header, dateFilterWrapper, papersListWrapper);
        papersContainer.appendChild(monthWrapper);
        
        if (state.navObserver) {
            state.navObserver.observe(monthWrapper);
            console.log(`navObserver now observing month ${month}`);
        } else {
            console.log('navObserver is null, skipping observe');
        }
        
        updateMonthView(month, papersForMonth);
    }
    
    function updateMonthView(month, allPapersForMonth) {
        const dateFilterWrapper = document.getElementById(`date-filter-wrapper-${month}`);
        const papersListWrapper = document.getElementById(`papers-list-wrapper-${month}`);
        if (!dateFilterWrapper || !papersListWrapper) return;

        const activeDay = state.activeDateFilters.get(month) || 'all';

        renderDateFilter(month, allPapersForMonth, dateFilterWrapper);

        const filteredPapers = (activeDay === 'all')
            ? allPapersForMonth
            : allPapersForMonth.filter(p => p.date && p.date.endsWith(`-${String(activeDay).padStart(2, '0')}`));

        papersListWrapper.innerHTML = '';
        if (filteredPapers.length > 0) {
            renderInChunks(filteredPapers, papersListWrapper);
        } else {
            papersListWrapper.innerHTML = `<p class="text-center text-gray-500 py-4">该日期没有论文。</p>`;
        }
    }

    function renderDateFilter(month, papers, container) {
        const activeDay = state.activeDateFilters.get(month) || 'all';
        const daysWithPapers = [...new Set(papers.map(p => p.date.split('-')[2]))].sort((a, b) => b - a);

        let buttonsHTML = `<button class="date-filter-btn ${activeDay === 'all' ? 'active' : ''}" data-action="filter-by-date" data-month="${month}" data-day="all">全部日期</button>`;
        daysWithPapers.forEach(day => {
            buttonsHTML += `<button class="date-filter-btn ${activeDay == day ? 'active' : ''}" data-action="filter-by-date" data-month="${month}" data-day="${day}">${day}日</button>`;
        });
        container.innerHTML = buttonsHTML;
    }

    function renderInChunks(papers, container, index = 0) {
        const CHUNK_SIZE = 3; // 进一步减小批次大小
        if (index >= papers.length) {
            console.log(`Rendering completed. Total papers rendered: ${papers.length}`);
            // 渲染完成后启用懒加载
            enableLazyLoading();
            return;
        }
        
        const fragment = document.createDocumentFragment();
        const endIndex = Math.min(index + CHUNK_SIZE, papers.length);
        
        for (let i = index; i < endIndex; i++) {
            if (papers[i] && papers[i].id) {
                try { 
                    fragment.appendChild(createPaperCard(papers[i], i >= 20)); // 前20个正常渲染，后面懒加载
                } catch (e) { 
                    console.error(`Error creating card for paper #${papers[i].id} at index ${i}:`, papers[i], e); 
                }
            }
        }
        
        container.appendChild(fragment);
        
        // 显示渲染进度
        if (index % 30 === 0) { // 每30个论文显示一次进度
            const progress = Math.round((endIndex / papers.length) * 100);
            console.log(`Rendering progress: ${endIndex}/${papers.length} (${progress}%)`);
            
            // 更新进度条
            if (papers.length > 100) {
                updateProgress(`渲染论文: ${endIndex}/${papers.length}`, 95 + (progress * 0.05));
            }
        }
        
        // 使用requestIdleCallback来优化性能
        if (window.requestIdleCallback) {
            requestIdleCallback(() => renderInChunks(papers, container, endIndex), { timeout: 100 });
        } else {
            // 降级到setTimeout，增加延迟以避免阻塞
            setTimeout(() => renderInChunks(papers, container, endIndex), 15);
        }
    }

    function enableLazyLoading() {
        // 为懒加载的图片和内容设置 Intersection Observer
        const lazyElements = document.querySelectorAll('.lazy-load');
        if (lazyElements.length === 0) return;
        
        const lazyObserver = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const element = entry.target;
                    // 触发懒加载内容的渲染
                    if (element.dataset.paperId) {
                        loadPaperDetails(element.dataset.paperId);
                    }
                    lazyObserver.unobserve(element);
                }
            });
        }, {
            rootMargin: '100px' // 提前100px开始加载
        });
        
        lazyElements.forEach(el => lazyObserver.observe(el));
    }

    function loadPaperDetails(paperId) {
        const placeholder = document.getElementById(`lazy-${paperId}`);
        if (!placeholder) return;
        
        // 延迟加载详细内容
        setTimeout(() => {
            const paper = state.allPapers.get(paperId);
            if (paper) {
                placeholder.outerHTML = createDetailedPaperContent(paper);
                // 重新初始化这个论文卡片的功能
                setTimeout(() => {
                    updatePaperRatingDisplay(paperId);
                    updatePaperTagsDisplay(paperId);
                }, 0);
            }
        }, 50);
    }

    function createPaperCard(paper, isLazy = false) {
        const card = document.createElement('article');
        card.id = `card-${paper.id}`;
        card.style.viewTransitionName = `card-${paper.id}`;
        card.className = 'paper-card bg-white p-6 rounded-lg shadow-md border border-gray-200';
        card.setAttribute('tabindex', '0');
        card.setAttribute('role', 'article');
        card.setAttribute('aria-label', `论文: ${paper.title || '无标题'}`);
        
        if (isLazy) {
            // 懒加载模式：只渲染基本信息
            card.innerHTML = createLazyPaperContent(paper);
        } else {
            // 正常模式：渲染完整内容
            card.innerHTML = createDetailedPaperContent(paper);
            // 初始化用户功能显示
            setTimeout(() => {
                updatePaperRatingDisplay(paper.id);
                updatePaperTagsDisplay(paper.id);
            }, 0);
        }
        
        return card;
    }

    function createLazyPaperContent(paper) {
        const isFavorited = state.favorites.has(paper.id);
        const categoriesHTML = (paper.categories && paper.categories.length > 0) ? 
            paper.categories.slice(0, 2).map(cat => `<span class="keyword-tag inline-block bg-gray-100 text-gray-600 text-xs px-2 py-1 rounded">${cat}</span>`).join('') : '';
        
        return `
            <div class="flex justify-between items-start">
                <p class="text-sm text-gray-500 mb-2 flex-grow">${paper.date || '未知日期'} ${categoriesHTML ? '| ' : ''}${categoriesHTML}</p>
                <button data-action="toggle-favorite" data-paper-id="${paper.id}" title="收藏/取消收藏" class="favorite-btn ${isFavorited ? 'favorited' : ''}">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" /></svg>
                </button>
            </div>
            <h2 class="text-lg font-bold mb-2 paper-title">${paper.title || '无标题'}</h2>
            <p class="text-sm text-gray-600 mb-2">${paper.authors ? paper.authors.slice(0, 100) + (paper.authors.length > 100 ? '...' : '') : '未知作者'}</p>
            <div id="lazy-${paper.id}" class="lazy-load" data-paper-id="${paper.id}">
                <div class="text-center py-4 text-gray-400">
                    <div class="inline-block w-6 h-6 border-2 border-gray-300 border-t-gray-600 rounded-full animate-spin"></div>
                    <p class="mt-2 text-sm">加载详细内容...</p>
                </div>
            </div>
        `;
    }

    function createDetailedPaperContent(paper) {
        let title = paper.title || '无标题';
        if (state.isSearchMode && state.currentQuery && !state.categoryIndex[state.currentQuery] && state.currentQuery !== 'favorites') {
            const queryTerms = state.currentQuery.toLowerCase().split(/\s+/).filter(Boolean);
            const regex = new RegExp(queryTerms.map(escapeRegex).join('|'), 'gi');
            title = title.replace(regex, match => `<span class="highlight">${match}</span>`);
        }
        
        const keywordsHTML = (paper.keywords && paper.keywords.length > 0) ? paper.keywords.map(kw => `<span class="keyword-tag inline-block bg-blue-100 text-blue-800 text-sm font-medium mr-2 mb-2 px-3 py-1 rounded-full" data-action="search-tag" data-tag-value="${escapeCQ(kw)}">${kw}</span>`).join('') : '无';
        const categoriesHTML = (paper.categories && paper.categories.length > 0) ? paper.categories.map(cat => `<span class="keyword-tag inline-block bg-gray-100 text-gray-600 text-sm font-medium mr-2 mb-2 px-3 py-1 rounded-full" data-action="search-tag" data-tag-value="${escapeCQ(cat)}">${cat}</span>`).join('') : '';
        const absUrl = paper.id ? `https://arxiv.org/abs/${paper.id}` : '#';
        const pdfUrl = paper.id ? `https://arxiv.org/pdf/${paper.id}` : '#';
        const isFavorited = state.favorites.has(paper.id);
        
        const createInfoBox = (title, content, color) => {
            if (!content) return '';
            const isTldr = title === 'TL;DR';
            const titleClass = isTldr ? 'italic' : '';
            let contentClasses = [''];
            if (isTldr) {
                contentClasses.push('italic', 'text-sm');
            }
            return `<div class="info-box info-box-${color}"><p class="info-box-title ${titleClass}">${title}:</p><p class="${contentClasses.join(' ')}">${content}</p></div>`;
        };

        return `
            <div class="flex justify-between items-start">
                <p class="text-sm text-gray-500 mb-2 flex-grow">${paper.date||'未知日期'} ${categoriesHTML?'| ':''}${categoriesHTML}</p>
                <div class="flex items-center space-x-2">
                    <button data-action="toggle-notes" data-paper-id="${paper.id}" title="添加/编辑笔记" class="text-gray-500 hover:text-blue-600 transition">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg>
                    </button>
                    <button data-action="share-paper" data-paper-id="${paper.id}" title="分享论文链接" class="share-btn">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M15 8a3 3 0 10-2.977-2.63l-4.94 2.47a3 3 0 100 4.319l4.94 2.47a3 3 0 10.895-1.789l-4.94-2.47a3.027 3.027 0 000-.74l4.94-2.47C13.456 7.68 14.19 8 15 8z" /></svg>
                    </button>
                    <button data-action="toggle-favorite" data-paper-id="${paper.id}" title="收藏/取消收藏" aria-label="收藏或取消收藏" class="favorite-btn ${isFavorited?'favorited':''}">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" /></svg>
                    </button>
                </div>
            </div>
            <h2 class="text-xl md:text-2xl font-bold mb-2 paper-title">${title}</h2>
            <h3 class="text-base font-semibold mb-3 paper-title-zh italic">${paper.zh_title||''}</h3>
            
            <!-- 新增：用户评分 -->
            <div id="paper-rating-${paper.id}" class="paper-rating compact-hidden"></div>
            
            <!-- 新增：用户标签 -->
            <div id="paper-tags-${paper.id}" class="paper-tags compact-hidden"></div>
            
            <div class="text-sm text-gray-600 mb-3 compact-hidden">
                <p><strong>作者:</strong> ${paper.authors||'未知作者'}</p>
                <p class="mt-2"><strong>Keyword:</strong> ${keywordsHTML}</p>
            </div>
            
            <!-- 新增：用户笔记 -->
            <div id="paper-notes-${paper.id}" class="paper-notes compact-hidden">
                <textarea class="notes-textarea" placeholder="在这里记录您的想法和笔记..." data-paper-id="${paper.id}"></textarea>
                <div class="flex justify-end mt-2">
                    <button class="text-sm bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700" data-action="save-note" data-paper-id="${paper.id}">保存笔记</button>
                </div>
            </div>
            
            <div class="compact-hidden">
                ${createInfoBox('Comment',paper.comment,'yellow')}
                ${createInfoBox('TL;DR',paper.tldr,'green')}
                ${createInfoBox('AI点评',paper.comments,'indigo')}
            </div>
            <div id="ai-details-${paper.id}" class="details-section ai-details-section compact-hidden">
                <h2 class="text-2xl font-bold mb-4 ai-analysis-title">AI分析与摘要</h2>
                ${paper.motivation?`<h3>研究动机</h3><p>${paper.motivation}</p><br/>`:''}
                ${paper.method?`<h3>研究方法</h3><p>${paper.method}</p><br/>`:''}
                ${paper.results?`<h3>研究结果</h3><p>${paper.results}</p><br/>`:''}
                ${paper.conclusion?`<h3>研究结论</h3><p>${paper.conclusion}</p><br/>`:''}
                <h3>摘要翻译</h3><p class="italic text-sm">${paper.translation||'无'}</p><br/>
                <h3>原文摘要</h3><p class="italic text-sm">${paper.abstract||'无'}</p>
            </div>
            <div class="flex items-center space-x-4 mt-4">
                <a href="${absUrl}" target="_blank" class="paper-link-abstract font-semibold">摘要页</a>
                <a href="${pdfUrl}" target="_blank" class="paper-link-pdf font-semibold">PDF</a>
                <button data-action="toggle-ai-details" data-paper-id="${paper.id}" class="ml-auto ai-toggle-btn font-bold py-2 px-4 rounded-lg transition compact-hidden">AI分析</button>
            </div>`;
    }

    function toggleAIDetails(paperId) {
        const detailsSection = document.getElementById(`ai-details-${paperId}`);
        if (detailsSection) detailsSection.classList.toggle('expanded');
    }
    
    function loadFavorites() { const favs = localStorage.getItem('arxiv_favorites'); if (favs) { try { state.favorites = new Set(JSON.parse(favs)); } catch (e) { state.favorites = new Set(); } } }
    function saveFavorites() { localStorage.setItem('arxiv_favorites', JSON.stringify(Array.from(state.favorites))); }
    function toggleFavorite(event, paperId, btn) {
        event.stopPropagation();
        const update = () => {
            if (state.favorites.has(paperId)) {
                state.favorites.delete(paperId); btn.classList.remove('favorited');
                if (state.currentQuery === 'favorites') btn.closest('.paper-card').remove();
            } else {
                state.favorites.add(paperId); btn.classList.add('favorited');
            }
            saveFavorites();
            document.getElementById('favorites-count').textContent = state.favorites.size;
            updateMobileFavoritesCount(); // 更新移动端计数
        }
        if (state.currentQuery === 'favorites' && state.favorites.has(paperId)) {
            applyViewTransition(update, 'fav-remove');
        } else { update(); }
    }
    
    function loadViewMode() { const savedMode = localStorage.getItem('arxiv_view_mode') || 'detailed'; state.viewMode = savedMode; mainContainer.className = `${savedMode}-view`; }
    function toggleViewMode(mode) {
        if (state.viewMode === mode) return;
        applyViewTransition(() => {
            state.viewMode = mode;
            localStorage.setItem('arxiv_view_mode', mode);
            mainContainer.className = `${mode}-view`;
            updateViewModeUI();
        }, 'view-toggle');
    }
    function updateViewModeUI() {
        document.getElementById('view-detailed-btn')?.classList.toggle('active', state.viewMode === 'detailed');
        document.getElementById('view-compact-btn')?.classList.toggle('active', state.viewMode === 'compact');
    }

    // --- 核心逻辑：状态切换与导航 ---
    // 修复：重构月份导航逻辑，确保其行为正确
    async function navigateToMonth(month) {
        console.log(`=== NAVIGATE TO MONTH START ===`);
        performance.startTracking(`Navigate to ${month}`);
        
        console.log(`navigateToMonth called with month: ${month}`);
        console.log(`isFetching: ${state.isFetching}`);
        
        if (state.isFetching) {
            console.log('Already fetching, returning early');
            return;
        }
        
        state.isFetching = true;
        console.log('Set isFetching to true');
        showProgress('准备导航...');
        
        try {
            if (state.isSearchMode) {
                console.log('Resetting search mode...');
                resetToDefaultView(false); // 仅重置UI，不重载数据以保留缓存
            }
            
            console.log(`Available months: ${JSON.stringify(state.manifest.availableMonths)}`);
            const targetIndex = state.manifest.availableMonths.indexOf(month);
            console.log(`Target index for ${month}: ${targetIndex}`);
            
            if (targetIndex === -1) {
                console.error(`无效的月份: ${month}`);
                showToast(`无效的月份: ${month}`);
                return;
            }
            
            // 对大数据文件显示警告
            if (month === '2025-06' || month === '2025-05') {
                showToast(`${month} 包含大量数据，加载可能需要较长时间...`);
            }
            
            console.log('Starting fetchWithProgress...');
            await fetchWithProgress([month]);
            console.log('fetchWithProgress completed');
            
            console.log('Starting UI updates...');
            updateProgress('渲染论文...', 95);
            papersContainer.innerHTML = ''; // 彻底清空容器
            console.log('Papers container cleared');
            
            if (state.navObserver) {
                state.navObserver.disconnect();
                console.log('navObserver disconnected');
            } else {
                console.log('navObserver is null, skipping disconnect');
            }
            state.activeDateFilters.clear();
            console.log('Date filters cleared');
            
            // 渲染目标月份
            console.log('Filtering papers for month...');
            const papersInMonth = Array.from(state.allPapers.values()).filter(p => p.id.startsWith(month.replace('-', '').substring(2)));
            console.log(`Found ${papersInMonth.length} papers for month ${month}`);
            
            console.log('Calling renderPapers...');
            renderPapers(papersInMonth.sort((a,b)=>b.date.localeCompare(a.date)), month);
            console.log('renderPapers completed');
            
            // 正确设置当前月份索引，为无限滚动做准备
            state.currentMonthIndex = targetIndex;
            console.log(`Set currentMonthIndex to ${targetIndex}`);
            
            window.scrollTo({ top: 0, behavior: 'auto' });
            console.log('Scrolled to top');
            console.log('Navigation completed successfully');
            
            performance.endTracking(`Navigate to ${month}`);

        } catch (error) {
            console.error('Navigation error:', error);
            console.error('Error stack:', error.stack);
            showToast('导航失败，请重试');
        } finally {
            console.log('=== FINALLY BLOCK START ===');
            state.isFetching = false;
            console.log('Set isFetching to false');
            hideProgress();
            console.log('Hidden progress indicator');
            console.log('=== NAVIGATE TO MONTH END ===');
        }
    }

    // 修复：确保loadNextMonth仅追加内容
    async function loadNextMonth(triggeredByScroll = true) {
        if (state.isFetching || state.isSearchMode) return;
        loader.classList.remove('hidden');
        state.isFetching = true;
        try {
            const nextIndex = state.currentMonthIndex + 1;
            if (state.manifest && state.manifest.availableMonths && nextIndex < state.manifest.availableMonths.length) {
                const nextMonth = state.manifest.availableMonths[nextIndex];
                await fetchMonth(nextMonth);
                const papersInMonth = Array.from(state.allPapers.values()).filter(p => p.id.startsWith(nextMonth.replace('-', '').substring(2)));
                // 关键修复：renderPapers现在只接收新月份的数据，并将其追加到容器中
                renderPapers(papersInMonth.sort((a,b)=>b.date.localeCompare(a.date)), nextMonth);
                state.currentMonthIndex = nextIndex;
            } else {
                if (endOfListMessage && triggeredByScroll) endOfListMessage.classList.remove('hidden');
            }
        } finally {
            state.isFetching = false;
            loader.classList.add('hidden');
        }
    }
    
    async function handleSearch() {
        if (state.isFetching) return;
        state.isFetching = true;
        
        try {
            const query = searchInput.value.trim();
            
            if (query !== state.currentQuery) {
                showProgress(`正在搜索 "${query}"...`);
            }
            
            await applyViewTransition(async () => {
                state.currentQuery = query;
                const url = new URL(window.location);
                url.searchParams.delete('paper');
                query ? url.searchParams.set('q', query) : url.searchParams.delete('q');
                history.pushState({}, '', url);

                if (!query) { resetToDefaultView(); return; }
                
                state.isSearchMode = true;
                state.activeCategoryFilter = 'all';
                papersContainer.classList.add('hidden');
                searchResultsContainer.classList.remove('hidden');
                quickNavContainer.style.display = 'none';
                categoryFilterContainer.classList.remove('hidden');
                searchInfoEl.classList.remove('hidden');
                searchResultsContainer.innerHTML = '';

                let results = [];
                let requiredMonths = new Set();

                if (query === 'favorites') {
                    const favoriteIds = Array.from(state.favorites);
                    if (favoriteIds.length > 0) {
                        requiredMonths = new Set(favoriteIds.map(id => `20${id.substring(0, 2)}-${id.substring(2, 4)}`));
                    }
                } else {
                    try {
                        if (!state.categoryIndex) {
                            updateProgress('加载分类索引...', 10);
                            state.categoryIndex = await (await fetch('./data/category_index.json')).json();
                        }
                        if (!state.searchIndex) {
                            updateProgress('加载搜索索引...', 20);
                            state.searchIndex = await (await fetch('./data/search_index.json')).json();
                        }
                    } catch(error) { searchResultsContainer.innerHTML = `<p class="text-center text-red-500">索引文件加载失败: ${error.message}。</p>`; return; }

                    let matchingIds;
                    if (state.categoryIndex[query]) { matchingIds = new Set(state.categoryIndex[query]); } 
                    else { matchingIds = new Set(); const queryTokens = query.toLowerCase().split(/\s+/).filter(Boolean); queryTokens.forEach((token, index) => { const foundIds = new Set(); for (const key in state.searchIndex) { if (key.includes(token)) state.searchIndex[key].forEach(id => foundIds.add(id)); } if (index === 0) {matchingIds = foundIds;} else { matchingIds = new Set([...matchingIds].filter(id => foundIds.has(id)));} }); }
                    
                    requiredMonths = new Set([...matchingIds].map(id => `20${id.substring(0, 2)}-${id.substring(2, 4)}`));
                }
                
                const monthsToLoad = [...requiredMonths].filter(m => !state.loadedMonths.has(m));
                await fetchWithProgress(monthsToLoad);

                updateProgress('整理结果...', 95);
                
                if (query === 'favorites') {
                     results = Array.from(state.favorites).map(id => state.allPapers.get(id)).filter(Boolean).sort((a,b) => b.date.localeCompare(a.date));
                } else {
                    let finalMatchingIds;
                    if (state.categoryIndex[query]) { finalMatchingIds = new Set(state.categoryIndex[query]); }
                    else {
                        finalMatchingIds = new Set();
                        const queryTokens = query.toLowerCase().split(/\s+/).filter(Boolean);
                        queryTokens.forEach((token, index) => {
                            const foundIds = new Set();
                            for (const key in state.searchIndex) {
                                if (key.includes(token)) {
                                    state.searchIndex[key].forEach(id => foundIds.add(id));
                                }
                            }
                            if (index === 0) {
                                finalMatchingIds = foundIds;
                            } else {
                                finalMatchingIds = new Set([...finalMatchingIds].filter(id => foundIds.has(id)));
                            }
                        });
                    }
                    results = Array.from(finalMatchingIds).map(id => state.allPapers.get(id)).filter(Boolean).sort((a,b) => b.date.localeCompare(a.date));
                }
                
                state.currentSearchResults = results;
                renderFilteredResults();
            });
        } finally {
            state.isFetching = false;
            hideProgress();
        }
    }
    
    function renderFilteredResults() {
        const { currentSearchResults, activeCategoryFilter, currentQuery } = state;
        
        const filtered = activeCategoryFilter === 'all'
            ? currentSearchResults
            : currentSearchResults.filter(paper => paper.categories && paper.categories.includes(activeCategoryFilter));

        searchResultsContainer.innerHTML = '';
        
        let infoText;
        if (currentQuery === 'favorites') {
            infoText = `正在显示您的 <strong>${currentSearchResults.length}</strong> 篇收藏`;
        } else {
            infoText = `为您找到 <strong>${currentSearchResults.length}</strong> 篇关于 "<strong>${currentQuery}</strong>" 的论文`;
        }
        
        if (activeCategoryFilter !== 'all') {
            infoText += `，其中 <strong>${filtered.length}</strong> 篇属于 <strong>${activeCategoryFilter}</strong> 分类：`;
        } else {
            infoText += '：';
        }

        searchInfoEl.innerHTML = infoText;

        if (filtered.length > 0) {
            renderInChunks(filtered, searchResultsContainer);
        } else {
            searchResultsContainer.innerHTML = `<p class="text-center text-gray-500">在此分类下未找到相关论文。</p>`;
        }
        
        document.querySelectorAll('.category-filter-btn').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.category === activeCategoryFilter);
        });
    }
    
    function resetToDefaultView(reload = true) {
        state.isSearchMode = false;
        searchInput.value = ''; 
        state.currentQuery = '';
        
        const url = new URL(window.location);
        url.searchParams.delete('q');
        url.searchParams.delete('paper');
        history.pushState({}, '', url);

        searchResultsContainer.classList.add('hidden');
        papersContainer.classList.remove('hidden');
        quickNavContainer.style.display = 'block';
        searchInfoEl.classList.add('hidden');
        categoryFilterContainer.classList.add('hidden');
        state.currentSearchResults = [];
        state.activeCategoryFilter = 'all';

        if (reload) {
            papersContainer.innerHTML = '';
            state.currentMonthIndex = -1;
            loadNextMonth(false);
        }
        updateSearchStickiness();
    }

    function performTagSearch(tag) {
        window.scrollTo({ top: 0, behavior: 'auto' });
        searchInput.value = tag;
        handleSearch();
    };

    function setupIntersectionObserver() {
        const options = { root: null, rootMargin: '0px', threshold: 0.1 };
        const observer = new IntersectionObserver((entries, observer) => { entries.forEach(entry => { if (entry.isIntersecting && !state.isFetching && !state.isSearchMode) { loadNextMonth(); } }); }, options);
        if (loader) observer.observe(loader);
    }

    // --- 新增和优化的事件处理 ---
    
    async function handleDirectLink(paperId) {
        if (state.isFetching) return;
        state.isFetching = true;
        showProgress('正在定位论文...');
        try {
            if (!/^\d{4}\.\d{4,5}$/.test(paperId)) {
                showToast(`无效的论文ID格式: ${paperId}`);
                console.error(`无效的论文ID格式: ${paperId}`);
                const url = new URL(window.location);
                url.searchParams.delete('paper');
                history.replaceState({}, '', url);
                await loadNextMonth(false);
                return;
            }

            const month = `20${paperId.substring(0, 2)}-${paperId.substring(2, 4)}`;
            await navigateToMonth(month);
            
            if (!state.allPapers.has(paperId)) {
                console.error(`论文 ID ${paperId} 在数据中未找到。`);
                showToast(`找不到指定的论文 (ID: ${paperId})`);
                const url = new URL(window.location);
                url.searchParams.delete('paper');
                history.replaceState({}, '', url);
                return;
            }

            const checkCardExists = (resolve) => {
                const card = document.getElementById(`card-${paperId}`);
                if (card) { resolve(card); } 
                else { requestAnimationFrame(() => checkCardExists(resolve)); }
            };

            const card = await new Promise(checkCardExists);
            
            card.scrollIntoView({ behavior: 'smooth', block: 'center' });
            card.classList.add('highlight-shared-paper');
            setTimeout(() => card.classList.remove('highlight-shared-paper'), 3000);
        } finally {
            state.isFetching = false;
            hideProgress();
        }
    }
    
    function showToast(message, type = 'success', duration = 3000) {
        toastNotificationEl.textContent = message;
        toastNotificationEl.className = `toast ${type}`;
        toastNotificationEl.classList.add('show');
        setTimeout(() => {
            toastNotificationEl.classList.remove('show');
        }, duration);
    }

    async function sharePaper(paperId) {
        const url = new URL(window.location.origin + window.location.pathname);
        url.searchParams.set('paper', paperId);
        try {
            await navigator.clipboard.writeText(url.href);
            showToast('链接已复制到剪贴板！');
        } catch (err) {
            console.error('无法复制链接: ', err);
            showToast('复制失败。');
        }
    }

    function setupGlobalEventListeners() {
        // 主容器事件代理
        mainContainer.addEventListener('click', (event) => {
            const target = event.target.closest('[data-action]');
            if (!target || state.isFetching) return;
            const { action, paperId, tagValue, month, day, tag, rating } = target.dataset;

            switch (action) {
                case 'toggle-ai-details': toggleAIDetails(paperId); break;
                case 'search-tag': performTagSearch(tagValue); break;
                case 'toggle-favorite': toggleFavorite(event, paperId, target); break;
                case 'share-paper': sharePaper(paperId); break;
                case 'toggle-notes': togglePaperNotes(paperId); break;
                case 'save-note': 
                    const textarea = document.querySelector(`#paper-notes-${paperId} textarea`);
                    if (textarea) savePaperNote(paperId, textarea.value);
                    showToast('笔记已保存');
                    break;
                case 'remove-tag': removePaperTag(paperId, tag); break;
                case 'rate-paper': setPaperRating(paperId, parseInt(rating)); break;
                case 'filter-by-date':
                    state.activeDateFilters.set(month, day);
                    const papersForMonth = Array.from(state.allPapers.values())
                        .filter(p => p.id.startsWith(month.replace('-', '').substring(2)))
                        .sort((a,b)=>b.date.localeCompare(a.date));
                    updateMonthView(month, papersForMonth);
                    break;
            }
        });
        
        // 快速导航容器事件
        quickNavContainer.addEventListener('click', async (event) => {
             const target = event.target.closest('[data-action]');
             if (!target || state.isFetching) return;
             const { action, month, mode, tagValue } = target.dataset;

             switch (action) {
                case 'navigate-month': await navigateToMonth(month); break;
                case 'toggle-view': toggleViewMode(mode); break;
                case 'search-tag': performTagSearch(tagValue); break;
             }
        });
        
        // 分类筛选容器事件
        categoryFilterContainer.addEventListener('click', (event) => {
            const target = event.target.closest('[data-action="filter-category"]');
            if (!target || state.isFetching) return;
            state.activeCategoryFilter = target.dataset.category;
            renderFilteredResults();
        });

        // 主题切换
        themeToggle.addEventListener('click', toggleTheme);
        
        // 搜索历史控制
        searchHistoryToggle.addEventListener('click', () => {
            state.searchHistoryVisible = !state.searchHistoryVisible;
            searchHistoryPanel.classList.toggle('hidden', !state.searchHistoryVisible);
            searchHistoryToggle.textContent = state.searchHistoryVisible ? '隐藏历史' : '搜索历史';
        });
        
        // 清除搜索历史
        document.getElementById('clear-history')?.addEventListener('click', clearSearchHistory);
        
        // 搜索历史项点击
        searchHistoryItems.addEventListener('click', (event) => {
            const query = event.target.dataset.query;
            if (query) {
                searchInput.value = query;
                handleSearch();
                searchHistoryPanel.classList.add('hidden');
                state.searchHistoryVisible = false;
                searchHistoryToggle.textContent = '搜索历史';
            }
        });
        
        // 搜索建议交互
        searchSuggestions.addEventListener('click', (event) => {
            const suggestion = event.target.closest('.suggestion-item')?.dataset.suggestion;
            if (suggestion) selectSuggestion(suggestion);
        });

        // 搜索输入框事件
        let searchTimeout;
        searchInput.addEventListener('input', (event) => {
            clearTimeout(searchTimeout);
            const query = event.target.value;
            showSearchSuggestions(query);
            searchTimeout = setTimeout(() => {
                if (!state.isFetching) handleSearch();
            }, 300);
        });
        
        // 键盘导航支持
        searchInput.addEventListener('keydown', (event) => {
            if (searchSuggestions.classList.contains('visible')) {
                const items = searchSuggestions.querySelectorAll('.suggestion-item');
                switch (event.key) {
                    case 'ArrowDown':
                        event.preventDefault();
                        state.currentSuggestionIndex = Math.min(state.currentSuggestionIndex + 1, items.length - 1);
                        updateSuggestionHighlight();
                        break;
                    case 'ArrowUp':
                        event.preventDefault();
                        state.currentSuggestionIndex = Math.max(state.currentSuggestionIndex - 1, -1);
                        updateSuggestionHighlight();
                        break;
                    case 'Enter':
                        if (state.currentSuggestionIndex >= 0) {
                            event.preventDefault();
                            const suggestion = items[state.currentSuggestionIndex]?.dataset.suggestion;
                            if (suggestion) selectSuggestion(suggestion);
                        }
                        break;
                    case 'Escape':
                        hideSearchSuggestions();
                        break;
                }
            }
        });
        
        // 点击外部隐藏搜索建议
        document.addEventListener('click', (event) => {
            if (!searchBarContainer.contains(event.target)) {
                hideSearchSuggestions();
            }
        });
        
        // 滚动事件：阅读进度和返回顶部
        window.addEventListener('scroll', () => {
            updateReadingProgress();
            if (window.scrollY > 300) { 
                backToTopBtn.classList.add('visible'); 
            } else { 
                backToTopBtn.classList.remove('visible'); 
            }
        });
        
        // 返回顶部按钮
        backToTopBtn.addEventListener('click', () => { 
            window.scrollTo({ top: 0, behavior: 'smooth' }); 
        });
        
        // 键盘访问性支持
        document.addEventListener('keydown', handleGlobalKeyNavigation);
        
        // 移动端底部导航事件
        if (mobileBottomNav) {
            mobileBottomNav.addEventListener('click', (event) => {
                const target = event.target.closest('[data-action]');
                if (target) {
                    handleMobileBottomNavClick(event);
                }
            });
        }
        
        // 移动端触摸优化
        if (state.mobile.isTouchDevice) {
            // 为所有可点击元素添加触摸反馈
            setTimeout(() => {
                const clickableElements = document.querySelectorAll('button:not(.no-ripple), .keyword-tag, .month-btn');
                clickableElements.forEach(addRippleEffect);
                optimizeMobileTouchTargets();
            }, 1000);
            
            // 防止双击缩放（但保留捏合缩放）
            document.addEventListener('touchstart', (e) => {
                if (e.touches.length > 1) {
                    e.preventDefault();
                }
            }, { passive: false });
            
            let lastTouchEnd = 0;
            document.addEventListener('touchend', (e) => {
                const now = (new Date()).getTime();
                if (now - lastTouchEnd <= 300) {
                    e.preventDefault();
                }
                lastTouchEnd = now;
            }, false);
        }
    }
    
    function updateSuggestionHighlight() {
        const items = searchSuggestions.querySelectorAll('.suggestion-item');
        items.forEach((item, index) => {
            item.classList.toggle('highlighted', index === state.currentSuggestionIndex);
        });
    }
    
    function handleGlobalKeyNavigation(event) {
        // ESC键重置焦点
        if (event.key === 'Escape') {
            document.activeElement?.blur();
            hideSearchSuggestions();
        }
        
        // Ctrl/Cmd + K 快速聚焦搜索框
        if ((event.ctrlKey || event.metaKey) && event.key === 'k') {
            event.preventDefault();
            searchInput.focus();
        }
        
        // Ctrl/Cmd + D 切换深色模式
        if ((event.ctrlKey || event.metaKey) && event.key === 'd') {
            event.preventDefault();
            toggleTheme();
        }
    }

    window.addEventListener('popstate', () => { 
        const urlParams = new URLSearchParams(window.location.search);
        const query = urlParams.get('q') || '';
        if (searchInput.value !== query) {
            searchInput.value = query;
            handleSearch();
        }
    });

    window.addEventListener('resize', updateSearchStickiness);
    
    // 监听系统主题变化
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
        if (!localStorage.getItem('arxiv_theme')) {
            setTheme(e.matches ? 'dark' : 'light');
        }
    });
    
    // --- 用户引导和教程系统 ---
    
    // 检测首次访问
    function detectFirstVisit() {
        const hasVisited = localStorage.getItem('arxiv_has_visited');
        if (!hasVisited) {
            state.tutorial.isFirstVisit = true;
            localStorage.setItem('arxiv_has_visited', 'true');
            showFirstVisitWelcome();
        }
        
        // 检查是否已看过教程
        const hasSeenTutorial = localStorage.getItem('arxiv_tutorial_completed');
        state.userPreferences.hasSeenTutorial = hasSeenTutorial === 'true';
        
        // 加载用户偏好
        loadUserPreferences();
    }
    
    // 显示首次访问欢迎信息
    function showFirstVisitWelcome() {
        // 显示欢迎指示器
        setTimeout(() => {
            firstVisitIndicator.classList.add('show');
            setTimeout(() => {
                firstVisitIndicator.classList.remove('show');
            }, 5000);
        }, 1000);
        
        // 显示欢迎卡片和快速功能面板
        setTimeout(() => {
            showWelcomeContent();
        }, 500);
    }
    
    // 显示欢迎内容
    function showWelcomeContent() {
        if (!state.userPreferences.hasSeenTutorial) {
            welcomeCard.classList.remove('hidden');
            quickActions.classList.remove('hidden');
            popularKeywords.classList.remove('hidden');
        }
    }
    
    // 隐藏欢迎内容
    function hideWelcomeContent() {
        welcomeCard.classList.add('hidden');
        quickActions.classList.add('hidden');
        popularKeywords.classList.add('hidden');
    }
    
    // 开始教程
    function startTutorial() {
        state.tutorial.isActive = true;
        state.tutorial.currentStep = 0;
        hideWelcomeContent();
        showTutorialStep(0);
        tutorialOverlay.classList.add('active');
        tutorialProgress.classList.add('active');
        
        // 暂停其他交互
        document.body.style.overflow = 'hidden';
    }
    
    // 显示教程步骤
    function showTutorialStep(stepIndex) {
        const step = state.tutorial.steps[stepIndex];
        if (!step) return;
        
        // 更新进度
        updateTutorialProgress();
        
        // 更新内容
        updateTutorialContent(step);
        
        // 高亮目标元素
        highlightElement(step.target);
        
        // 定位教程卡片
        positionTutorialCard(step);
        
        // 更新按钮状态
        updateTutorialButtons();
        
        // 激活卡片
        setTimeout(() => {
            tutorialCard.classList.add('active');
        }, 300);
    }
    
    // 更新教程进度
    function updateTutorialProgress() {
        const progress = ((state.tutorial.currentStep + 1) / state.tutorial.totalSteps) * 100;
        tutorialProgressText.textContent = `步骤 ${state.tutorial.currentStep + 1} / ${state.tutorial.totalSteps}`;
        tutorialProgressFill.style.width = `${progress}%`;
    }
    
    // 更新教程内容
    function updateTutorialContent(step) {
        tutorialTitle.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            ${step.title}
        `;
        tutorialContent.textContent = step.content;
        
        // 隐藏功能列表（只在第一步显示）
        if (state.tutorial.currentStep === 0) {
            tutorialFeatures.style.display = 'block';
        } else {
            tutorialFeatures.style.display = 'none';
        }
    }
    
    // 高亮目标元素
    function highlightElement(selector) {
        const element = document.querySelector(selector);
        if (!element) return;
        
        const rect = element.getBoundingClientRect();
        const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
        const scrollLeft = window.pageXOffset || document.documentElement.scrollLeft;
        
        // 设置高亮位置
        tutorialHighlight.style.top = `${rect.top + scrollTop - 10}px`;
        tutorialHighlight.style.left = `${rect.left + scrollLeft - 10}px`;
        tutorialHighlight.style.width = `${rect.width + 20}px`;
        tutorialHighlight.style.height = `${rect.height + 20}px`;
        
        // 滚动到元素位置
        element.scrollIntoView({ 
            behavior: 'smooth', 
            block: 'center',
            inline: 'center'
        });
    }
    
    // 定位教程卡片
    function positionTutorialCard(step) {
        const element = document.querySelector(step.target);
        if (!element) return;
        
        const rect = element.getBoundingClientRect();
        const cardWidth = 400;
        const cardHeight = 300;
        const margin = 20;
        
        let top, left;
        
        if (step.position === 'bottom') {
            top = rect.bottom + margin;
            left = Math.max(margin, Math.min(window.innerWidth - cardWidth - margin, rect.left));
        } else if (step.position === 'top') {
            top = Math.max(margin, rect.top - cardHeight - margin);
            left = Math.max(margin, Math.min(window.innerWidth - cardWidth - margin, rect.left));
        } else {
            // 默认居中
            top = window.innerHeight / 2 - cardHeight / 2;
            left = window.innerWidth / 2 - cardWidth / 2;
        }
        
        // 确保卡片在视窗内
        top = Math.max(margin, Math.min(window.innerHeight - cardHeight - margin, top));
        left = Math.max(margin, Math.min(window.innerWidth - cardWidth - margin, left));
        
        tutorialCard.style.top = `${top}px`;
        tutorialCard.style.left = `${left}px`;
    }
    
    // 更新教程按钮
    function updateTutorialButtons() {
        // 上一步按钮
        if (state.tutorial.currentStep === 0) {
            tutorialPrevBtn.style.display = 'none';
        } else {
            tutorialPrevBtn.style.display = 'inline-block';
        }
        
        // 下一步/完成按钮
        if (state.tutorial.currentStep === state.tutorial.totalSteps - 1) {
            tutorialNextBtn.textContent = '完成教程';
        } else {
            tutorialNextBtn.textContent = '下一步';
        }
    }
    
    // 下一步教程
    function nextTutorialStep() {
        tutorialCard.classList.remove('active');
        
        setTimeout(() => {
            if (state.tutorial.currentStep < state.tutorial.totalSteps - 1) {
                state.tutorial.currentStep++;
                showTutorialStep(state.tutorial.currentStep);
            } else {
                completeTutorial();
            }
        }, 200);
    }
    
    // 上一步教程
    function prevTutorialStep() {
        if (state.tutorial.currentStep > 0) {
            tutorialCard.classList.remove('active');
            
            setTimeout(() => {
                state.tutorial.currentStep--;
                showTutorialStep(state.tutorial.currentStep);
            }, 200);
        }
    }
    
    // 跳过教程
    function skipTutorial() {
        if (confirm('确定要跳过新手教程吗？您可以随时点击右上角的"新手教程"按钮重新开始。')) {
            completeTutorial(false);
        }
    }
    
    // 完成教程
    function completeTutorial(showCompleteMessage = true) {
        state.tutorial.isActive = false;
        tutorialOverlay.classList.remove('active');
        tutorialProgress.classList.remove('active');
        tutorialCard.classList.remove('active');
        
        // 恢复页面交互
        document.body.style.overflow = '';
        
        // 保存完成状态
        localStorage.setItem('arxiv_tutorial_completed', 'true');
        state.userPreferences.hasSeenTutorial = true;
        
        if (showCompleteMessage) {
            showToast('🎉 教程完成！现在您可以开始探索论文了', 'success');
        }
        
        // 如果是首次访问，显示一些提示
        if (state.tutorial.isFirstVisit) {
            setTimeout(() => {
                showFeatureTooltip('#searchInput', '💡 提示：试试输入"transformer"或"diffusion"开始搜索');
            }, 2000);
        }
    }
    
    // 重置教程状态
    function resetTutorial() {
        localStorage.removeItem('arxiv_tutorial_completed');
        state.userPreferences.hasSeenTutorial = false;
        showToast('教程状态已重置，刷新页面后将重新显示引导');
    }
    
    // --- 功能提示系统 ---
    
    // 显示功能提示
    function showFeatureTooltip(targetSelector, message, duration = 3000, position = 'top') {
        const target = document.querySelector(targetSelector);
        if (!target || !state.userPreferences.showTooltips) return;
        
        const rect = target.getBoundingClientRect();
        const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
        const scrollLeft = window.pageXOffset || document.documentElement.scrollLeft;
        
        featureTooltip.textContent = message;
        featureTooltip.className = `feature-tooltip ${position === 'bottom' ? 'tooltip-bottom' : ''}`;
        
        let top, left;
        if (position === 'bottom') {
            top = rect.bottom + scrollTop + 10;
        } else {
            top = rect.top + scrollTop - featureTooltip.offsetHeight - 10;
        }
        
        left = rect.left + scrollLeft + (rect.width / 2) - (featureTooltip.offsetWidth / 2);
        
        // 确保在视窗内
        left = Math.max(10, Math.min(window.innerWidth - featureTooltip.offsetWidth - 10, left));
        
        featureTooltip.style.top = `${top}px`;
        featureTooltip.style.left = `${left}px`;
        featureTooltip.classList.add('show');
        
        setTimeout(() => {
            featureTooltip.classList.remove('show');
        }, duration);
    }
    
    // --- 用户偏好管理 ---
    
    // 加载用户偏好
    function loadUserPreferences() {
        const saved = localStorage.getItem('arxiv_user_preferences');
        if (saved) {
            try {
                const preferences = JSON.parse(saved);
                Object.assign(state.userPreferences, preferences);
            } catch (e) {
                console.warn('无法加载用户偏好设置:', e);
            }
        }
    }
    
    // 保存用户偏好
    function saveUserPreferences() {
        localStorage.setItem('arxiv_user_preferences', JSON.stringify(state.userPreferences));
    }
    
    // --- 智能推荐和个性化 ---
    
    // 基于用户行为的推荐
    function generatePersonalizedRecommendations() {
        // 分析用户搜索历史
        const searchTerms = state.searchHistory.slice(-10);
        const favoriteCategories = Array.from(state.favorites).map(id => {
            const paper = state.allPapers.get(id);
            return paper ? paper.primary_category : null;
        }).filter(Boolean);
        
        // 生成推荐关键词
        const recommendations = [];
        
        // 基于搜索历史
        searchTerms.forEach(term => {
            if (term.length > 3) {
                recommendations.push({
                    keyword: term,
                    reason: '基于搜索历史',
                    score: 0.8
                });
            }
        });
        
        // 基于收藏的论文类别
        favoriteCategories.forEach(category => {
            const categoryKeywords = getCategoryKeywords(category);
            categoryKeywords.forEach(keyword => {
                recommendations.push({
                    keyword,
                    reason: '基于收藏偏好',
                    score: 0.9
                });
            });
        });
        
        return recommendations
            .sort((a, b) => b.score - a.score)
            .slice(0, 8)
            .map(r => r.keyword);
    }
    
    // 获取类别相关关键词
    function getCategoryKeywords(category) {
        const keywordMap = {
            'cs.CV': ['computer vision', 'image', 'video', 'detection', 'segmentation'],
            'cs.LG': ['machine learning', 'neural network', 'deep learning', 'optimization'],
            'cs.CL': ['natural language', 'nlp', 'language model', 'text', 'translation'],
            'cs.AI': ['artificial intelligence', 'reasoning', 'knowledge', 'planning'],
            'cs.RO': ['robotics', 'robot', 'control', 'navigation', 'manipulation'],
            'stat.ML': ['statistical learning', 'bayesian', 'inference', 'probability']
        };
        return keywordMap[category] || [];
    }
    
    // 初始化用户引导系统
    function initializeUserGuidance() {
        // 检测首次访问
        detectFirstVisit();
        
        // 绑定教程按钮事件
        if (tutorialBtn) {
            tutorialBtn.addEventListener('click', startTutorial);
        }
        
        if (helpBtn) {
            helpBtn.addEventListener('click', () => {
                showHelpDialog();
            });
        }
        
        // 绑定欢迎卡片按钮
        if (startTutorialBtn) {
            startTutorialBtn.addEventListener('click', startTutorial);
        }
        
        if (exploreNowBtn) {
            exploreNowBtn.addEventListener('click', () => {
                hideWelcomeContent();
                showToast('开始探索吧！💫');
            });
        }
        
        // 绑定教程控制按钮
        if (tutorialNextBtn) {
            tutorialNextBtn.addEventListener('click', nextTutorialStep);
        }
        
        if (tutorialPrevBtn) {
            tutorialPrevBtn.addEventListener('click', prevTutorialStep);
        }
        
        if (tutorialSkipBtn) {
            tutorialSkipBtn.addEventListener('click', skipTutorial);
        }
        
        // 绑定快速功能卡片
        document.querySelectorAll('.quick-action-card').forEach(card => {
            card.addEventListener('click', () => {
                const action = card.dataset.action;
                handleQuickAction(action);
            });
        });
        
        // 绑定热门关键词
        document.querySelectorAll('.popular-keyword').forEach(keyword => {
            keyword.addEventListener('click', () => {
                const term = keyword.dataset.keyword;
                searchInput.value = term;
                addToSearchHistory(term);
                handleSearch();
                hideWelcomeContent();
            });
        });
        
        // 键盘快捷键
        document.addEventListener('keydown', (e) => {
            if (state.tutorial.isActive) {
                if (e.key === 'Escape') {
                    skipTutorial();
                } else if (e.key === 'ArrowRight' || e.key === 'Enter') {
                    nextTutorialStep();
                } else if (e.key === 'ArrowLeft') {
                    prevTutorialStep();
                }
            }
        });
        
        // 监听窗口大小变化，调整教程卡片位置
        window.addEventListener('resize', () => {
            if (state.tutorial.isActive) {
                const currentStep = state.tutorial.steps[state.tutorial.currentStep];
                if (currentStep) {
                    setTimeout(() => {
                        positionTutorialCard(currentStep);
                    }, 100);
                }
            }
        });
        
        // 在移动端优化教程体验
        if (state.mobile.isTouchDevice) {
            // 禁用一些动画以提高性能
            document.documentElement.style.setProperty('--tutorial-animation-duration', '0.2s');
        }
    }
    
    // 处理快速功能操作
    function handleQuickAction(action) {
        hideWelcomeContent();
        
        switch (action) {
            case 'search':
                searchInput.focus();
                showFeatureTooltip('#searchInput', '开始搜索论文吧！支持中英文关键词');
                break;
            case 'categories':
                if (categoryFiltersEl.children.length === 0) {
                    buildCategoryFilters();
                }
                categoryFilterContainer.classList.remove('hidden');
                categoryFilterContainer.scrollIntoView({ behavior: 'smooth' });
                showFeatureTooltip('#category-filters', '选择感兴趣的领域进行筛选');
                break;
            case 'favorites':
                showFavorites();
                break;
            case 'timeline':
                document.getElementById('quick-nav').scrollIntoView({ behavior: 'smooth' });
                showFeatureTooltip('#quick-nav', '点击月份快速跳转到对应时间');
                break;
        }
    }
    
    // 显示帮助对话框
    function showHelpDialog() {
        const helpContent = `
            <div class="space-y-4">
                <h3 class="text-lg font-bold text-gray-900">使用帮助</h3>
                
                <div class="space-y-3">
                    <div>
                        <h4 class="font-semibold text-gray-800">🔍 搜索功能</h4>
                        <p class="text-sm text-gray-600">支持搜索论文标题、作者、摘要内容，支持中英文关键词</p>
                    </div>
                    
                    <div>
                        <h4 class="font-semibold text-gray-800">📁 分类筛选</h4>
                        <p class="text-sm text-gray-600">按计算机视觉、机器学习、自然语言处理等领域筛选</p>
                    </div>
                    
                    <div>
                        <h4 class="font-semibold text-gray-800">⭐ 收藏管理</h4>
                        <p class="text-sm text-gray-600">点击星星图标收藏论文，支持收藏夹管理和导出</p>
                    </div>
                    
                    <div>
                        <h4 class="font-semibold text-gray-800">🤖 AI 增强摘要</h4>
                        <p class="text-sm text-gray-600">每篇论文都有 AI 生成的中文摘要和核心观点解读</p>
                    </div>
                    
                    <div>
                        <h4 class="font-semibold text-gray-800">🎨 个性化</h4>
                        <p class="text-sm text-gray-600">支持深色/浅色主题切换，视图模式选择</p>
                    </div>
                </div>
                
                <div class="pt-3 border-t">
                    <button onclick="startTutorial(); this.closest('.tutorial-card').remove();" 
                            class="w-full bg-blue-500 text-white py-2 px-4 rounded-lg hover:bg-blue-600 transition">
                        开始新手教程
                    </button>
                </div>
            </div>
        `;
        
        // 创建临时帮助卡片
        const helpCard = document.createElement('div');
        helpCard.className = 'tutorial-card active';
        helpCard.style.position = 'fixed';
        helpCard.style.top = '50%';
        helpCard.style.left = '50%';
        helpCard.style.transform = 'translate(-50%, -50%)';
        helpCard.style.zIndex = '1003';
        helpCard.innerHTML = helpContent;
        
        const overlay = document.createElement('div');
        overlay.className = 'tutorial-overlay active';
        overlay.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
        overlay.appendChild(helpCard);
        
        overlay.addEventListener('click', (e) => {
            if (e.target === overlay) {
                overlay.remove();
            }
        });
        
        document.body.appendChild(overlay);
    }
    
    // 开发者测试功能：重置首次访问状态
    function resetFirstVisitState() {
        localStorage.removeItem('arxiv_has_visited');
        localStorage.removeItem('arxiv_tutorial_completed');
        localStorage.removeItem('arxiv_user_preferences');
        showToast('已重置首次访问状态，刷新页面查看效果', 'success', 4000);
    }
    
    // 开发者工具：在控制台暴露一些有用的函数
    if (typeof window !== 'undefined') {
        window.arxivDevTools = {
            resetFirstVisit: resetFirstVisitState,
            startTutorial: startTutorial,
            showTooltip: showFeatureTooltip,
            resetTutorial: resetTutorial,
            state: state
        };
        console.log('🛠️ 开发者工具已加载，使用 window.arxivDevTools 访问');
    }
    
    document.addEventListener('DOMContentLoaded', init);
</script>

</body>
</html>